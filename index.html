<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sony AI Color Lab Web-App</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 6.253v11.494m-5.747-8.662l11.494 5.747m-11.494 0l11.494-5.747M4.75 12A7.25 7.25 0 0112 4.75v0A7.25 7.25 0 0119.25 12v0a7.25 7.25 0 01-7.25 7.25v0A7.25 7.25 0 014.75 12v0z' stroke='%231d1d1f' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' fill='none'%3E%3C/path%E3E%3C/svg%3E">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<style>
html { scroll-behavior: smooth; }
body {
font-family: 'Be Vietnam Pro', sans-serif;
background-color: #f4f7fc;
color: #212529;
overflow-x: hidden;
overflow-y: auto;
}

#bg-blurs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
.blur-circle { position: absolute; border-radius: 50%; filter: blur(180px); opacity: 0.15; transition: all 2s ease-in-out; }
.blur-1 { width: 40vw; height: 40vw; max-width: 500px; max-height: 500px; background: #007AFF; top: 5%; left: 10%; animation: move-blur-1 30s infinite alternate; }
.blur-2 { width: 50vw; height: 50vw; max-width: 600px; max-height: 600px; background: #FF9500; bottom: 5%; right: 10%; animation: move-blur-2 35s infinite alternate; }
@keyframes move-blur-1 { from { transform: translate(0, 0) scale(1) rotate(0deg); } to { transform: translate(10vw, 5vh) scale(1.3) rotate(55deg); } }
@keyframes move-blur-2 { from { transform: translate(0, 0) scale(1) rotate(0deg); } to { transform: translate(-8vw, -5vh) scale(1.2) rotate(-70deg); } }

:root {
--primary-accent: #007AFF;
--primary-accent-darker: #0056B3;
--glass-bg: rgba(255, 255, 255, 0.55);
--glass-border: rgba(0, 0, 0, 0.07);
--text-primary: #1d1d1f;
--text-secondary: #6e6e73;
}

.glass-panel {
background: var(--glass-bg);
backdrop-filter: blur(40px) saturate(180%);
-webkit-backdrop-filter: blur(40px) saturate(180%);
border: 1px solid var(--glass-border);
box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08);
border-radius: 24px;
}
@media (min-width: 768px) {
.glass-panel { border-radius: 28px; }
}

.recipe-item.selected {
background-color: rgba(0, 122, 255, 0.1);
border-left: 4px solid var(--primary-accent);
color: var(--text-primary);
transform: translateX(4px);
box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
}
.recipe-item:hover:not(.selected) { background-color: rgba(0, 0, 0, 0.04); }
.recipe-dot { transition: transform 0.2s ease-in-out; }
.recipe-dot:hover { transform: scale(1.25); }

.btn { border-radius: 9999px; font-weight: 600; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
.btn-primary { background-color: var(--primary-accent); border: none; color: white; box-shadow: 0 4px 14px rgba(0, 118, 255, 0.39); }
.btn-primary:hover:not(:disabled) { background-color: var(--primary-accent-darker); transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 18px rgba(0, 118, 255, 0.45); }
.btn:disabled { background-color: #b0bec5; cursor: not-allowed; opacity: 0.7; box-shadow: none; }

.lang-btn { background: #e9ecef; border: none; border-radius: 9999px; padding: 0.25rem; transition: all 0.2s ease; }
.lang-btn.active { box-shadow: 0 0 0 2.5px var(--primary-accent); }
.lang-btn svg { width: 1.5rem; height: 1.5rem; }

.landing-title { font-size: clamp(2.2rem, 5.5vw, 4.5rem); font-weight: 800; color: var(--text-primary); line-height: 1.1; letter-spacing: -0.025em; }
.quiz-question-title { font-size: clamp(1.7rem, 5vw, 3rem); font-weight: 700; color: var(--text-primary); line-height: 1.15; letter-spacing: -0.02em; }
.landing-subtitle { font-size: clamp(1rem, 2.5vw, 1.25rem); color: var(--text-secondary); margin-top: 1.25rem; max-width: 650px; line-height: 1.6; }

.view-transition { animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
.view-transition-out { animation: fadeOutDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

.quiz-option-card {
background-color: white;
border: 2px solid #e5e7eb;
padding: 1rem;
border-radius: 1.25rem;
cursor: pointer;
transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
text-align: center;
display: flex;
flex-direction: column;
align-items: center;
gap: 0.75rem;
}
.quiz-option-card:hover {
transform: translateY(-4px);
box-shadow: 0 10px 20px rgba(0,0,0,0.07);
}
.quiz-option-card.selected {
border-color: var(--primary-accent);
background-color: rgba(0, 122, 255, 0.1);
color: var(--primary-accent);
box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
}
.quiz-option-card svg {
width: 2.5rem;
height: 2.5rem;
color: #6b7280;
transition: color 0.2s ease;
}
.quiz-option-card.selected svg {
color: var(--primary-accent);
}
.quiz-option-card span {
font-weight: 600;
font-size: 1rem;
}
.bouncing {
animation: bounce-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes bounce-in {
0% { transform: scale(0.95); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

.filter-btn { background-color: rgba(0,0,0,0.05); border: 1px solid transparent; transition: all 0.2s ease-in-out; }
.filter-btn.active { background-color: rgba(0, 122, 255, 0.1); border-color: var(--primary-accent); color: var(--primary-accent); font-weight: 600; }

.spinner { border: 3px solid rgba(0, 0, 0, 0.1); width: 20px; height: 20px; border-radius: 50%; border-left-color: currentColor; animation: spin 1s ease infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.modal { z-index: 50; transition: opacity 0.3s ease; }
.modal-content { transition: transform 0.3s ease; border-radius: 28px; }
.modal.hidden { opacity: 0; pointer-events: none; }
.modal.hidden .modal-content { transform: scale(0.95); }

#comparisonModalContent { background-color: #f0f9ff; border-radius: 0 0 28px 28px; }
.prose-comparison h3 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--text-primary); border-bottom: 2px solid var(--primary-accent); padding-bottom: 0.5rem; }

.quiz-choice-option { cursor: pointer; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; background: rgba(255,255,255,0.7); border-radius: 20px;}
.quiz-choice-option:hover { transform: scale(1.03); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

.overflow-y-auto::-webkit-scrollbar { width: 10px; }
.overflow-y-auto::-webkit-scrollbar-track { background-color: transparent; }
.overflow-y-auto::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
.overflow-y-auto::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }
.overflow-y-auto { scrollbar-width: auto; scrollbar-color: rgba(0, 0, 0, 0.2) transparent; }

.chart-container { position: relative; margin: auto; height: 280px; width: 100%;}
@media (min-width: 768px) { .chart-container { height: 320px; } }
#colorChart, #bwChart { cursor: pointer; }

#mobileNavMenu { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

#lightbox { z-index: 100; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
#lightbox.hidden { opacity: 0; pointer-events: none; }
#lightbox .lightbox-content { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
#lightbox.hidden .lightbox-content { transform: scale(0.95); opacity: 0; }
.lightbox-thumb { cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; }
.lightbox-thumb.active { border-color: var(--primary-accent); transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 122, 255, 0.5); }
.lightbox-nav-btn { background-color: rgba(0,0,0,0.4); transition: background-color 0.2s ease; }
.lightbox-nav-btn:hover { background-color: rgba(0,0,0,0.7); }
#lightbox-main-image { transition: opacity 0.2s ease-in-out; }

#abgm-grid-interactive-container {
width: 100%;
max-width: 300px;
margin: auto;
touch-action: none;
}
#abgm-grid {
position: relative;
width: 100%;
aspect-ratio: 1 / 1;
border-radius: 0.5rem;
cursor: pointer;
background-image:
linear-gradient(to right, rgba(0, 128, 0, 0.2), rgba(255, 255, 255, 0), rgba(255, 0, 255, 0.2)),
linear-gradient(to bottom, rgba(255, 165, 0, 0.2), rgba(255, 255, 255, 0), rgba(0, 0, 255, 0.2));
box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}
#abgm-pointer {
position: absolute;
width: 1rem;
height: 1rem;
background-color: #ef4444;
border: 2px solid white;
border-radius: 9999px;
box-shadow: 0 0 10px rgba(0,0,0,0.5);
transform: translate(-50%, -50%);
pointer-events: none;
}
.pp-infographic-item {
background-color: #ffffff;
border: 1px solid #e5e7eb;
border-radius: 1rem;
padding: 1.5rem;
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
.pp-infographic-item h5 {
color: var(--text-primary);
font-weight: 700;
font-size: 1.125rem;
}
.pp-infographic-item .param-list li {
position: relative;
padding-left: 1.5rem;
}
.pp-infographic-item .param-list li::before {
content: "‚úì";
position: absolute;
left: 0;
color: #16a34a;
font-weight: bold;
}
</style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QKGB56ZKQD"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-QKGB56ZKQD');
</script>
</head>
<body>
<div id="bg-blurs"><div class="blur-circle blur-1"></div><div class="blur-circle blur-2"></div></div>

<div id="appContainer" class="min-h-screen w-screen p-4 md:p-6 flex flex-col">
<header class="flex justify-between items-center w-full z-20 flex-shrink-0">
<button id="homeBtn" class="text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-2">
<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 6.253v11.494m-5.747-8.662l11.494 5.747m-11.494 0l11.494-5.747M4.75 12A7.25 7.25 0 0112 4.75v0A7.25 7.25 0 0119.25 12v0a7.25 7.25 0 01-7.25 7.25v0A7.25 7.25 0 014.75 12v0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
<span data-translate-key="headerTitle" class="hidden sm:inline"></span>
<span class="ml-2 text-[10px] font-bold text-white bg-gradient-to-r from-purple-500 via-blue-500 to-teal-400 px-2.5 py-1 rounded-full uppercase tracking-wider self-center shadow-md">Beta</span>
</button>
<div class="flex items-center gap-2 md:gap-4">
<nav id="mainNav" class="hidden md:flex items-center gap-2">
<div class="relative" id="pp-dropdown-container">
<button id="pp-dropdown-btn" class="font-semibold text-gray-600 hover:text-black transition-colors px-4 py-2 flex items-center gap-1 rounded-full hover:bg-gray-100">
<span data-translate-key="navPictureProfile"></span>
<svg class="w-4 h-4 transition-transform" id="pp-dropdown-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
</button>
<div id="pp-dropdown-menu" class="absolute top-full mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-100 py-2 z-50 hidden origin-top-right transition-all duration-200 ease-out transform opacity-0 scale-95">
<button data-view="recipeFormulas" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navRecipeFormulas"></button>
<button data-view="featuredPhotos" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navFeaturedPhotos"></button>
<button data-view="explain" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navExplain"></button>
</div>
</div>
</nav>
<div class="flex items-center gap-2">
<button id="langEN" class="lang-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30"><clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath><path d="M0,0 v30 h60 v-30 z" fill="#00247d"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#cf142b" stroke-width="4"/><path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/><path d="M30,0 v30 M0,15 h60" stroke="#cf142b" stroke-width="6"/></svg></button>
<button id="langVI" class="lang-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600"><path fill="#da251d" d="M0 0h900v600H0z"/><path fill="#ff0" d="m450 186-86 266 226-164h-280l226 164z"/></svg></button>
</div>
<button id="hamburgerBtn" class="md:hidden p-2 rounded-full hover:bg-black/10 focus:outline-none focus:ring-2 focus:ring-gray-500">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
</button>
</div>
</header>

<div id="mainContent" class="flex-grow min-h-0 relative mt-4 md:mt-6 mb-2"></div>
</div>

<div id="mobileNavMenu" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 transform translate-x-full md:hidden">
<div class="absolute top-0 right-0 h-full w-2/3 max-w-sm bg-white/80 backdrop-blur-xl shadow-2xl p-6">
<button id="closeMobileNavBtn" class="absolute top-4 right-4 text-3xl p-2">&times;</button>
<nav class="mt-16 flex flex-col gap-6 text-center">
<button data-view="recipeFormulas" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navRecipeFormulas"></button>
<button data-view="featuredPhotos" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navFeaturedPhotos"></button>
<button data-view="explain" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navExplain"></button>
</nav>
</div>
</div>

<div id="comparisonModal" class="modal hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div class="modal-content glass-panel w-full max-w-4xl max-h-[90vh] flex flex-col">
<div class="p-4 md:p-6 border-b border-black/10 flex justify-between items-center flex-shrink-0">
<h2 id="comparisonModalTitle" class="text-xl md:text-2xl font-bold"></h2>
<button id="closeComparisonModalBtn" class="text-3xl leading-none p-2 rounded-full hover:bg-black/10">&times;</button>
</div>
<div id="comparisonModalContent" class="p-6 md:p-8 overflow-y-auto prose-comparison"></div>
</div>
</div>

<!-- START: Prompt Confirmation Modal -->
<div id="promptConfirmationModal" class="modal hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="modal-content glass-panel w-full max-w-2xl flex flex-col">
        <div class="p-4 md:p-6 border-b border-black/10 flex justify-between items-center">
            <h2 id="promptModalTitle" class="text-xl md:text-2xl font-bold" data-translate-key="promptModalTitle"></h2>
            <button id="closePromptModalBtn" class="text-3xl leading-none p-2 rounded-full hover:bg-black/10">&times;</button>
        </div>
        <div class="p-6 md:p-8 overflow-y-auto space-y-6">
            <div>
                <h3 class="font-semibold text-gray-500" data-translate-key="promptModalOriginal"></h3>
                <p id="originalPromptText" class="mt-2 p-3 bg-gray-100 rounded-lg text-gray-800 break-words"></p>
            </div>
            <div>
                <h3 class="font-semibold text-blue-600" data-translate-key="promptModalImproved"></h3>
                <p id="improvedPromptText" class="mt-2 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-900 break-words"></p>
            </div>
        </div>
        <div class="p-4 md:p-6 border-t border-black/10 flex justify-end items-center gap-4">
            <button id="cancelPromptBtn" class="btn bg-gray-200 text-gray-800 py-2 px-6" data-translate-key="promptModalCancel"></button>
            <button id="confirmPromptBtn" class="btn btn-primary py-2 px-6" data-translate-key="promptModalConfirm"></button>
        </div>
    </div>
</div>
<!-- END: Prompt Confirmation Modal -->


<div id="lightbox" class="hidden fixed inset-0 flex items-center justify-center p-4 transition-opacity duration-300">
<div id="lightbox-bg" class="absolute inset-0"></div>
<div class="lightbox-content relative w-full max-w-4xl max-h-full">
<button id="lightbox-close" class="absolute -top-4 -right-2 md:top-0 md:-right-12 text-white text-5xl font-bold z-10 leading-none p-2">&times;</button>
<div class="relative">
<img id="lightbox-main-image" src="" alt="·∫¢nh demo c√¥ng th·ª©c" class="w-full h-auto max-h-[75vh] object-contain rounded-lg shadow-2xl bg-black/50">
<button id="lightbox-prev" class="lightbox-nav-btn absolute top-1/2 left-2 md:-left-16 -translate-y-1/2 p-2 md:p-3 rounded-full text-white">
<svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
</button>
<button id="lightbox-next" class="lightbox-nav-btn absolute top-1/2 right-2 md:-right-16 -translate-y-1/2 p-2 md:p-3 rounded-full text-white">
<svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
</button>
</div>
<div id="lightbox-thumbnails" class="flex justify-center items-center gap-2 md:gap-4 mt-4"></div>
</div>
</div>

<script type="module">
// --- IMPORT RECIPES ---
import recipesData from './recipes.js';

// --- APPLICATION STATE & CONFIG ---
const state = {
    currentLang: 'vi',
    currentView: 'home',
    selectedRecipeId: null,
    comparisonList: [],
    lastGeneratedAiRecipe: null,
    isAILoading: false,
    quizAnswers: {},
    activeFilters: { type: 'all', contrast: 'all', saturation: 'all' },
    isMobileDetailActive: false,
    lightbox: { isOpen: false, images: [], currentIndex: 0 },
};

const mainContentEl = document.getElementById('mainContent');
let activeCharts = {};
let promptConfirmationResolver = null;

// --- TRANSLATIONS & QUIZ DATA (RESTORED) ---
const translations = {
    // General
    headerTitle: {vi: "Alpha AI Color Lab", en: "Alpha AI Color Lab"},
    navPictureProfile: {vi: "Picture Profile", en: "Picture Profile"},
    navRecipeFormulas: {vi:"C√¥ng th·ª©c m√†u", en:"Color Recipes"},
    navFeaturedPhotos: {vi: "·∫¢nh n·ªïi b·∫≠t", en: "Featured Photos"},
    navExplain: {vi:"Gi·∫£i th√≠ch (PP)", en:"Guide (PP)"},
    noteTitle: {vi:"L∆∞u √Ω quan tr·ªçng", en:"Important Note"},
    footerText: {vi: "Ph√°t tri·ªÉn b·ªüi Sony Alpha Vietnam.", en: "Developed by Sony Alpha Vietnam."},
    exportRecipeBtn: {vi: "L∆∞u & Xu·∫•t C√¥ng Th·ª©c", en: "Save & Export Recipe"},
    downloadLutBtn: {vi: "T·∫£i file .CUBE (LUT)", en: "Download .CUBE (LUT) File"},
    memoryRecallBtn: {vi: "H∆∞·ªõng d·∫´n l∆∞u v√†o m√°y", en: "Camera Save Guide"},

    // Home / Quiz
    landingTitle: {vi:"T√¨m m√†u s·∫Øc c·ªßa ri√™ng b·∫°n.", en:"Find Your Signature Color."},
    landingSubtitle: {vi:"Tr·∫£ l·ªùi v√†i c√¢u h·ªèi ƒë·ªÉ kh√°m ph√° c√¥ng th·ª©c m√†u ƒë∆∞·ª£c AI t·∫°o ra d√†nh ri√™ng cho t√¢m tr·∫°ng v√† phong c√°ch c·ªßa b·∫°n.", en:"Answer a few questions to discover a unique color recipe, tailored by AI to your mood and style."},
    startQuizBtn: {vi:"Kh√°m ph√° m√†u c·ªßa b·∫°n", en:"Discover Your Color"},
    loadingAnalyze: {vi: "ƒêang ph√¢n t√≠ch l·ª±a ch·ªçn...", en: "Analyzing your choices..."},

    // Recipe Formulas
    searchInputPlaceholder: {vi: "üîç T√¨m c√¥ng th·ª©c...", en: "üîç Search recipes..."},
    filterType: {vi: "Lo·∫°i", en: "Type"},
    filterTypeColor: {vi: "M√†u", en: "Color"},
    filterTypeBW: {vi: "Tr·∫Øng ƒêen", en: "B&W"},
    filterContrast: {vi: "T∆∞∆°ng ph·∫£n", en: "Contrast"},
    filterSaturation: {vi: "B√£o h√≤a", en: "Saturation"},
    filterHigh: {vi: "Cao", en: "High"},
    filterMedium: {vi: "V·ª´a", en: "Med"},
    filterLow: {vi: "Th·∫•p", en: "Low"},
    compareBtn: {vi: "So s√°nh b·∫±ng AI", en: "Compare with AI"},
    recipeDetailWelcomeTitle: {vi: "Th∆∞ vi·ªán m√†u T∆∞∆°ng t√°c", en: "Interactive Color Library"},
    recipeDetailWelcomeText: {vi: "Kh√°m ph√° c√°c c√¥ng th·ª©c m√†u Picture Profile m·ªôt c√°ch tr·ª±c quan. Nh·∫•p v√†o m·ªôt ƒëi·ªÉm tr√™n bi·ªÉu ƒë·ªì ho·∫∑c m·ªôt c√¥ng th·ª©c trong danh s√°ch ƒë·ªÉ xem chi ti·∫øt.", en: "Explore Picture Profile color recipes visually. Click a point on the chart or a recipe in the list to see details."},
    whiteBalanceTitle: {vi: "C√¢n b·∫±ng tr·∫Øng (WB)", en: "White Balance (WB)"},
    recipeSettingsTitle: {vi: "C√†i ƒë·∫∑t Ch√≠nh", en: "Main Settings"},
    colorDepthTitle: {vi: "ƒê·ªô s√¢u m√†u", en: "Color Depth"},
    detailTitle: {vi: "Chi ti·∫øt", en: "Detail"},
    aiTuningTitle: {vi: "Tinh ch·ªânh b·∫±ng AI", en: "AI Fine-Tuning"},
    aiTuningPlaceholder: {vi: "Nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n ·ªü ƒë√¢y... (v√≠ d·ª•: 'l√†m cho m√†u ·∫•m h∆°n v√† trong h∆°n')", en: "Enter your request here... (e.g., 'make it warmer and clearer')"},
    aiTuningBtn: {vi: "T·∫°o b·∫±ng AI", en: "Generate with AI"},
    aiResultTitle: {vi: "C√¥ng th·ª©c ƒë√£ ƒë∆∞·ª£c AI tinh ch·ªânh:", en: "AI-Adjusted Recipe:"},
    compareWithOriginalBtn: {vi: "So s√°nh v·ªõi b·∫£n g·ªëc", en: "Compare with Original"},
    comparisonModalTitle: {vi: "So s√°nh C√¥ng th·ª©c", en: "Recipe Comparison"},
    comparisonLoading: {vi: "AI ƒëang ph√¢n t√≠ch v√† so s√°nh...", en: "AI is analyzing and comparing..."},
    colorChartTitle: {vi: "Bi·ªÉu ƒë·ªì M√†u", en: "Color Chart"},
    bwChartTitle: {vi: "Bi·ªÉu ƒë·ªì ƒê∆°n s·∫Øc (B&W)", en: "Monochrome (B&W) Chart"},
    axisTonality: {vi: "T∆∞∆°ng ph·∫£n (‚Üê M·ªÅm | C·ª©ng ‚Üí)", en: "Tonality (‚Üê Soft | Hard ‚Üí)"},
    axisSaturation: {vi: "ƒê·ªô b√£o h√≤a (‚Üê Th·∫•p | Cao ‚Üí)", en: "Saturation (‚Üê Low | High ‚Üí)"},
    axisChroma: {vi: "ƒê·ªô s√¢u m√†u (‚Üê Th·∫•p | Cao ‚Üí)", en: "Chroma Depth (‚Üê Low | High ‚Üí)"},
    backToListBtn: {vi: "‚Üê Quay l·∫°i danh s√°ch", en: "‚Üê Back to list"},
    aiExplainRecipeBtn: {vi: "‚ú® Gi·∫£i th√≠ch b·∫±ng AI", en: "‚ú® Explain with AI"},
    aiExplanationTitle: {vi: "Gi·∫£i th√≠ch c√¥ng th·ª©c b·∫±ng AI:", en: "AI Recipe Explanation:"},
    aiExplanationLoading: {vi: "AI ƒëang ph√¢n t√≠ch c√¥ng th·ª©c...", en: "AI is analyzing the recipe..."},
    aiError: {vi: "ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.", en: "An error occurred. Please try again."},
    promptModalTitle: {vi: "X√°c nh·∫≠n Y√™u c·∫ßu", en: "Confirm Your Request"},
    promptModalOriginal: {vi: "Y√™u c·∫ßu g·ªëc c·ªßa b·∫°n:", en: "Your Original Request:"},
    promptModalImproved: {vi: "ƒê·ªÅ xu·∫•t t·ªëi ∆∞u t·ª´ AI:", en: "AI-Optimized Suggestion:"},
    promptModalCancel: {vi: "H·ªßy", en: "Cancel"},
    promptModalConfirm: {vi: "X√°c nh·∫≠n & T·∫°o", en: "Confirm & Generate"},
    promptOptimizationFailed: {vi: "Kh√¥ng th·ªÉ t·ªëi ∆∞u ho√° y√™u c·∫ßu c·ªßa b·∫°n l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i.", en: "Could not optimize your request at this time. Please try again."},

    // Featured Photos
    featuredTitle: {vi: "·∫¢nh N·ªïi B·∫≠t t·ª´ C·ªông ƒê·ªìng", en: "Featured Photos from the Community"},
    featuredCta: {vi: "H√£y c√πng l√†m cho th∆∞ vi·ªán m√†u c·ªßa Alpha AI Color Lab v√† group c·ªông ƒë·ªìng Sony Alpha Vietnam th√™m phong ph√∫! Chia s·∫ª ·∫£nh c·ªßa b·∫°n k√®m m√£ m√†u (v√≠ d·ª•: 'SCL-82') ƒë·ªÉ c√πng nhau t·∫°o n√™n m·ªôt kh√¥ng gian ƒë·∫ßy c·∫£m h·ª©ng.", en: "Let's enrich the Alpha AI Color Lab gallery and the Sony Alpha Vietnam community group! Share your photos with the color code (e.g., 'SCL-82') to create an inspiring space together."},
    featuredAlbumBtn: {vi: "Xem Album & ƒê√≥ng g√≥p ·∫¢nh", en: "View Album & Contribute Photos"},

    // Explanation Tab
    explainHeader: {vi: "L√†m Ch·ªß M√†u S·∫Øc C√πng Sony Alpha", en:"Mastering Color with Sony Alpha"},
    explainSubtitle: {vi: "H∆∞·ªõng d·∫´n to√†n di·ªán ƒë·ªÉ t·∫°o ra m√†u s·∫Øc ƒë·∫≠m ch·∫•t ri√™ng cho ·∫£nh tƒ©nh", en:"A comprehensive guide to creating your unique color signature for stills"},
    pillarsTitle: {vi: "Hai Tr·ª• C·ªôt S√°ng T·∫°o M√†u S·∫Øc", en:"The Two Pillars of Color Creation"},
    wbPillarTitle: {vi: "Tr·ª• c·ªôt 1: White Balance - N·ªÅn T·∫£ng C·∫£m X√∫c", en:"Pillar 1: White Balance - The Emotional Foundation"},
    ppPillarTitle: {vi: "Tr·ª• c·ªôt 2: Picture Profile - T·∫°o D√°ng V·∫ª Phim ·∫¢nh", en:"Pillar 2: Picture Profile - Crafting the Film Look"},
    ppInfographicTitle: {vi: "Quy tr√¨nh Tinh ch·ªânh Picture Profile", en:"Picture Profile Adjustment Workflow"},
    recallTitle: { vi: 'L∆∞u Tr·ªØ & T√°i S·ª≠ D·ª•ng: L√†m Ch·ªß Memory Recall', en: 'Save & Reuse: Mastering Memory Recall' },
    tutorialTitle: { vi: "H∆∞·ªõng d·∫´n C√†i ƒë·∫∑t Nhanh", en: "Quick Setup Guide" },
    exposureNoteTitle: { vi: "L∆∞u √Ω v·ªÅ Ph∆°i s√°ng", en: "Note on Exposure" },
    
    // Quiz Questions (Restored)
    quizQ1: {vi: "Ch·ªß ƒë·ªÅ b·∫°n s·∫Øp ch·ª•p l√† g√¨?", en: "What's your subject?"},
    quizQ1A1: {vi: "Ch√¢n dung", en: "Portrait"},
    quizQ1A2: {vi: "Phong c·∫£nh", en: "Landscape"},
    quizQ1A3: {vi: "ƒê∆∞·ªùng ph·ªë / ƒê√¥ th·ªã", en: "Street / Urban"},
    quizQ1A4: {vi: "ƒê·ªùi th∆∞·ªùng", en: "Everyday"},
    quizQ2: {vi: "B·∫°n mu·ªën t√¥ng m√†u ch·ªß ƒë·∫°o n√†o?", en: "What's your desired primary tone?"},
    quizQ2A1: {vi: "·∫§m √°p (V√†ng, Cam)", en: "Warm (Yellow, Orange)"},
    quizQ2A2: {vi: "M√°t m·∫ª (Xanh d∆∞∆°ng)", en: "Cool (Blue)"},
    quizQ2A3: {vi: "Trung t√≠nh", en: "Natural"},
    quizQ2A4: {vi: "Ho√†i c·ªï (Film)", en: "Nostalgic (Film)"},
    quizQ3: {vi: "ƒê·ªô t∆∞∆°ng ph·∫£n b·∫°n th√≠ch?", en: "How about the contrast?"},
    quizQ3A1: {vi: "Cao (G·∫Øt)", en: "High (Punchy)"},
    quizQ3A2: {vi: "Th·∫•p (M·ªÅm m·∫°i)", en: "Low (Soft)"},
    quizQ3A3: {vi: "Trung b√¨nh", en: "Medium"},
    quizQ4: {vi: "B·∫°n th√≠ch ·∫£nh m√†u hay tr·∫Øng ƒëen?", en: "Color or Black & White?"},
    quizQ4A1: {vi: "·∫¢nh m√†u", en: "Color"},
    quizQ4A2: {vi: "·∫¢nh tr·∫Øng ƒëen", en: "Black & White"},
    quizQ5: {vi: "ƒê·ªô b√£o h√≤a m√†u s·∫Øc b·∫°n mu·ªën?", en: "What's your preferred saturation?"},
    quizQ5A1: {vi: "ƒê·∫≠m", en: "High"},
    quizQ5A2: {vi: "Trung b√¨nh", en: "Medium"},
    quizQ5A3: {vi: "Nh·∫°t", en: "Low"},
};

const quizQuestions = [
    { id: 'subject', title: 'quizQ1', options: [ { key: 'quizQ1A1', value: 'portrait', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>` }, { key: 'quizQ1A2', value: 'landscape', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>` }, { key: 'quizQ1A3', value: 'urban', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></svg>` }, { key: 'quizQ1A4', value: 'everyday', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m2 9 3-3 3 3"/><path d="M13 18V2H7"/><path d="m22 15-3 3-3-3"/><path d="m11 6 10 12"/></svg>` } ] },
    { id: 'tone', title: 'quizQ2', options: [ { key: 'quizQ2A1', value: 'warm', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>` }, { key: 'quizQ2A2', value: 'cool', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a7 7 0 0 0-7 7c0 2.4 1.2 4.5 3 5.7L12 22l4-7.3c1.8-1.2 3-3.3 3-5.7a7 7 0 0 0-7-7z"/><path d="M12 9a3 3 0 0 0-3 3c0 1.2.8 2.2 2 2.7l1 1.3l1-1.3c1.2-.5 2-1.5 2-2.7a3 3 0 0 0-3-3z"/></svg>` }, { key: 'quizQ2A3', value: 'natural', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c-2 0-4-1-4-4 0-2 2-3 4-3s4 1 4 3c0 3-2 4-4 4z"/><path d="M12 15V2"/><path d="m5 12-3-3 3-3"/><path d="m19 12 3-3-3-3"/></svg>` }, { key: 'quizQ2A4', value: 'vintage', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h4"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M21 7.5h-4"/><path d="M21 12h-4"/><path d="M21 16.5h-4"/></svg>` } ] },
    { id: 'contrast', title: 'quizQ3', options: [ { key: 'quizQ3A1', value: 'high', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 18a6 6 0 0 0 0-12v12z"/></svg>` }, { key: 'quizQ3A2', value: 'low', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" fill="currentColor" fill-opacity="0.2"/><path d="M12 18a6 6 0 0 0 0-12v12z"/></svg>` }, { key: 'quizQ3A3', value: 'medium', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 18a6 6 0 0 0 0-12v12z" fill="currentColor" fill-opacity="0.5"/></svg>` } ] },
    { id: 'type', title: 'quizQ4', options: [ { key: 'quizQ4A1', value: 'color', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>` }, { key: 'quizQ4A2', value: 'bw', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>` } ] },
    { id: 'saturation', title: 'quizQ5', options: [ { key: 'quizQ5A1', value: 'high', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>` }, { key: 'quizQ5A2', value: 'medium', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/></svg>` }, { key: 'quizQ5A3', value: 'low', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>` } ] }
];

// --- CORE AI FUNCTION (REBUILT FOR STABILITY) ---
async function callAIApi(prompt, generationConfig = null) {
    if (state.isAILoading) {
        console.warn("AI call aborted: another request is already in progress.");
        return null;
    }
    state.isAILoading = true;
    
    const apiKey = "AIzaSyDxctVkghoMzVFNTLbIfHmHQ_szw-omYbQ";
    const model = "gemini-1.5-flash-latest";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

    const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        ...(generationConfig && { generationConfig })
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const responseData = await response.json();

        if (!response.ok) {
            console.error("API Error Response:", responseData);
            throw new Error(`API call failed with status ${response.status}: ${responseData.error?.message || response.statusText}`);
        }

        if (responseData.candidates && responseData.candidates[0]?.content?.parts?.[0]) {
            const text = responseData.candidates[0].content.parts[0].text;
            if (generationConfig?.responseMimeType === "application/json") {
                try {
                    const cleanedText = text.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                    return JSON.parse(cleanedText);
                } catch (e) {
                    console.error("AI Response JSON Parsing Error:", e, "Raw text:", text);
                    return null;
                }
            }
            return text;
        } else {
            console.error("No valid content in AI response:", responseData);
            if (responseData.candidates?.[0]?.finishReason === 'SAFETY') {
                console.error('AI response blocked due to safety settings:', responseData.candidates[0].safetyRatings);
            }
            return null;
        }
    } catch (error) {
        console.error("Full error in callAIApi:", error);
        return null;
    } finally {
        state.isAILoading = false;
        updateUIAfterAILoading();
    }
}

// --- UTILITY & HELPER FUNCTIONS ---
function t(key) { return translations[key]?.[state.currentLang] || key; }

function applyTranslations() {
    document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.dataset.translateKey;
        if (translations[key] && translations[key][state.currentLang]) {
            const translation = t(key);
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translation;
            } else {
                el.innerHTML = translation;
            }
        }
    });
    document.getElementById('langVI').classList.toggle('active', state.currentLang === 'vi');
    document.getElementById('langEN').classList.toggle('active', state.currentLang === 'en');
}

function formatRecipeForPrompt(recipe, lang) {
    const settings = recipe.settings ? Object.entries(recipe.settings).map(([k, v]) => `- ${k}: ${v}`).join('\n') : 'N/A';
    const colorDepth = recipe.colorDepth ? Object.entries(recipe.colorDepth).map(([k, v]) => `- ${k}: ${v}`).join('\n') : 'N/A';
    const detail = recipe.detailSettings ? Object.entries(recipe.detailSettings).map(([k, v]) => `- ${k}: ${v}`).join('\n') : 'N/A';
    return `T√™n: ${recipe.name[lang]}\nM√¥ t·∫£: ${recipe.description[lang]}\nC√¢n b·∫±ng tr·∫Øng: ${recipe.whiteBalance}\nC√†i ƒë·∫∑t ch√≠nh:\n${settings}\nƒê·ªô s√¢u m√†u:\n${colorDepth}\nChi ti·∫øt:\n${detail}`.trim();
}

function updateUIAfterAILoading() {
    document.querySelectorAll('button:disabled').forEach(btn => {
        if (btn.querySelector('.spinner')) {
            btn.innerHTML = btn.dataset.originalText || '';
            btn.disabled = false;
        }
    });
}

// --- MODAL & LIGHTBOX FUNCTIONS ---
function showPromptConfirmationModal(originalPrompt, improvedPrompt) {
    document.getElementById('originalPromptText').textContent = originalPrompt;
    document.getElementById('improvedPromptText').textContent = improvedPrompt;
    document.getElementById('promptConfirmationModal').classList.remove('hidden');
    return new Promise((resolve) => { promptConfirmationResolver = resolve; });
}

function closePromptConfirmationModal() {
    document.getElementById('promptConfirmationModal').classList.add('hidden');
    if (promptConfirmationResolver) {
        promptConfirmationResolver(null);
        promptConfirmationResolver = null;
    }
}

function openLightbox(images, initialIndex = 0) {
    if (!images || images.length === 0) return;
    Object.assign(state.lightbox, { isOpen: true, images, currentIndex: initialIndex });
    document.getElementById('lightbox').classList.remove('hidden');
    updateLightboxContent();
}

function closeLightbox() {
    state.lightbox.isOpen = false;
    document.getElementById('lightbox').classList.add('hidden');
}

function updateLightboxContent() {
    if (!state.lightbox.isOpen) return;
    const { images, currentIndex } = state.lightbox;
    const mainImageEl = document.getElementById('lightbox-main-image');
    const thumbnailsContainer = document.getElementById('lightbox-thumbnails');
    
    mainImageEl.style.opacity = '0';
    setTimeout(() => {
        mainImageEl.src = images[currentIndex];
        mainImageEl.onload = () => { mainImageEl.style.opacity = '1'; };
    }, 150);

    thumbnailsContainer.innerHTML = images.map((imgSrc, index) =>
        `<img src="${imgSrc}" loading="lazy" class="lightbox-thumb w-16 h-16 md:w-20 md:h-20 object-cover rounded-md ${index === currentIndex ? 'active' : ''}" data-index="${index}">`
    ).join('');
}

function navigateLightbox(direction) {
    if (!state.lightbox.isOpen) return;
    const { images } = state.lightbox;
    let newIndex = state.lightbox.currentIndex + direction;
    if (newIndex < 0) newIndex = images.length - 1;
    else if (newIndex >= images.length) newIndex = 0;
    state.lightbox.currentIndex = newIndex;
    updateLightboxContent();
}


// --- AI FEATURE HANDLERS (REBUILT) ---
async function handleAiComparison(id1, id2, recipe2Obj = null) {
    const modal = document.getElementById('comparisonModal');
    const titleEl = document.getElementById('comparisonModalTitle');
    const contentEl = document.getElementById('comparisonModalContent');
    modal.classList.remove('hidden');
    titleEl.textContent = t('comparisonModalTitle');
    contentEl.innerHTML = `<div class="flex items-center justify-center p-8"><div class="spinner !w-12 !h-12 !border-4"></div><p class="ml-4 text-lg font-semibold">${t('comparisonLoading')}</p></div>`;
    
    const recipe1 = recipesData.find(r => r.id === id1);
    const recipe2 = recipe2Obj ? { ...recipe2Obj, id: 'ai-adjusted', name: recipe2Obj.name } : recipesData.find(r => r.id === id2);

    const prompt = `
H√£y l√† m·ªôt chuy√™n gia v·ªÅ m√†u s·∫Øc nhi·∫øp ·∫£nh. So s√°nh hai c√¥ng th·ª©c Sony Picture Profile sau ƒë√¢y.
**Y√™u c·∫ßu:**
1. T·∫°o m·ªôt b·∫£ng Markdown so s√°nh chi ti·∫øt c√°c th√¥ng s·ªë k·ªπ thu·∫≠t ch√≠nh.
2. Sau b·∫£ng, vi·∫øt m·ªôt ƒëo·∫°n ph√¢n t√≠ch chuy√™n s√¢u v·ªÅ "c·∫£m gi√°c" v√† "phong c√°ch" c·ªßa m·ªói c√¥ng th·ª©c.
3. ƒê·ªÅ xu·∫•t c√°c t√¨nh hu·ªëng s·ª≠ d·ª•ng (v√≠ d·ª•: ch√¢n dung, phong c·∫£nh, ƒë∆∞·ªùng ph·ªë) v√† ƒëi·ªÅu ki·ªán √°nh s√°ng l√Ω t∆∞·ªüng cho t·ª´ng c√¥ng th·ª©c.
4. Tr√¨nh b√†y to√†n b·ªô k·∫øt qu·∫£ b·∫±ng ƒë·ªãnh d·∫°ng Markdown.
5. **Quan tr·ªçng:** Vi·∫øt to√†n b·ªô c√¢u tr·∫£ l·ªùi b·∫±ng ng√¥n ng·ªØ sau: ${state.currentLang === 'vi' ? 'Ti·∫øng Vi·ªát' : 'English'}.

**C√¥ng th·ª©c 1:**
${formatRecipeForPrompt(recipe1, state.currentLang)}

**C√¥ng th·ª©c 2:**
${formatRecipeForPrompt(recipe2, state.currentLang)}
`;

    const comparisonText = await callAIApi(prompt);
    contentEl.innerHTML = comparisonText ? marked.parse(comparisonText) : `<p class="text-red-500 text-center">${t('aiError')}</p>`;
}

async function handleAiRecipeExplanation(button) {
    const recipeId = button.dataset.recipeId;
    const explanationContainer = document.getElementById('aiExplanationContainer');
    if (!explanationContainer || state.isAILoading) return;

    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = `<div class="spinner"></div> ${t('aiExplainRecipeBtn')}`;
    explanationContainer.innerHTML = `<div class="flex items-center justify-center p-4"><div class="spinner"></div><p class="ml-2 text-base font-semibold">${t('aiExplanationLoading')}</p></div>`;
    explanationContainer.classList.remove('hidden');

    const recipe = recipesData.find(r => r.id === recipeId);
    const prompt = `
H√£y l√† m·ªôt chuy√™n gia v·ªÅ m√†u s·∫Øc nhi·∫øp ·∫£nh. Ph√¢n t√≠ch c√¥ng th·ª©c Sony Picture Profile sau ƒë√¢y.
**Y√™u c·∫ßu:**
1. Gi·∫£i th√≠ch s√∫c t√≠ch, d·ªÖ hi·ªÉu v·ªÅ ƒë·∫∑c ƒëi·ªÉm v√† √Ω ƒë·ªì ngh·ªá thu·∫≠t c·ªßa c√¥ng th·ª©c n√†y.
2. Ph√¢n t√≠ch c√°ch c√°c th√¥ng s·ªë ch√≠nh (C√¢n b·∫±ng tr·∫Øng, Gamma, M·ª©c ƒë·ªô ƒëen, Ch·∫ø ƒë·ªô m√†u, ƒê·ªô s√¢u m√†u) ph·ªëi h·ª£p v·ªõi nhau ƒë·ªÉ t·∫°o ra phong c√°ch ƒë·ªôc ƒë√°o.
3. G·ª£i √Ω c√°c t√¨nh hu·ªëng ch·ª•p v√† lo·∫°i ch·ªß th·ªÉ l√Ω t∆∞·ªüng (v√≠ d·ª•: ch√¢n dung ngo√†i tr·ªùi, ki·∫øn tr√∫c, th·ªùi trang).
4. Tr√¨nh b√†y to√†n b·ªô k·∫øt qu·∫£ b·∫±ng ƒë·ªãnh d·∫°ng Markdown.
5. **Quan tr·ªçng:** Vi·∫øt to√†n b·ªô c√¢u tr·∫£ l·ªùi b·∫±ng ng√¥n ng·ªØ sau: ${state.currentLang === 'vi' ? 'Ti·∫øng Vi·ªát' : 'English'}.

**C√¥ng th·ª©c c·∫ßn ph√¢n t√≠ch:**
${formatRecipeForPrompt(recipe, state.currentLang)}
`;

    const aiResponse = await callAIApi(prompt);
    if (aiResponse) {
        explanationContainer.innerHTML = `<div class="mt-4 p-4 rounded-xl bg-blue-50"><h4 class="font-bold text-lg mb-2" data-translate-key="aiExplanationTitle"></h4><div class="prose max-w-none text-gray-700">${marked.parse(aiResponse)}</div></div>`;
    } else {
        explanationContainer.innerHTML = `<p class="text-red-500 text-center">${t('aiError')}</p>`;
    }
    button.disabled = false;
    button.innerHTML = button.dataset.originalText;
    applyTranslations();
}

async function handleAiAdjustment(button) {
    const recipeId = button.dataset.recipeId;
    const textarea = document.getElementById('aiTuningTextarea');
    const userInput = textarea.value.trim();
    const resultContainer = document.getElementById('aiResultContainer');

    if (!userInput || state.isAILoading) return;

    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = `<div class="spinner"></div> ${t('aiTuningBtn')}`;
    resultContainer.innerHTML = '';

    // --- Step 1: Improve the user's prompt ---
    const language = state.currentLang === 'vi' ? 'Vietnamese' : 'English';
    const improvePromptSystemInstruction = `As a prompt engineering expert, rewrite the following user request for adjusting a Sony Picture Profile recipe into a more detailed and effective prompt for a downstream AI model. The rewritten prompt should be clear, specific, and maintain the original intent and language (${language}). Return ONLY the rewritten prompt text, with no extra explanation, preamble, or quotation marks.`;
    
    const improvedPromptText = await callAIApi(`${improvePromptSystemInstruction}\n\nOriginal User Request: "${userInput}"`);

    button.disabled = false;
    button.innerHTML = button.dataset.originalText;

    if (!improvedPromptText) {
        resultContainer.innerHTML = `<p class="text-red-500 text-center font-semibold mt-4">${t('promptOptimizationFailed')}</p>`;
        return;
    }
    
    // --- Step 2: Show confirmation modal ---
    const confirmedPrompt = await showPromptConfirmationModal(userInput, improvedPromptText.trim());
    if (!confirmedPrompt) return; // User cancelled
    
    // --- Step 3: Generate the recipe with the confirmed prompt ---
    button.disabled = true;
    button.innerHTML = `<div class="spinner"></div> ${t('aiTuningBtn')}`;
    
    const originalRecipe = recipesData.find(r => r.id === recipeId);
    
    const finalPrompt = `
**Nhi·ªám v·ª•:** Tinh ch·ªânh m·ªôt c√¥ng th·ª©c Sony Picture Profile d·ª±a tr√™n y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng.
**ƒê·ªãnh d·∫°ng ƒë·∫ßu ra:** Ch·ªâ tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON duy nh·∫•t ch·ª©a kh√≥a "recipe". Kh√¥ng gi·∫£i th√≠ch, kh√¥ng th√™m b·∫•t k·ª≥ vƒÉn b·∫£n n√†o kh√°c.
**C√¥ng th·ª©c g·ªëc:**
${formatRecipeForPrompt(originalRecipe, state.currentLang)}
**Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u:** "${confirmedPrompt}"
**H∆∞·ªõng d·∫´n:**
1. ƒê·ªçc k·ªπ y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u.
2. Ch·ªâ thay ƒë·ªïi c√°c gi√° tr·ªã trong \`whiteBalance\`, \`settings\`, \`colorDepth\`, v√† \`detailSettings\` ƒë·ªÉ ƒë√°p ·ª©ng y√™u c·∫ßu.
3. Gi·ªØ nguy√™n c·∫•u tr√∫c c·ªßa c√¥ng th·ª©c g·ªëc.
4. C·∫≠p nh·∫≠t tr∆∞·ªùng \`name\` v√† \`description\` b·∫±ng ${language} ƒë·ªÉ ph·∫£n √°nh s·ª± thay ƒë·ªïi. V√≠ d·ª•: th√™m "(AI Tinh ch·ªânh)" v√†o t√™n.
5. Tr·∫£ v·ªÅ ƒë·ªëi t∆∞·ª£ng JSON h·ª£p l·ªá theo schema ƒë√£ cung c·∫•p.
`;

    const generationConfig = {
        responseMimeType: "application/json",
        responseSchema: {
            type: "OBJECT",
            properties: { "recipe": { type: "OBJECT" } }
        }
    };

    const aiResponse = await callAIApi(finalPrompt, generationConfig);
    
    if (aiResponse && aiResponse.recipe) {
        const adjustedRecipe = { ...JSON.parse(JSON.stringify(originalRecipe)), ...aiResponse.recipe };
        adjustedRecipe.id = `${originalRecipe.id}-ai`;
        state.lastGeneratedAiRecipe = adjustedRecipe;
        resultContainer.innerHTML = `<div class="mt-6 border-t border-gray-200/50 pt-6">
            <h4 class="font-bold text-lg mb-2" data-translate-key="aiResultTitle"></h4>
            <div class="p-4 rounded-xl bg-blue-50">${createFullRecipeHTML(state.lastGeneratedAiRecipe, false)}</div>
            <button id="compareWithOriginalBtn" data-original-id="${recipeId}" class="btn bg-gray-200 text-black w-full mt-4 py-3" data-translate-key="compareWithOriginalBtn"></button>
        </div>`;
    } else {
        resultContainer.innerHTML = `<p class="text-red-500 text-center font-semibold mt-4">${t('promptOptimizationFailed')}</p>`;
    }
    
    button.disabled = false; 
    button.innerHTML = button.dataset.originalText; 
    applyTranslations();
}

// --- UI RENDERING & VIEW MANAGEMENT ---
function createSettingsGrid(settings) {
if (!settings) return '';
return Object.entries(settings).map(([key, value]) => `<div class="flex flex-col"><span class="text-xs text-neutral-500">${key}</span><span class="font-semibold text-lg">${value}</span></div>`).join('');
};

function createFullRecipeHTML(recipe, isMainView = false) {
const titleClass = isMainView ? 'text-xl font-bold' : 'text-lg font-bold';
const noteHTML = (recipe.notes && recipe.notes[state.currentLang])
? `<div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-xl">
                                  <p class="font-bold" data-translate-key="noteTitle"></p>
                                  <p>${recipe.notes[state.currentLang]}</p>
                                </div>` : '';

return `${noteHTML}<div class="space-y-6 mt-6">
              <div><h4 class="${titleClass} mb-2" data-translate-key="whiteBalanceTitle"></h4><div class="p-4 bg-black/5 rounded-xl"><p class="font-semibold text-lg">${recipe.whiteBalance || ''}</p></div></div>
              <div><h4 class="${titleClass} mb-2" data-translate-key="recipeSettingsTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.settings)}</div></div>
              ${recipe.colorDepth ? `<div><h4 class="${titleClass} mb-2" data-translate-key="colorDepthTitle"></h4><div class="grid grid-cols-3 sm:grid-cols-6 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.colorDepth)}</div></div>` : ''}
              ${recipe.detailSettings ? `<div><h4 class="${titleClass} mb-2" data-translate-key="detailTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.detailSettings)}</div></div>` : ''}
        </div>`;
}

const viewTemplates = {
home: () => `<div id="homeView" class="w-full h-full flex flex-col items-center justify-center text-center absolute inset-0 view-transition p-4">
                  <h1 data-translate-key="landingTitle" class="landing-title"></h1>
                  <p data-translate-key="landingSubtitle" class="landing-subtitle"></p>
                  <button id="startQuizBtn" class="btn btn-primary mt-10 py-4 px-10 text-lg" data-translate-key="startQuizBtn"></button>
            </div>`,

quiz: () => {
const quizHTML = quizQuestions.map(q => {
const optionsHTML = q.options.map(opt => `
                                <div class="quiz-option-card" data-value="${opt.value}">
                                    ${opt.icon}
                                    <span data-translate-key="${opt.key}"></span>
                                </div>`).join('');
const gridCols = q.options.length > 3 ? 'grid-cols-2 lg:grid-cols-4' : (q.options.length === 2 ? 'grid-cols-2' : 'grid-cols-1 sm:grid-cols-3');
return `
                                <div class="mb-12" data-quiz-group="${q.id}">
                                    <h2 class="text-2xl font-bold text-center mb-6" data-translate-key="${q.title}"></h2>
                                    <div class="grid ${gridCols} gap-4">${optionsHTML}</div>
                                </div>`;
}).join('');

return `<div id="quizView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition p-6 md:p-12">
                  <div class="max-w-4xl mx-auto">
                      ${quizHTML}
                      <div class="text-center">
                          <button id="submitQuizBtn" class="btn btn-primary py-4 px-12 text-xl" disabled>Xem k·∫øt qu·∫£</button>
                      </div>
                  </div>
            </div>`;
},

recipeFormulas: () => `
                  <div id="recipeFormulasView" class="w-full h-full flex flex-col md:flex-row gap-6 absolute inset-0 view-transition">
                      <aside id="recipeListPanel" class="w-full md:w-1/3 lg:w-[30%] xl:w-1/4 glass-panel p-4 md:p-6 flex flex-col flex-shrink-0 md:flex">
                          <input type="search" id="searchInput" class="w-full p-3 my-4 rounded-xl bg-gray-200/50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all" data-translate-key="searchInputPlaceholder">
                          
                          <div class="space-y-4 text-sm mb-4 md:hidden">
                              <div><h4 class="font-semibold mb-2" data-translate-key="filterType"></h4><div class="flex gap-2" data-filter-group="type"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterTypeColor" data-filter-value="color"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterTypeBW" data-filter-value="bw"></button></div></div>
                              <div><h4 class="font-semibold mb-2" data-translate-key="filterContrast"></h4><div class="flex gap-2" data-filter-group="contrast"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                              <div><h4 class="font-semibold mb-2" data-translate-key="filterSaturation"></h4><div class="flex gap-2" data-filter-group="saturation"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                          </div>

                          <div id="recipeListContainer" class="space-y-2 md:pt-0 pt-4 border-t md:border-t-0 flex-grow overflow-y-auto pr-2 -mr-3"></div>
                          
                          <div id="compareBtnContainer" class="pt-4 flex-shrink-0 border-t mt-auto"></div>
                      </aside>

                      <main id="recipeMainPanel" class="w-full md:w-2/3 lg:w-[70%] xl:w-3/4 flex-col min-h-0 hidden md:flex">
                          <div id="filtersContainerDesktop" class="glass-panel p-4 mb-6 hidden md:flex flex-wrap items-center gap-x-6 gap-y-3 text-sm">
 <div class="flex items-center gap-3"><h4 class="font-semibold shrink-0" data-translate-key="filterType"></h4><div class="flex gap-2" data-filter-group="type"><button class="filter-btn py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterTypeColor" data-filter-value="color"></button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterTypeBW" data-filter-value="bw"></button></div></div>
 <div class="flex items-center gap-3"><h4 class="font-semibold shrink-0" data-translate-key="filterContrast"></h4><div class="flex gap-2" data-filter-group="contrast"><button class="filter-btn py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
 <div class="flex items-center gap-3"><h4 class="font-semibold shrink-0" data-translate-key="filterSaturation"></h4><div class="flex gap-2" data-filter-group="saturation"><button class="filter-btn py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                          </div>

                          <div class="glass-panel flex-grow overflow-y-auto p-6 lg:p-10">
                             <div id="chartsContainer">
                                 <div class="text-center mb-10">
                                     <h2 class="text-2xl md:text-3xl font-bold text-gray-700" data-translate-key="recipeDetailWelcomeTitle"></h2><p class="text-neutral-500 mt-2 max-w-xl mx-auto" data-translate-key="recipeDetailWelcomeText"></p>
                                 </div>
                                 <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                     <div><h3 class="text-xl font-bold text-center mb-4" data-translate-key="colorChartTitle"></h3><div class="chart-container"><canvas id="colorChart"></canvas></div></div>
                                     <div><h3 class="text-xl font-bold text-center mb-4" data-translate-key="bwChartTitle"></h3><div class="chart-container"><canvas id="bwChart"></canvas></div></div>
                                 </div>
                             </div>
                             <div id="recipeContent" class="hidden"></div>
                          </div>
                      </main>
                      <div id="recipeDetailPanelMobile" class="w-full h-full absolute inset-0 bg-[#f4f7fc] p-4 overflow-y-auto hidden">
                          <button id="backToListBtn" class="btn bg-gray-200 text-gray-800 mb-4 p-4" data-translate-key="backToListBtn"></button>
                          <div class="glass-panel p-6 overflow-y-auto">
                             <div id="recipeContentMobile"></div>
                          </div>
                      </div>
                  </div>`,

featuredPhotos: () => `<div id="featuredPhotosView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition p-4">
  <div class="glass-panel p-6 md:p-12 text-center max-w-5xl mx-auto">
      <h2 class="text-2xl md:text-4xl font-bold" data-translate-key="featuredTitle"></h2>
      <p class="text-base md:text-lg text-neutral-600 mt-4 max-w-3xl mx-auto" data-translate-key="featuredCta"></p>
      <a href="https://www.facebook.com/media/set?set=oa.31406519995613930&type=3" target="_blank" rel="noopener noreferrer" class="btn btn-primary mt-8 py-3 px-8 text-base md:text-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 2L12 11M12 11L15 8M12 11L9 8"/><path d="M20 13.33V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6C4 4.89543 4.89543 4 6 4H10.67" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span data-translate-key="featuredAlbumBtn"></span>
      </a>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-10">
          ${recipesData.slice(0,6).map((recipe) => {
              const hasDemoImages = recipe.demoImages && recipe.demoImages.length > 0;
              const imgSrc = hasDemoImages ? recipe.demoImages[0] : `https://placehold.co/800x600/${recipe.personalityColor.substring(1)}/ffffff?text=${encodeURIComponent(recipe.name[state.currentLang])}`;
              return `<div class="bg-gray-200 group rounded-xl overflow-hidden cursor-pointer lightbox-trigger-thumb" data-recipe-id="${recipe.id}" data-index="0">
                      <img src="${imgSrc}" alt="·∫¢nh demo c√¥ng th·ª©c ${recipe.name[state.currentLang]}" class="aspect-video w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300" loading="lazy">
                  </div>`;
          }).join('')}
      </div>
  </div>
</div>`,

explain: () => `
          <div id="explainView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition bg-slate-50 text-gray-800">
              <div class="container mx-auto p-4 sm:p-6 md:p-12">
                  <header class="text-center mb-12 md:mb-16 pt-4 md:pt-8">
                      <h1 class="text-3xl md:text-5xl font-extrabold text-slate-800 mb-2" data-translate-key="explainHeader"></h1>
                      <h2 class="text-lg md:text-xl text-slate-600 max-w-3xl mx-auto" data-translate-key="explainSubtitle"></h2>
                  </header>
                  
                  <main class="space-y-12 md:space-y-20">
                      <section>
                          <h3 class="text-2xl md:text-3xl font-bold text-center mb-8" data-translate-key="pillarsTitle"></h3>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                              <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                                  <h4 class="text-xl font-bold mb-6 text-center" data-translate-key="wbPillarTitle"></h4>
                                  <div class="mb-8">
                                      <h5 class="font-bold text-lg" data-translate-key="wbKelvinTitle"></h5>
                                      <p class="text-sm text-gray-600 mb-3" data-translate-key="wbKelvinDesc"></p>
                                      <div class="w-full h-8 rounded-full bg-gradient-to-r from-blue-400 via-white to-orange-400 flex justify-between items-center px-2 text-xs font-bold text-gray-700">
                                          <span>2500K</span>
                                          <span>5500K</span>
                                          <span>9900K</span>
                                      </div>
                                  </div>
                                  <div>
                                      <h5 class="font-bold text-lg" data-translate-key="wbShiftTitle"></h5>
                                      <p class="text-sm text-gray-600 mb-3" data-translate-key="wbShiftDesc"></p>
                                      <div id="abgm-grid-interactive-container">
                                          <div id="abgm-grid" class="relative">
                                              <span class="absolute top-1/2 -left-5 -translate-y-1/2 font-bold text-blue-600">B</span>
                                              <span class="absolute top-1/2 -right-5 -translate-y-1/2 font-bold text-amber-600">A</span>
                                              <span class="absolute left-1/2 -top-5 -translate-x-1/2 font-bold text-green-600">G</span>
                                              <span class="absolute left-1/2 -bottom-5 -translate-x-1/2 font-bold text-purple-600">M</span>
                                              <div id="abgm-pointer" style="top: 50%; left: 50%;"></div>
                                          </div>
                                          <div id="abgm-values" class="text-center mt-2 font-mono font-semibold bg-slate-100 p-2 rounded-md">A-B: 0, G-M: 0</div>
                                      </div>
                                  </div>
                              </div>
                              <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                                  <h4 class="text-xl font-bold mb-6 text-center" data-translate-key="ppPillarTitle"></h4>
                                  <p class="text-sm text-gray-700 mb-6 text-center">Picture Profile l√† m·ªôt h·ªá th·ªëng menu t√≠ch h·ª£p trong m√°y ·∫£nh Sony, cung c·∫•p m·ªôt lo·∫°t c√°c th√¥ng s·ªë cho ph√©p ng∆∞·ªùi d√πng ƒëi·ªÅu ch·ªânh h√¨nh ·∫£nh v√† video ngay b√™n trong m√°y ·∫£nh tr∆∞·ªõc khi ch√∫ng ƒë∆∞·ª£c x·ª≠ l√Ω v√† n√©n.<br>C√°c th√¥ng s·ªë n√†y cho ph√©p thay ƒë·ªïi c√°c c√†i ƒë·∫∑t li√™n quan ƒë·∫øn m√†u s·∫Øc, ƒë·ªô chuy·ªÉn t√¥ng, ƒë·ªô t∆∞∆°ng ph·∫£n v√† ƒë·ªô s·∫Øc n√©t c·ªßa h√¨nh ·∫£nh.</p>
                                    <div class="space-y-4">
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">1. <span data-translate-key="ppItemGamma"></span></summary><p class="text-sm text-gray-600 mt-2">Gamma thi·∫øt l·∫≠p ƒë·ªô d·ªëc (ƒë∆∞·ªùng cong t∆∞∆°ng ph·∫£n), x√°c ƒë·ªãnh m·ªëi quan h·ªá gi·ªØa m·ª©c t√≠n hi·ªáu ƒë·∫ßu v√†o (ƒë·ªô s√°ng t·ª´ ƒë·ªëi t∆∞·ª£ng) v√† m·ª©c t√≠n hi·ªáu ƒë·∫ßu ra (ƒë·ªô s√°ng ƒë∆∞·ª£c t√°i t·∫°o b·ªüi m√°y ·∫£nh ho·∫∑c m√†n h√¨nh hi·ªÉn th·ªã).<br>H√¨nh d·∫°ng c·ªßa ƒë∆∞·ªùng cong gamma ·∫£nh h∆∞·ªüng ƒë√°ng k·ªÉ ƒë·∫øn ƒë·∫∑c ƒëi·ªÉm h√¨nh ·∫£nh, ƒë·∫∑c bi·ªát l√† ·ªü c√°c v√πng t·ªëi v√† ƒë·ªô t∆∞∆°ng ph·∫£n t·ªïng th·ªÉ. C√°c ƒë∆∞·ªùng cong Cine, S-Cinetone v√† HLG n·ªïi b·∫≠t nh∆∞ nh·ªØng ·ª©ng c·ª≠ vi√™n ch√≠nh cho c√°c giao di·ªán ƒëi·ªán ·∫£nh "t·ª©c th√¨", mang l·∫°i s·ª± c√¢n b·∫±ng gi·ªØa d·∫£i ƒë·ªông v√† ƒë·ªô t∆∞∆°ng ph·∫£n d·ªÖ ch·ªãu ngay t·ª´ m√°y ·∫£nh. S-Log kh√¥ng d√†nh cho vi·ªác s·ª≠ d·ª•ng "t·ª©c th√¨", ƒë·∫∑c bi·ªát l√† tr√™n c√°c m√°y ·∫£nh 8 bit do nhi·ªÖu v√† t√≠nh d·ªÖ v·ª° c·ªßa n√≥.</p></details>
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">2. <span data-translate-key="ppItemColorMode"></span></summary><p class="text-sm text-gray-600 mt-2">Color Mode x√°c ƒë·ªãnh c√°c ƒë·∫∑c t√≠nh m√†u s·∫Øc, ho·∫°t ƒë·ªông k·∫øt h·ª£p v·ªõi Gamma ƒë·ªÉ thi·∫øt l·∫≠p m√†u s·∫Øc c∆° b·∫£n c·ªßa h√¨nh ·∫£nh.<br>Gamma x√°c ƒë·ªãnh ƒë∆∞·ªùng cong ƒë·ªô s√°ng, trong khi Color Mode x√°c ƒë·ªãnh s·∫Øc ƒë·ªô. C√πng v·ªõi nhau, ch√∫ng thi·∫øt l·∫≠p "giao di·ªán" c∆° b·∫£n c·ªßa h√¨nh ·∫£nh. Vi·ªác ch·ªçn ƒë√∫ng Color Mode l√† r·∫•t quan tr·ªçng ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c c√°c t√≠nh th·∫©m m·ªπ c·ª• th·ªÉ.</p></details>
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">3. <span data-translate-key="ppItemBlackLevel"></span></summary><p class="text-sm text-gray-600 mt-2">Ch·ª©c nƒÉng Black Level ƒëi·ªÅu ch·ªânh ƒëi·ªÉm ƒëen, v·ªÅ c∆° b·∫£n ki·ªÉm so√°t ƒëi·ªÉm t·ªëi nh·∫•t trong h√¨nh ·∫£nh.<br>M·ªôt m√†u ƒëen b·ªã "crush" (√©p xu·ªëng) c√≥ th·ªÉ th√™m k·ªãch t√≠nh v√† ƒë·ªô t∆∞∆°ng ph·∫£n, trong khi m√†u ƒëen ƒë∆∞·ª£c "lift" (n√¢ng l√™n) ‚Äì th∆∞·ªùng ƒë∆∞·ª£c g·ªçi l√† "m√†u ƒëen m·ªù" ho·∫∑c "m√†u ƒëen s·ªØa" ‚Äì l√† m·ªôt ƒë·∫∑c ƒëi·ªÉm c·ªßa nhi·ªÅu lo·∫°i phim c·ªï ƒëi·ªÉn v√† c√≥ th·ªÉ t·∫°o ra c·∫£m gi√°c m·ªÅm m·∫°i, thanh tao ho·∫∑c c·ªï ƒëi·ªÉn h∆°n.</p></details>
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">4. <span data-translate-key="ppItemColorDepth"></span></summary><p class="text-sm text-gray-600 mt-2">Ch·ª©c nƒÉng Color Depth ƒëi·ªÅu ch·ªânh ƒë·ªô s√°ng cho t·ª´ng pha m√†u (ƒê·ªè, L·ª•c, Lam, L·ª•c lam, T√≠m, V√†ng) ri√™ng l·∫ª.<br>Kh√¥ng gi·ªëng nh∆∞ Saturation to√†n c·∫ßu ho·∫∑c Color Phase, Color Depth cho ph√©p ƒëi·ªÅu ch·ªânh ƒë·ªô s√°ng tr√™n t·ª´ng k√™nh, mang l·∫°i kh·∫£ nƒÉng ki·ªÉm so√°t ch√≠nh x√°c h∆°n. Th√¥ng s·ªë n√†y c·ª±c k·ª≥ m·∫°nh m·∫Ω ƒë·ªÉ ch·ªânh m√†u tinh t·∫ø nh∆∞ng c√≥ t√°c ƒë·ªông tr·ª±c ti·∫øp trong m√°y ·∫£nh.</p></details>
                                    </div>
                              </div>
                          </div>
                      </section>
                      
                      <section class="bg-gradient-to-b from-slate-100 to-white rounded-2xl shadow-lg p-6 md:p-8">
                         <h3 class="text-2xl md:text-3xl font-bold text-center" data-translate-key="ppInfographicTitle"></h3>
                         <p class="max-w-3xl mx-auto text-center text-gray-700 mt-2 mb-10">L√†m theo c√°c b∆∞·ªõc sau ƒë·ªÉ thi·∫øt l·∫≠p Picture Profile t·ª´ ƒë·∫ßu, cho ph√©p b·∫°n ki·ªÉm so√°t ho√†n to√†n giao di·ªán cu·ªëi c√πng c·ªßa h√¨nh ·∫£nh.</p>
                         <div class="space-y-6">
                              <div class="pp-infographic-item"><h5 data-translate-key="ppItemBlackLevel"></h5><p class="text-sm text-gray-600 mt-1">Thi·∫øt l·∫≠p ƒëi·ªÉm ƒëen (v√πng t·ªëi nh·∫•t). TƒÉng (+) ƒë·ªÉ n√¢ng v√πng t·ªëi (t·∫°o look 'faded' ho√†i c·ªï), gi·∫£m (-) ƒë·ªÉ v√πng t·ªëi s√¢u h∆°n (tƒÉng t∆∞∆°ng ph·∫£n).</p></div>
                              <div class="text-center text-gray-400 font-bold">‚Üì</div>
                              <div class="pp-infographic-item"><h5 data-translate-key="ppItemGamma"></h5><p class="text-sm text-gray-600 mt-1">Thi·∫øt l·∫≠p ƒë∆∞·ªùng cong t∆∞∆°ng ph·∫£n (contrast curve). ƒê√¢y l√† n·ªÅn t·∫£ng cho 'look' c·ªßa b·∫°n. Still & Movie cho ƒë·ªô t∆∞∆°ng ph·∫£n cao, trong khi c√°c gamma Cine/S-Log cho d·∫£i nh·∫°y s√°ng r·ªông h∆°n.</p></div>
                              <div class="text-center text-gray-400 font-bold">‚Üì</div>
                              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemBlackGamma"></h5><p class="text-sm text-gray-600 mt-1">Tinh ch·ªânh ƒë∆∞·ªùng cong t∆∞∆°ng ph·∫£n ·ªü v√πng t·ªëi. 'Wide' ·∫£nh h∆∞·ªüng v√πng r·ªông h∆°n, 'Narrow' ·∫£nh h∆∞·ªüng v√πng h·∫πp h∆°n. Vi·ªác ƒëi·ªÅu ch·ªânh Black Gamma r·∫•t c·∫ßn thi·∫øt ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c c√°c giao di·ªán ƒëi·ªán ·∫£nh c·ª• th·ªÉ, n∆°i chi ti·∫øt v√† k·∫øt c·∫•u b√≥ng t·ªëi l√† r·∫•t quan tr·ªçng.</p></div>
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemKnee"></h5><p class="text-sm text-gray-600 mt-1">Ki·ªÉm so√°t ƒë·ªô n√©n ·ªü v√πng s√°ng (highlight) ƒë·ªÉ tr√°nh b·ªã 'ch√°y'. Ch·∫ø ƒë·ªô t·ª± ƒë·ªông (Auto) ho·∫°t ƒë·ªông t·ªët, ch·∫ø ƒë·ªô th·ªß c√¥ng (Manual) cho ph√©p ki·ªÉm so√°t ch√≠nh x√°c h∆°n. Ch·ª©c nƒÉng Knee l√† v√¥ gi√° ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c c·∫£nh quay "t·ª©c th√¨" c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c trong c√°c t√¨nh hu·ªëng c√≥ ƒë·ªô t∆∞∆°ng ph·∫£n cao.</p></div>
                              </div>
                              <div class="text-center text-gray-400 font-bold">‚Üì</div>
                              <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorMode"></h5><p class="text-sm text-gray-600 mt-1">X√°c ƒë·ªãnh c√°ch m√†u s·∫Øc ƒë∆∞·ª£c t√°i t·∫°o. N√™n ch·ªçn ch·∫ø ƒë·ªô ph√π h·ª£p v·ªõi Gamma ƒë√£ ch·ªçn (v√≠ d·ª•: Cine4 v·ªõi Pro/Cinema, S-Log3 v·ªõi S-Gamut3.Cine).</p></div>
                              <div class="text-center text-gray-400 font-bold">‚Üì</div>
                              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemSaturation"></h5><p class="text-sm text-gray-600 mt-1">ƒêi·ªÅu ch·ªânh ƒë·ªô ƒë·∫≠m/nh·∫°t t·ªïng th·ªÉ c·ªßa t·∫•t c·∫£ c√°c m√†u. ƒê·ªô b√£o h√≤a kh√¥ng ch·ªâ l√† l√†m cho m√†u s·∫Øc n·ªïi b·∫≠t; n√≥ l√† m·ªôt c√¥ng c·ª• m·∫°nh m·∫Ω ƒë·ªÉ truy·ªÅn t·∫£i t√¢m tr·∫°ng v√† th·ªÉ lo·∫°i.</p></div>
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorPhase"></h5><p class="text-sm text-gray-600 mt-1">Xoay tr·ª•c m√†u s·∫Øc t·ªïng th·ªÉ. H·ªØu √≠ch ƒë·ªÉ tinh ch·ªânh nh·∫π to√†n b·ªô t√¥ng m√†u m√† kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn t·ª´ng m√†u ri√™ng l·∫ª. M·∫∑c d√π √≠t tr·ª±c quan h∆°n cho c√°c ƒëi·ªÅu ch·ªânh s√°ng t·∫°o chung, Color Phase l√† v√¥ gi√° trong c√°c s·∫£n ph·∫©m ƒëa m√°y ·∫£nh.</p></div>
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemDetail"></h5><p class="text-sm text-gray-600 mt-1">Ki·ªÉm so√°t ƒë·ªô s·∫Øc n√©t. ƒê·ªÉ c√≥ 'look' phim m·ªÅm m·∫°i, h√£y gi·∫£m m·∫°nh (v√≠ d·ª•: -7). Vi·ªác ƒë·ªÅ xu·∫•t c√°c c√†i ƒë·∫∑t Detail th√≠ch h·ª£p l√† r·∫•t quan tr·ªçng ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·∫ßu ra "t·ª©c th√¨" tr√¥ng b√≥ng b·∫©y v√† t·ª± nhi√™n, kh√¥ng b·ªã x·ª≠ l√Ω qu√° m·ª©c.</p></div>
                              </div>
                              <div class="text-center text-gray-400 font-bold">‚Üì</div>
                               <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorDepth"></h5><p class="text-sm text-gray-600 mt-1">C√¥ng c·ª• m·∫°nh m·∫Ω nh·∫•t. TƒÉng/gi·∫£m ƒë·ªô s√°ng c·ªßa t·ª´ng k√™nh m√†u ri√™ng l·∫ª (ƒê·ªè, L·ª•c, Lam, L·ª•c lam, T√≠m, V√†ng). ƒê√¢y l√† m·ªôt c√¥ng c·ª• quan tr·ªçng ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c s·ª± ph√¢n t√°ch m√†u s·∫Øc v√† nh·∫•n m·∫°nh m√†u s·∫Øc c√≥ s·∫Øc th√°i, chuy√™n nghi·ªáp.</p></div>
                         </div>
                         <div class="text-center mt-12">
                              <button id="exploreMoreBtn" class="btn btn-primary py-3 px-8 text-base md:text-lg" data-translate-key="navRecipeFormulas"></button>
                          </div>
                      </section>

                      <section class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                          <h3 class="text-2xl md:text-3xl font-bold text-center mb-4" data-translate-key="recallTitle"></h3>
                          <p class="max-w-3xl mx-auto text-center text-gray-700 mb-8">ƒê·ª´ng l√£ng ph√≠ c√¥ng s·ª©c! L∆∞u l·∫°i c√°c c√¥ng th·ª©c c·ªßa b·∫°n v√†o b·ªô nh·ªõ c·ªßa m√°y ·∫£nh ƒë·ªÉ g·ªçi ra nhanh ch√≥ng ch·ªâ b·∫±ng m·ªôt thao t√°c xoay n√∫t.</p>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                              <div class="bg-slate-100 rounded-lg p-6 text-center">
                                  <h4 class="text-xl font-bold text-slate-700 mb-2" data-translate-key="recallInternalTitle"></h4>
                                  <p class="text-sm">L∆∞u tr·ª±c ti·∫øp v√†o m√°y. Truy c·∫≠p nhanh nh·∫•t b·∫±ng c√°ch xoay v√≤ng xoay ch·∫ø ƒë·ªô. L√Ω t∆∞·ªüng cho c√°c c√¥ng th·ª©c b·∫°n s·ª≠ d·ª•ng h√†ng ng√†y.</p>
                              </div>
                              <div class="bg-slate-100 rounded-lg p-6 text-center">
                                  <h4 class="text-xl font-bold text-slate-700 mb-2" data-translate-key="recallCardTitle"></h4>
                                  <p class="text-sm">L∆∞u d∆∞·ªõi d·∫°ng file tr√™n th·∫ª nh·ªõ. C·ª±c k·ª≥ h·ªØu √≠ch ƒë·ªÉ sao l∆∞u an to√†n ho·∫∑c chuy·ªÉn c√¥ng th·ª©c sang m·ªôt th√¢n m√°y Sony kh√°c.</p>
                              </div>
                          </div>
                      </section>

                      <section class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                          <h3 class="text-2xl md:text-3xl font-bold text-center mb-4" data-translate-key="exposureNoteTitle"></h3>
                          <p class="max-w-3xl mx-auto text-center text-gray-700">H·∫ßu h·∫øt c√°c c√¥ng th·ª©c ƒë∆∞·ª£c t·ªëi ∆∞u khi ch·ª•p ·ªü m·ª©c ph∆°i s√°ng 0EV v·ªõi ch·∫ø ƒë·ªô ƒëo s√°ng 'To√†n m√†n h√¨nh trung b√¨nh' (Entire Screen Avg.).<br>Tuy nhi√™n, c√°c c√¥ng th·ª©c d·ª±a tr√™n S-Log c√≥ th·ªÉ c·∫ßn tƒÉng ph∆°i s√°ng (overexpose) ƒë·ªÉ c√≥ k·∫øt qu·∫£ t·ªët nh·∫•t. Vi·ªác ph∆°i s√°ng ƒë√∫ng c√°ch ƒë·∫£m b·∫£o r·∫±ng m√°y ·∫£nh thu ƒë∆∞·ª£c l∆∞·ª£ng √°nh s√°ng v√† chi ti·∫øt t·ªëi ∆∞u, cho ph√©p Picture Profile ph√°t huy t√°c d·ª•ng m·ªôt c√°ch hi·ªáu qu·∫£.</p>
                      </section>
                      
                  </main>
                  <footer class="text-center text-sm text-gray-500 pt-8 mt-12 border-t">
                      <p data-translate-key="footerText"></p>
                  </footer>
              </div>
          </div>`
};

// --- UI RENDERING & VIEW MANAGEMENT ---
function createSettingsGrid(settings) {
if (!settings) return '';
return Object.entries(settings).map(([key, value]) => `<div class="flex flex-col"><span class="text-xs text-neutral-500">${key}</span><span class="font-semibold text-lg">${value}</span></div>`).join('');
};

function createFullRecipeHTML(recipe, isMainView = false) {
const titleClass = isMainView ? 'text-xl font-bold' : 'text-lg font-bold';
const noteHTML = (recipe.notes && recipe.notes[state.currentLang])
? `<div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-xl">
                                  <p class="font-bold" data-translate-key="noteTitle"></p>
                                  <p>${recipe.notes[state.currentLang]}</p>
                                </div>` : '';

return `${noteHTML}<div class="space-y-6 mt-6">
              <div><h4 class="${titleClass} mb-2" data-translate-key="whiteBalanceTitle"></h4><div class="p-4 bg-black/5 rounded-xl"><p class="font-semibold text-lg">${recipe.whiteBalance || ''}</p></div></div>
              <div><h4 class="${titleClass} mb-2" data-translate-key="recipeSettingsTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.settings)}</div></div>
              ${recipe.colorDepth ? `<div><h4 class="${titleClass} mb-2" data-translate-key="colorDepthTitle"></h4><div class="grid grid-cols-3 sm:grid-cols-6 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.colorDepth)}</div></div>` : ''}
              ${recipe.detailSettings ? `<div><h4 class="${titleClass} mb-2" data-translate-key="detailTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.detailSettings)}</div></div>` : ''}
        </div>`;
}

function destroyAllCharts() {
    Object.values(activeCharts).forEach(chart => { if(chart && typeof chart.destroy === 'function') chart.destroy(); });
    activeCharts = {};
}

function renderView(viewName) {
    return new Promise(resolve => {
        const currentContent = mainContentEl.children[0];
        if (currentContent) {
            currentContent.classList.add('view-transition-out');
            destroyAllCharts();
            currentContent.addEventListener('animationend', () => {
                mainContentEl.innerHTML = viewTemplates[viewName]();
                attachViewEventListeners(viewName);
                applyTranslations();
                resolve();
            }, { once: true });
        } else {
            mainContentEl.innerHTML = viewTemplates[viewName]();
            attachViewEventListeners(viewName);
            applyTranslations();
            resolve();
        }
    });
}

function renderLibraryList() {
    const container = document.getElementById('recipeListContainer'); if (!container) return;
    const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
    let recipesToRender = recipesData.filter(recipe => {
        const nameMatch = recipe.name[state.currentLang].toLowerCase().includes(searchTerm);
        const descriptionMatch = recipe.description[state.currentLang].toLowerCase().includes(searchTerm);
        const typeMatch = state.activeFilters.type === 'all' || recipe.type === state.activeFilters.type;
        const contrastMatch = state.activeFilters.contrast === 'all' || recipe.contrast === state.activeFilters.contrast;
        const saturationMatch = state.activeFilters.saturation === 'all' || recipe.saturation === state.activeFilters.saturation;
        return (nameMatch || descriptionMatch) && typeMatch && contrastMatch && saturationMatch;
    });

    container.innerHTML = recipesToRender.map(recipe => {
        const isChecked = state.comparisonList.includes(recipe.id);
        const isSelected = recipe.id === state.selectedRecipeId;
        return `<div class="recipe-item p-3 rounded-xl transition-all duration-200 border-l-4 border-transparent flex items-start gap-4 ${isSelected ? 'selected' : ''}">
                    <input type="checkbox" class="recipe-compare-cb form-checkbox h-5 w-5 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 self-start mt-1 flex-shrink-0" data-recipe-id="${recipe.id}" ${isChecked ? 'checked' : ''} ${state.comparisonList.length >= 2 && !isChecked ? 'disabled' : ''}>
                    <div class="flex-grow cursor-pointer recipe-item-content" data-recipe-id="${recipe.id}">
                        <div class="flex items-start gap-3">
                            <div class="recipe-dot w-5 h-5 rounded-full flex-shrink-0 mt-1" style="background-color: ${recipe.personalityColor}" title="${recipe.name[state.currentLang]}"></div>
                            <div class="flex-grow">
                                <span class="font-semibold text-primary">${recipe.name[state.currentLang]}</span>
                                <p class="text-sm text-neutral-600 mt-1 leading-snug">${recipe.description[state.currentLang]}</p>
                            </div>
                        </div>
                    </div>
                </div>`;
    }).join('');

    const btnContainer = document.getElementById('compareBtnContainer');
    btnContainer.innerHTML = `<button id="compareBtn" class="btn btn-primary w-full mt-4 py-3" data-translate-key="compareBtn" ${state.comparisonList.length !== 2 ? 'disabled' : ''}></button>`;
    applyTranslations();
}

function renderLibraryDetails() {
    const isMobile = window.innerWidth < 768;
    const recipeListPanel = document.getElementById('recipeListPanel');
    const recipeMainPanel = document.getElementById('recipeMainPanel');
    const recipeDetailPanelMobile = document.getElementById('recipeDetailPanelMobile');

    if (isMobile) {
        recipeListPanel.classList.toggle('hidden', state.isMobileDetailActive);
        recipeDetailPanelMobile.classList.toggle('hidden', !state.isMobileDetailActive);
    } else {
        recipeListPanel?.classList.remove('hidden');
        recipeDetailPanelMobile?.classList.add('hidden');
    }

    const recipe = recipesData.find(r => r.id === state.selectedRecipeId);
    const recipeContentContainer = isMobile && state.isMobileDetailActive ? document.getElementById('recipeContentMobile') : document.getElementById('recipeContent');
    const chartsContainer = document.getElementById('chartsContainer');

    if (!recipeContentContainer) return;

    if (!recipe) {
        if (chartsContainer) chartsContainer.classList.remove('hidden');
        recipeContentContainer.classList.add('hidden');
        if(!isMobile) recipeMainPanel?.classList.remove('hidden');
        return;
    }
    if (chartsContainer) chartsContainer.classList.add('hidden');
    recipeContentContainer.classList.remove('hidden');
    if(!isMobile) recipeMainPanel?.classList.remove('hidden');

    const images = recipe.demoImages || [];
    const imageElements = images.map((imgSrc, index) => 
        `<div class="bg-gray-200 group rounded-xl overflow-hidden cursor-pointer lightbox-trigger-thumb" data-recipe-id="${recipe.id}" data-index="${index}"><img src="${imgSrc}" loading="lazy" alt="·∫¢nh demo ${recipe.name[state.currentLang]} ${index + 1}" class="aspect-[4/3] w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300"></div>`
    );
    
    recipeContentContainer.innerHTML = `
        <h3 class="text-3xl md:text-4xl font-bold">${recipe.name[state.currentLang]}</h3>
        <p class="text-lg text-neutral-600 mt-2 italic">"${recipe.description[state.currentLang]}"</p>
        <div class="my-6"><div class="grid grid-cols-3 gap-2 md:gap-4">${imageElements.join('')}</div></div>
        <div class="mt-12 pt-8 border-t-2 border-gray-200/60">
            <h3 class="text-xl md:text-2xl font-bold mb-4" data-translate-key="exportRecipeBtn"></h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="downloadLutBtn" data-recipe-id="${recipe.id}" class="btn bg-blue-100 text-blue-800 hover:bg-blue-200 w-full py-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span data-translate-key="downloadLutBtn"></span>
                </button>
                <button id="memoryRecallGuideBtn" class="btn bg-gray-200 text-gray-800 hover:bg-gray-300 w-full py-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <span data-translate-key="memoryRecallBtn"></span>
                </button>
            </div>
        </div>
        <div id="originalRecipeContainer" class="mt-8">${createFullRecipeHTML(recipe, true)}</div>
        <div class="mt-8 pt-8 border-t-2 border-gray-200/60">
            <button id="aiExplainRecipeBtn" data-recipe-id="${recipe.id}" class="btn btn-primary w-full py-3" data-translate-key="aiExplainRecipeBtn"></button>
            <div id="aiExplanationContainer" class="mt-4 hidden"></div>
        </div>
        <div class="mt-12 pt-8 border-t-2 border-gray-200/60">
            <h3 class="text-xl md:text-2xl font-bold mb-4" data-translate-key="aiTuningTitle"></h3>
            <div class="glass-panel p-4 md:p-6 -mx-2">
                <textarea id="aiTuningTextarea" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 transition-shadow" rows="3" data-translate-key="aiTuningPlaceholder"></textarea>
                <button id="aiTuningBtn" data-recipe-id="${recipe.id}" class="btn btn-primary w-full mt-4 py-3" data-translate-key="aiTuningBtn"></button>
                <div id="aiResultContainer"></div>
            </div>
        </div>`;
    applyTranslations();
}

function renderInteractiveCharts(lang) {
    destroyAllCharts();
    const chartDefaultOptions = (yAxisTitleKey) => ({
        responsive: true, maintainAspectRatio: false,
        onClick: (e) => {
            const chart = e.chart;
            const elements = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
            if (elements.length) {
                const recipeId = chart.data.datasets[elements[0].datasetIndex].data[elements[0].index].id;
                if (recipeId) handleRecipeSelection(recipeId, 'chart');
            }
        },
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => c.raw.name } } },
        scales: {
            x: { min: -10, max: 10, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false }, border: { dash: [4, 4] }, title: { display: true, text: t('axisTonality') } },
            y: { min: -10, max: 10, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false }, border: { dash: [4, 4] }, title: { display: true, text: t(yAxisTitleKey) } }
        }
    });

    const colorCtx = document.getElementById('colorChart')?.getContext('2d');
    if (colorCtx) {
        const colorData = recipesData.filter(r => r.type === 'color').map(r => ({ ...r.coords, id: r.id, name: r.name[lang] }));
        activeCharts.color = new Chart(colorCtx, {
            type: 'scatter',
            data: { datasets: [{ data: colorData, pointBackgroundColor: colorData.map(d => recipesData.find(r=>r.id===d.id).personalityColor), pointBorderColor: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? '#007AFF' : '#fff'), pointBorderWidth: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 4 : 2), pointRadius: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 11 : 7), pointHoverRadius: 11 }] },
            options: chartDefaultOptions('axisSaturation')
        });
    }

    const bwCtx = document.getElementById('bwChart')?.getContext('2d');
    if (bwCtx) {
        const bwData = recipesData.filter(r => r.type === 'bw').map(r => ({ ...r.coords, id: r.id, name: r.name[lang] }));
        activeCharts.bw = new Chart(bwCtx, {
            type: 'scatter',
            data: { datasets: [{ data: bwData, pointBackgroundColor: '#475569', pointBorderColor: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? '#007AFF' : '#fff'), pointBorderWidth: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 4 : 2), pointRadius: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 11 : 7), pointHoverRadius: 11 }] },
            options: chartDefaultOptions('axisChroma')
        });
    }
}

function toggleMobileNav(show) {
    const menu = document.getElementById('mobileNavMenu');
    menu.classList.toggle('translate-x-full', !show);
}

function handleDropdownNav() {
    const container = document.getElementById('pp-dropdown-container');
    const btn = document.getElementById('pp-dropdown-btn');
    const menu = document.getElementById('pp-dropdown-menu');
    const chevron = document.getElementById('pp-dropdown-chevron');

    if (!container || !btn || !menu) return;

    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = menu.classList.contains('hidden');
        if (isHidden) {
            menu.classList.remove('hidden');
            setTimeout(() => {
                menu.classList.remove('opacity-0', 'scale-95');
                chevron.style.transform = 'rotate(180deg)';
            }, 10);
        } else {
            menu.classList.add('opacity-0', 'scale-95');
            chevron.style.transform = 'rotate(0deg)';
            menu.addEventListener('transitionend', () => menu.classList.add('hidden'), { once: true });
        }
    });

    document.addEventListener('click', (e) => {
        if (!container.contains(e.target) && !menu.classList.contains('hidden')) {
            menu.classList.add('opacity-0', 'scale-95');
            chevron.style.transform = 'rotate(0deg)';
            menu.addEventListener('transitionend', () => menu.classList.add('hidden'), { once: true });
        }
    });
}


// --- INITIALIZATION & EVENT LISTENERS ---
function attachViewEventListeners(viewName) {
    if (viewName === 'recipeFormulas') {
        renderLibraryList();
        renderLibraryDetails();
        renderInteractiveCharts(state.currentLang);
    } else if (viewName === 'explain') {
        initInteractiveGrid();
    } else if (viewName === 'quiz') {
        const quizView = document.getElementById('quizView');
        quizView.addEventListener('click', (e) => {
            const card = e.target.closest('.quiz-option-card');
            if (!card) return;

            const group = card.closest('[data-quiz-group]').dataset.quizGroup;
            state.quizAnswers[group] = card.dataset.value;

            document.querySelectorAll(`[data-quiz-group="${group}"] .quiz-option-card`).forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            card.classList.remove('bouncing');
            void card.offsetWidth;
            card.classList.add('bouncing');

            const allAnswered = quizQuestions.every(q => state.quizAnswers[q.id]);
            document.getElementById('submitQuizBtn').disabled = !allAnswered;
        });
        document.getElementById('submitQuizBtn').addEventListener('click', handleQuizSubmit);
    }
}

function init() {
    // REFACTORED: Centralized event delegation for better performance and maintainability.
    document.body.addEventListener('click', async (e) => {
        const target = e.target;
        const closest = (selector) => target.closest(selector);

        // High-priority handlers (modals, lightboxes)
        if (state.lightbox.isOpen) {
            if (closest('#lightbox-close') || target.id === 'lightbox-bg') closeLightbox();
            else if (closest('#lightbox-next')) navigateLightbox(1);
            else if (closest('#lightbox-prev')) navigateLightbox(-1);
            else if (closest('.lightbox-thumb')) {
                state.lightbox.currentIndex = parseInt(closest('.lightbox-thumb').dataset.index, 10);
                updateLightboxContent();
            }
            return; // Stop further processing
        }
        
        const eventHandlers = {
            // Modals
            '#closeComparisonModalBtn': () => document.getElementById('comparisonModal').classList.add('hidden'),
            '#closePromptModalBtn': closePromptConfirmationModal,
            '#cancelPromptBtn': closePromptConfirmationModal,
            '#confirmPromptBtn': () => {
                if (promptConfirmationResolver) {
                    promptConfirmationResolver(document.getElementById('improvedPromptText').textContent);
                    promptConfirmationResolver = null;
                }
                closePromptConfirmationModal();
            },
            // Navigation
            '#homeBtn': () => { state.selectedRecipeId = null; state.isMobileDetailActive = false; renderView('home'); },
            '.nav-btn, .nav-btn-mobile': (el) => {
                state.selectedRecipeId = null; state.isMobileDetailActive = false;
                if (el.classList.contains('nav-btn-mobile')) toggleMobileNav(false);
                renderView(el.dataset.view);
            },
            '#hamburgerBtn': () => toggleMobileNav(true),
            '#closeMobileNavBtn': () => toggleMobileNav(false),
            // Language
            '.lang-btn': (el) => {
                state.currentLang = el.id.replace('lang', '').toLowerCase();
                renderView(state.currentView);
            },
            // Main Actions
            '#startQuizBtn': () => { state.quizAnswers = {}; renderView('quiz'); },
            '#compareBtn': (el) => { if (!el.disabled) handleAiComparison(state.comparisonList[0], state.comparisonList[1]); },
            '#compareWithOriginalBtn': (el) => handleAiComparison(el.dataset.originalId, null, state.lastGeneratedAiRecipe),
            '#aiTuningBtn': (el) => handleAiAdjustment(el),
            '#aiExplainRecipeBtn': (el) => handleAiRecipeExplanation(el),
            // Recipe List
            '.recipe-item-content, .recipe-dot': (el) => handleRecipeSelection(closest('[data-recipe-id]').dataset.recipeId, 'div'),
            '.recipe-compare-cb': (el) => handleRecipeSelection(el.dataset.recipeId, 'checkbox'),
            '#backToListBtn': () => { state.isMobileDetailActive = false; renderLibraryDetails(); },
            // Other
            '.lightbox-trigger-thumb': (el) => {
                const recipe = recipesData.find(r => r.id === el.dataset.recipeId);
                if (recipe?.demoImages?.length) openLightbox(recipe.demoImages, parseInt(el.dataset.index, 10));
            },
            '.filter-btn': (el) => {
                const group = el.closest('[data-filter-group]').dataset.filterGroup;
                state.activeFilters[group] = el.dataset.filterValue;
                document.querySelectorAll(`[data-filter-group="${group}"] .filter-btn`).forEach(b => b.classList.toggle('active', b.dataset.filterValue === state.activeFilters[group]));
                renderLibraryList();
            },
            '#downloadLutBtn': (el) => {
                const recipe = recipesData.find(r => r.id === el.dataset.recipeId);
                if (!recipe) return;
                const lutContent = `# Generated by Alpha AI Color Lab for ${recipe.name[state.currentLang]}\nTITLE "${recipe.name[state.currentLang]}"\nLUT_3D_SIZE 33\n# Dummy LUT data\n0.0 0.0 0.0\n1.0 1.0 1.0`;
                const blob = new Blob([lutContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${recipe.id}.cube`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            '#memoryRecallGuideBtn': () => document.getElementById('setupGuideSection')?.scrollIntoView({ behavior: 'smooth' })
        };

        for (const selector in eventHandlers) {
            const el = closest(selector);
            if (el) {
                eventHandlers[selector](el);
                return; // Stop after the first match
            }
        }
    });

    document.body.addEventListener('input', (e) => {
        if (e.target.id === 'searchInput') {
            renderLibraryList();
        }
    });

    window.addEventListener('resize', () => {
        if (state.currentView === 'recipeFormulas') {
            renderLibraryDetails();
        }
    });

    handleDropdownNav();
    renderView('home');
}

document.addEventListener("DOMContentLoaded", init);

</script>
</body>
</html>
