<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alpha AI Color Lab</title>
<!-- Favicon đã được cập nhật. Đường dẫn bây giờ là tương đối. -->
<link rel="icon" type="image/png" href="logo.png">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Be Vietnam Pro', sans-serif;
        background-color: #f8f9fa; /* Softer background color */
        color: #1d1d1f;
        overflow-x: hidden;
        overflow-y: auto;
    }
    :root {
        --primary-accent: #007AFF;
        --primary-accent-darker: #0056B3;
        --glass-bg: rgba(255, 255, 255, 0.55); /* Refined glass effect */
        --glass-border: rgba(0, 0, 0, 0.07);
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
    }
    .glass-panel {    
        background: var(--glass-bg);    
        backdrop-filter: blur(40px) saturate(180%);    
        -webkit-backdrop-filter: blur(40px) saturate(180%);    
        border: 1px solid var(--glass-border);    
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); /* Refined shadow */
        border-radius: 24px;
    }
    @media (min-width: 768px) { .glass-panel { border-radius: 28px; } }
    
    .recipe-item.selected {    
        background-color: rgba(0, 122, 255, 0.1);    
        color: var(--text-primary);    
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
    }
    .recipe-item:hover:not(.selected) { background-color: rgba(0, 0, 0, 0.04); }
    .btn { border-radius: 9999px; font-weight: 600; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background-color: var(--primary-accent); border: none; color: white; box-shadow: 0 4px 14px rgba(0, 118, 255, 0.39); }
    .btn-primary:hover:not(:disabled) { background-color: var(--primary-accent-darker); transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 18px rgba(0, 118, 255, 0.45); }
    .btn:active { transform: translateY(0px) scale(0.98); }

    .view-transition { animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    .view-transition-out { animation: fadeOutDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
    
    /* Sleek Scrollbar */
    .sleek-scrollbar::-webkit-scrollbar { width: 8px; }
    .sleek-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .sleek-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0);
        border-radius: 20px;
        border: 3px solid transparent;
    }
    .sleek-scrollbar:hover::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
    }
    .sleek-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: rgba(0,0,0,0.4);
    }

    /* Modal Styles */
    .modal.hidden { display: none; }
    .modal-panel {
        background: #ffffff;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        border: 1px solid #e5e7eb;
    }
    .parameter-title {
        cursor: help;
        border-bottom: 1px dashed #ccc;
    }
    #infoTooltip {
        position: absolute; z-index: 1000; background-color: rgba(29, 29, 31, 0.9); color: white; padding: 0.75rem 1rem;
        border-radius: 12px; font-size: 0.875rem; line-height: 1.5; max-width: 300px; backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); opacity: 0; transform: translateY(10px);
        transition: opacity 0.2s ease, transform 0.2s ease; pointer-events: none;
    }
    #infoTooltip.visible { opacity: 1; transform: translateY(0); }

    /* AI Lab Specific Styles */
    .comparison-grid .changed {
        background-color: #e6f2ff;
        border: 1px solid #99c8ff;
        box-shadow: 0 0 0 2px #e6f2ff;
    }
    .comparison-grid .value-original { color: #6b7280; }
    .comparison-grid .value-new { color: #1d4ed8; font-weight: 700; }
    .loader {
        width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db;
        border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Quiz Options Styles */
    .quiz-option {
        background-color: #f8fafc;
        border: 2px solid #e2e8f0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        transform: scale(1);
    }
    .quiz-option:hover {
        border-color: #93c5fd;
        background-color: #eff6ff;
        transform: scale(1.03);
        box-shadow: 0 4px 14px rgba(0, 118, 255, 0.1);
    }
    .quiz-option.selected {
        border-color: var(--primary-accent);
        background-color: #dbeafe;
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 118, 255, 0.2);
    }
    .quiz-option:active {
        transform: scale(1.02);
    }
    .quiz-options-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
    }
    .quiz-options-grid .quiz-option {
        flex: 1 1 45%;
        min-width: 200px;
    }
    .quiz-options-grid.has-three-options .quiz-option:last-child {
        flex-basis: 100%;
        max-width: calc(50% - 0.5rem); /* Match width of others */
    }

    /* Dynamic photo collage and lightbox Styles */
    .photo-collage {
        display: grid;
        gap: 0.75rem;
        grid-auto-rows: 200px; /* Define a base row height */
    }
    .collage-item {
        cursor: pointer;
        overflow: hidden;
        border-radius: 0.75rem;
    }
    .collage-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease-in-out;
    }
    .collage-item:hover img {
        transform: scale(1.05);
    }
    /* Masonry Layouts */
    .photo-collage.images-1 { grid-template-columns: 1fr; }
    .photo-collage.images-2 { grid-template-columns: repeat(2, 1fr); }
    .photo-collage.images-3 { grid-template-columns: repeat(3, 1fr); }
    .photo-collage.images-4 { 
        grid-template-columns: repeat(2, 1fr);
        grid-auto-rows: minmax(150px, auto);
    }
    .photo-collage.images-5 {
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: minmax(150px, auto);
    }
    .photo-collage.images-5 > .collage-item:nth-child(1) { grid-column: span 2; grid-row: span 2; }
    .photo-collage.images-5 > .collage-item:nth-child(2) { grid-row: span 2; }
    
    .photo-collage.images-6 { 
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: minmax(150px, auto);
    }
    .photo-collage.images-6 > .collage-item:nth-child(3) { grid-column: span 2; }
    .photo-collage.images-6 > .collage-item:nth-child(4) { grid-column: span 2; }

    /* Lightbox Styles */
    #lightbox {
        position: fixed; inset: 0; background-color: rgba(0,0,0,0.85);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        z-index: 100; display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
    }
    #lightbox.visible { opacity: 1; pointer-events: auto; }
    #lightbox img {
        max-width: 90vw; max-height: 85vh;
        border-radius: 0.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        transform: scale(0.95); transition: transform 0.3s ease;
    }
    #lightbox.visible img { transform: scale(1); }
    #lightboxClose {
        position: absolute; top: 2rem; right: 2rem;
        color: white; font-size: 3rem; font-weight: 200;
        cursor: pointer; transition: transform 0.2s ease;
    }
    #lightboxClose:hover { transform: scale(1.1); }

    /* Welcome Modal & Animation Styles */
    #welcomeModal {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(248, 249, 250, 0.5);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        opacity: 1;
        visibility: visible;
        transition: opacity 0.8s ease-out, visibility 0.8s;
    }
    #welcomeModal.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
    }
    @keyframes aura-glow {
        0% { transform: scale(1) rotate(0deg); opacity: 0.5; }
        50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
        100% { transform: scale(1) rotate(360deg); opacity: 0.5; }
    }
    @keyframes logo-entrance {
        0% { transform: scale(0.3) translateY(50px); opacity: 0; }
        60% { transform: scale(1.1) translateY(-10px); opacity: 1; }
        80% { transform: scale(0.95) translateY(5px); }
        100% { transform: scale(1) translateY(0); }
    }
    @keyframes logo-subtle-float {
        0% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(3deg); }
        100% { transform: translateY(0px) rotate(0deg); }
    }
    @keyframes text-fade-in {
        0% { opacity: 0; transform: translateY(20px); }
        100% { opacity: 1; transform: translateY(0); }
    }
    .landing-animation-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .landing-animation-bg {
        position: absolute;
        width: 600px;
        height: 600px;
        border-radius: 50%;
        background: radial-gradient(circle, #ffadad, #ffd6a5, #fdffb6, #caffbf, #9bf6ff, #a0c4ff, #bdb2ff);
        filter: blur(120px);
        animation: aura-glow 18s linear infinite;
    }
    .animated-logo {
        animation: logo-entrance 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, logo-subtle-float 6s ease-in-out 1.2s infinite;
        z-index: 1;
    }
    .animated-logo-text {
        z-index: 1;
        font-size: 1.25rem; /* 20px */
        line-height: 1.75rem; /* 28px */
        color: #4b5563; /* gray-600 */
        font-weight: 500;
        opacity: 0;
        animation: text-fade-in 1s ease-out 0.5s forwards;
    }
</style>
</head>
<body>

<!-- Welcome Modal -->
<div id="welcomeModal">
    <div class="landing-animation-container">
        <div class="landing-animation-bg"></div>
        <img src="logo.png" alt="Animated Logo" class="animated-logo h-52 w-52">
        <p class="animated-logo-text mt-8 text-center">
            Paint emotions with ColorLAB
            <br>
            by Sony Alpha Vietnam
        </p>
    </div>
</div>

<div id="appContainer" class="min-h-screen w-screen p-4 md:p-6 flex flex-col">
    <header class="flex justify-between items-center w-full z-20 flex-shrink-0">
        <!-- Logo đã được cập nhật kích thước. -->
        <button id="homeBtn" class="flex items-center">
             <img src="logo_black.png" alt="Alpha AI Color Lab Logo" class="h-16 w-auto">
        </button>
        <div class="flex items-center gap-2 md:gap-4">
            <nav id="mainNav" class="hidden md:flex items-center gap-2">
                <button data-view="recipeFormulas" class="nav-btn font-semibold text-gray-600 hover:text-black transition-colors px-4 py-2 rounded-full hover:bg-gray-100" data-translate-key="navRecipeFormulas"></button>
            </nav>
            <div class="p-1 bg-gray-200/70 rounded-full flex relative">
                <div id="lang-glider" class="absolute top-1 bottom-1 w-1/2 bg-white rounded-full shadow-sm transition-transform duration-300"></div>
                <button id="langVI" class="lang-btn-slider relative w-1/2 p-2 rounded-full font-semibold z-10 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600" class="w-5 h-5 rounded-sm"><path fill="#da251d" d="M0 0h900v600H0z"/><path fill="#ff0" d="m450 186-86 266 226-164h-280l226 164z"/></svg>
                    <span class="hidden sm:inline">VIE</span>
                </button>
                <button id="langEN" class="lang-btn-slider relative w-1/2 p-2 rounded-full font-semibold z-10 flex items-center justify-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" class="w-5 h-5 rounded-sm"><clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath><path d="M0,0 v30 h60 v-30 z" fill="#00247d"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#cf142b" stroke-width="4"/><path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/><path d="M30,0 v30 M0,15 h60" stroke="#cf142b" stroke-width="6"/></svg>
                    <span class="hidden sm:inline">ENG</span>
                </button>
            </div>
            <button id="hamburgerBtn" class="md:hidden p-2 rounded-full hover:bg-black/10 focus:outline-none focus:ring-2 focus:ring-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>
    </header>

    <div id="mainContent" class="flex-grow min-h-0 relative mt-4 md:mt-6 mb-2"></div>
    
    <footer class="text-center py-4 text-gray-500 text-sm flex-shrink-0">
        Paint emotions with ColorLAB<br>by Sony Alpha Vietnam
    </footer>
</div>

<div id="infoTooltip" class="hidden"></div>

<div id="lightbox" class="hidden">
    <span id="lightboxClose">&times;</span>
    <img id="lightboxImage" src="" alt="Full size view">
</div>

<div id="mobileNavMenu" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 transform translate-x-full md:hidden">
    <div class="absolute top-0 right-0 h-full w-2/3 max-w-sm bg-white/80 backdrop-blur-xl shadow-2xl p-6">
        <button id="closeMobileNavBtn" class="absolute top-4 right-4 text-3xl p-2">&times;</button>
        <nav class="mt-16 flex flex-col gap-6 text-center">
            <button data-view="recipeFormulas" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navRecipeFormulas"></button>
        </nav>
    </div>
</div>

<!-- Quiz Modal -->
<div id="quizModal" class="modal hidden fixed inset-0 bg-black/30 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div id="quizPanel" class="modal-panel w-full max-w-3xl max-h-[90vh] flex flex-col view-transition rounded-2xl">
        <div class="flex justify-between items-center p-5 flex-shrink-0">
            <h2 class="text-xl font-bold" data-translate-key="quizTitle"></h2>
            <button id="closeQuizBtn" class="text-3xl font-light text-gray-400 hover:text-black">&times;</button>
        </div>
        <div id="quizContent" class="p-6 md:p-8 flex-grow overflow-y-auto sleek-scrollbar"></div>
        <div class="p-5 flex-shrink-0">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="quizProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Gemini AI Lab Modal -->
<div id="aiLabModal" class="modal hidden fixed inset-0 bg-black/30 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div id="aiLabPanel" class="modal-panel w-full max-w-4xl max-h-[90vh] flex flex-col view-transition rounded-2xl">
        <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0Zm12.25-3.625a.75.75 0 0 0-1.06-1.06l-1.592 1.591a.75.75 0 1 0 1.06 1.061l1.592-1.591ZM21 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75ZM17.81 17.81a.75.75 0 0 0-1.06-1.06l-1.591 1.592a.75.75 0 0 0 1.06 1.06l1.591-1.592ZM12 18.75a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V19.5a.75.75 0 0 1 .75-.75ZM4.19 17.81a.75.75 0 1 0-1.06-1.06l-1.591 1.592a.75.75 0 0 0 1.06 1.06l1.591-1.592ZM3 12a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0-1.5H3.75A.75.75 0 0 1 3 12ZM4.19 6.19a.75.75 0 0 0 1.06-1.06L3.657 3.536a.75.75 0 0 0-1.06 1.06l1.592 1.592Z" />
                    </svg>
                </div>
                 <h2 class="text-xl font-bold" data-translate-key="aiLabTitle"></h2>
            </div>
            <button id="closeAILabBtn" class="text-3xl font-light text-gray-400 hover:text-black">&times;</button>
        </div>
        <div id="aiLabContent" class="p-6 md:p-8 flex-grow overflow-y-auto sleek-scrollbar">
            <!-- AI Lab content will be rendered here -->
        </div>
    </div>
</div>

<!-- Caption AI Lab Modal -->
<div id="captionLabModal" class="modal hidden fixed inset-0 bg-black/30 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div id="captionLabPanel" class="modal-panel w-full max-w-2xl max-h-[90vh] flex flex-col view-transition rounded-2xl">
        <div class="flex justify-between items-center p-5 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center shadow-lg">
                     <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 3h9.75m-9.75 3h9.75M3 3h18M3 21h18a2.25 2.25 0 002.25-2.25V5.25A2.25 2.25 0 0021 3H3a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 003 21z" />
                    </svg>
                </div>
                 <h2 class="text-xl font-bold" data-translate-key="captionLabTitle"></h2>
            </div>
            <button id="closeCaptionLabBtn" class="text-3xl font-light text-gray-400 hover:text-black">&times;</button>
        </div>
        <div id="captionLabContent" class="p-6 md:p-8 flex-grow overflow-y-auto sleek-scrollbar">
            <!-- Caption AI Lab content will be rendered here -->
        </div>
    </div>
</div>


<script type="module">
// --- CONFIGURATION & STATE ---
const API_KEY = "AIzaSyDxctVkghoMzVFNTLbIfHmHQ_szw-omYbQ";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

const state = {
    currentLang: 'vi',
    currentView: 'home',
    selectedRecipeId: null,
    isMobileDetailActive: false,
    ai: {
        isGenerating: false,
        originalRecipe: null,
        userPrompt: '',
        expertPrompt: '',
        generatedRecipe: null,
        generationPromise: null,
        abortController: null,
    },
    captionAI: {
        isGenerating: false,
        recipe: null,
        userPrompt: '',
        generationPromise: null,
        abortController: null,
        result: null,
    },
    quiz: {
        currentQuestionIndex: 0,
        answers: [],
    }
};

const mainContentEl = document.getElementById('mainContent');

import recipesData from './recipes.js';
    
const quizQuestions = [
    {
        question: { vi: "Bạn sẽ chụp gì hôm nay?", en: "What will you be shooting today?" },
        options: [
            { tags: ['portrait', 'fine-art-portrait', 'nostalgic-portrait'], text: { vi: 'Chân dung', en: 'Portraits' }, icon: 'M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z' },
            { tags: ['landscape', 'travel', 'summer', 'golden-hour'], text: { vi: 'Phong cảnh', en: 'Landscape' }, icon: 'M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z' },
            { tags: ['urban-night', 'street-photography', 'city-lights'], text: { vi: 'Đô thị', en: 'Urban' }, icon: 'M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21M3 3h18v18H3V3z' },
            { tags: ['lifestyle', 'everyday', 'family-photos'], text: { vi: 'Đời thường', en: 'Lifestyle' }, icon: 'M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z' }
        ]
    },
    {
        question: { vi: "Tone màu chủ đạo bạn muốn?", en: "What's your preferred color tone?" },
        options: [
            { tags: ['warm', 'golden-hour', 'amber-tint'], text: { vi: 'Ấm', en: 'Warm' }, icon: 'M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z' },
            { tags: ['neutral', 'clean', 'balanced'], text: { vi: 'Trung tính', en: 'Neutral' }, icon: 'M10.5 6h9.75M10.5 6a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zM3.75 6H7.5m3 12h9.75m-9.75 0a2.25 2.25 0 10-4.5 0 2.25 2.25 0 004.5 0zM3.75 18H7.5m1.5-6h9.75m-9.75 0a2.25 2.25 0 10-4.5 0 2.25 2.25 0 004.5 0zM3.75 12H7.5' },
            { tags: ['cool-tone', 'deep-blues', 'cyan-teal'], text: { vi: 'Lạnh', en: 'Cool' }, icon: 'M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z' }
        ]
    },
    {
        question: { vi: "Kiểu tương phản bạn thích?", en: "How do you like your contrast?" },
        options: [
            { tags: ['high-contrast', 'dramatic', 'powerful'], text: { vi: 'Gắt', en: 'Punchy' }, icon: 'M12 21a9 9 0 100-18 9 9 0 000 18z' },
            { tags: ['normal', 'balanced', 'versatile'], text: { vi: 'Trung tính', en: 'Natural' }, icon: 'M12 3v18m9-9a9 9 0 00-18 0h18z' },
            { tags: ['soft-contrast', 'faded', 'lifted-blacks'], text: { vi: 'Nhẹ & Mờ', en: 'Soft & Faded' }, icon: 'M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
        ]
    },
    {
        question: { vi: "Độ bão hòa màu sắc?", en: "And saturation?" },
        options: [
            { tags: ['high-saturation', 'vibrant', 'super-saturated'], text: { vi: 'Đậm', en: 'Rich' }, icon: 'M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25z' },
            { tags: ['normal', 'moderate', 'natural'], text: { vi: 'Trung tính', en: 'Natural' }, icon: 'M12 7.5a4.5 4.5 0 100 9 4.5 4.5 0 000-9zM12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25z' },
            { tags: ['low-saturation', 'muted', 'faded'], text: { vi: 'Nhạt', en: 'Muted' }, icon: 'M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636' },
            { tags: ['bw'], text: { vi: 'Trắng & Đen', en: 'Black & White' }, icon: 'M12 3v18m9-9a9 9 0 00-18 0h18z' }
        ]
    }
];

const translations = {
    headerTitle: {vi: "Alpha AI Color Lab", en: "Alpha AI Color Lab"},
    navRecipeFormulas: {vi:"Công thức màu", en:"Color Recipes"},
    landingTitle: {vi:"Tìm kiếm<br>phong cách của bạn", en:"Find Your<br>Signature Style"},
    landingSubtitle: {vi:"Không chắc nên bắt đầu từ đâu?<br>Hãy để chúng tôi giúp bạn tìm công thức màu hoàn hảo.", en:"Not sure where to start?<br>Let us help you find the perfect color recipe."},
    startExploringBtn: {vi:"Khám phá tất cả", en:"Explore All Recipes"},
    findMyColorBtn: {vi: "Tìm màu cho bạn", en: "Find My Color"},
    quizTitle: {vi: "Trắc nghiệm Tìm màu", en: "Color Finder Quiz"},
    quizResultTitle: {vi: "Gợi ý cho bạn!", en: "Our Suggestion For You!"},
    quizResultDescription: {vi: "Dựa trên câu trả lời của bạn,<br>chúng tôi nghĩ bạn sẽ thích công thức này:", en: "Based on your answers,<br>we think you'll love this recipe:"},
    viewRecipeBtn: {vi: "Xem chi tiết công thức", en: "View Recipe Details"},
    retakeQuizBtn: {vi: "Làm lại trắc nghiệm", en: "Retake Quiz"},
    searchInputPlaceholder: {vi: "Tìm công thức...", en: "Search recipes..."},
    recipeDetailWelcomeTitle: {vi: "Thư viện màu<br>Tương tác", en: "Interactive<br>Color Library"},
    recipeDetailWelcomeText: {vi: "Khám phá các công thức màu Picture Profile một cách trực quan.<br>Nhấp vào một công thức trong danh sách để xem chi tiết.", en: "Explore Picture Profile color recipes visually.<br>Click a recipe in the list to see details."},
    whiteBalanceTitle: {vi: "Cân bằng trắng (WB)", en: "White Balance (WB)"},
    recipeSettingsTitle: {vi: "Cài đặt Chính", en: "Main Settings"},
    colorDepthTitle: {vi: "Độ sâu màu", en: "Color Depth"},
    detailTitle: {vi: "Chi tiết", en: "Detail"},
    sonyGuideBtn: {vi: "Xem tài liệu gốc từ Sony", en: "View Official Sony Guide"},
    backToListBtn: {vi: "← Quay lại danh sách", en: "← Back to list"},
    ctaTitle: {vi: "Chia sẻ tác phẩm của bạn!", en: "Share Your Creations!"},
    ctaText: {vi: "Yêu thích công thức này? Hãy chia sẻ ảnh của bạn lên group Facebook <b>Sony Alpha Vietnam | Official</b><br>với hashtag <b>#sonycolorlab</b> và {recipeHashtag} để có cơ hội được giới thiệu!", en: "Love this recipe? Share your photos on the <b>Sony Alpha Vietnam | Official</b> Facebook group<br>with hashtags <b>#sonycolorlab</b> and {recipeHashtag} for a chance to be featured!"},
    ctaButton: {vi: "Tham gia Nhóm", en: "Join The Group"},
    // AI Lab Translations
    aiLabTitle: {vi: "Gemini AI Colorist", en: "Gemini AI Colorist"},
    aiLabDescription: {vi: "Mô tả phong cách bạn muốn,<br>Gemini sẽ tinh chỉnh công thức màu <b>{recipeName}</b> cho bạn.", en: "Describe the style you want,<br>and Gemini will tweak the <b>{recipeName}</b> recipe for you."},
    aiPromptPlaceholder: {vi: "VD: tông màu trong trẻo, hơi ngả xanh như phim của Wes Anderson...", en: "E.g., a clean, slightly teal look like a Wes Anderson film..."},
    aiGenerateBtn: {vi: "Tinh chỉnh với AI", en: "Tweak with AI"},
    aiConfirmPromptTitle: {vi: "Xác nhận yêu cầu", en: "Confirm Request"},
    aiConfirmPromptText: {vi: "OK! Tôi sẽ tạo một phiên bản mới của <b>{recipeName}</b><br>với phong cách <i>\"{userPrompt}\"</i>. Tiếp tục nhé?", en: "Got it! I will generate a new version of <b>{recipeName}</b><br>with a style inspired by <i>\"{userPrompt}\"</i>. Shall we proceed?"},
    aiConfirmBtn: {vi: "Đồng ý", en: "Confirm & Generate"},
    aiCancelBtn: {vi: "Hủy", en: "Cancel"},
    aiComparisonTitle: {vi: "Kết quả từ Gemini AI", en: "Result from Gemini AI"},
    aiComparisonDescription: {vi: "Đây là phiên bản mới được tạo dựa trên yêu cầu của bạn.<br>Các thông số thay đổi đã được làm nổi bật.", en: "Here is the new version based on your request.<br>Changed parameters are highlighted."},
    aiOriginalTitle: {vi: "Công thức gốc", en: "Original Recipe"},
    aiNewTitle: {vi: "Công thức mới (AI)", en: "New Recipe (AI)"},
    aiErrorTitle: {vi: "Đã có lỗi xảy ra", en: "An Error Occurred"},
    aiErrorText: {vi: "Rất tiếc, không thể tạo công thức lúc này.<br>Vui lòng kiểm tra lại API Key hoặc thử lại sau.", en: "Sorry, the recipe could not be generated at this time.<br>Please check your API Key or try again later."},
    tweakWithAI: {vi: "Tinh chỉnh với Gemini AI", en: "Tweak with Gemini AI"},
    // Caption AI Translations
    captionLabTitle: {vi: "Trợ lý Caption Viral", en: "Viral Caption Assistant"},
    captionLabDescription: {vi: "Nhập ý tưởng cho bài đăng của bạn.<br>AI sẽ giúp bạn viết một caption thật 'chất' theo phong cách màu <b>{recipeName}</b>.", en: "Enter an idea for your post.<br>AI will help you write a captivating caption in the <b>{recipeName}</b> color style."},
    captionPromptPlaceholder: {vi: "VD: một buổi chiều hoàng hôn ở Đà Lạt...", en: "E.g., a sunset afternoon in Dalat..."},
    generateCaptionBtn: {vi: "Tạo Caption", en: "Generate Caption"},
    captionResultTitle: {vi: "Gợi ý từ AI", en: "Suggestion from AI"},
    copyBtn: {vi: "Sao chép", en: "Copy"},
    copiedBtn: {vi: "Đã sao chép!", en: "Copied!"},
    captionFromAI: { vi: "Tạo Caption Viral", en: "Viral Caption AI" }
};

const parameterExplanations = {
    'Black level': { vi: "Điều chỉnh điểm đen. Giá trị âm (-) làm vùng tối sâu hơn, tăng tương phản.<br>Giá trị dương (+) nâng vùng tối, tạo hiệu ứng 'mờ' hoài cổ.", en: "Adjusts the black point. Negative (-) values deepen shadows for more contrast.<br>Positive (+) values lift shadows for a 'faded' look." },
    'Gamma': { vi: "Xác định đường cong tương phản tổng thể, là nền tảng cho 'look' của bạn.<br>Cine & S-Cinetone cho cảm giác điện ảnh, trong khi S-Log tối đa hóa dải tần nhạy sáng để hậu kỳ.", en: "Defines the overall contrast curve, the foundation of your look.<br>Cine & S-Cinetone provide a cinematic feel, while S-Log maximizes dynamic range for post-production." },
    'Black Gamma': { vi: "Tinh chỉnh độ tương phản riêng trong vùng tối.<br>'Range' xác định vùng ảnh hưởng (Hẹp/Vừa/Rộng). 'Level' tăng hoặc giảm độ sáng của vùng đó.", en: "Fine-tunes contrast specifically in the shadow areas.<br>'Range' sets the affected area (Narrow/Middle/Wide). 'Level' brightens or darkens that area." },
    'Knee': { vi: "Kiểm soát cách các vùng sáng (highlight) được nén lại để tránh bị 'cháy sáng'.<br>Chế độ Tự động hoạt động tốt, trong khi Thủ công cho phép kiểm soát chính xác hơn.", en: "Controls how highlights are compressed to prevent 'clipping' (overexposure).<br>Auto mode works well; Manual mode offers precise control." },
    'Color Mode': { vi: "Xác định không gian màu và cách màu sắc được tái tạo.<br>Nên chọn chế độ phù hợp với Gamma đã chọn (ví dụ: S-Cinetone, S-Gamut3.Cine).", en: "Determines the color space and how colors are rendered.<br>Should be matched with the chosen Gamma (e.g., S-Cinetone, S-Gamut3.Cine)." },
    'Saturation': { vi: "Điều chỉnh cường độ tổng thể của tất cả các màu.<br>Tăng để có màu rực rỡ, giảm để có màu dịu hơn hoặc đơn sắc.", en: "Adjusts the overall intensity of all colors.<br>Increase for vibrant colors, decrease for a more muted or monochrome look." },
    'Color Phase': { vi: "Dịch chuyển nhẹ toàn bộ quang phổ màu về phía đỏ hoặc xanh lá.<br>Hữu ích để tinh chỉnh tông màu tổng thể hoặc cân bằng màu giữa các máy ảnh.", en: "Slightly shifts the entire color spectrum towards red or green.<br>Useful for subtle global tone adjustments or matching cameras." },
    'Color Depth': { vi: "Công cụ mạnh nhất.<br>Tăng/giảm độ sáng của từng kênh màu riêng lẻ (Đỏ, Lục, Lam, Cyan, Magenta, Vàng) để tinh chỉnh màu sắc một cách chính xác.", en: "The most powerful tool.<br>Brightens or darkens individual color channels (R, G, B, C, M, Y) for precise color tuning." },
    'R': { vi: "Điều chỉnh độ sáng (luminance) của kênh màu Đỏ.<br>Tăng (+) để màu đỏ tối và đậm hơn (son môi, da). Giảm (-) để sáng và nhạt hơn.", en: "Adjusts the luminance of the Red channel.<br>Increase (+) for darker, richer reds (lipstick, skin). Decrease (-) for lighter, paler reds." },
    'G': { vi: "Điều chỉnh độ sáng (luminance) của kênh màu Lục.<br>Tăng (+) để màu xanh lá cây tối và đậm hơn (cây cỏ). Giảm (-) để sáng và nhạt hơn.", en: "Adjusts the luminance of the Green channel.<br>Increase (+) for darker, richer greens (foliage). Decrease (-) for lighter, paler greens." },
    'B': { vi: "Điều chỉnh độ sáng (luminance) của kênh màu Lam.<br>Tăng (+) để màu xanh dương tối và đậm hơn (quần áo, đường phố). Giảm (-) để sáng và nhạt hơn.", en: "Adjusts the luminance of the Blue channel.<br>Increase (+) for darker, richer blues (clothing, streets). Decrease (-) for lighter, paler blues." },
    'C': { vi: "Điều chỉnh độ sáng (luminance) của kênh màu Lục lam.<br>Tăng (+) để màu da trời tối và đậm hơn. Giảm (-) để sáng và nhạt hơn.", en: "Adjusts the luminance of the Cyan channel.<br>Increase (+) for darker, richer cyan (sky). Decrease (-) for lighter, paler cyan." },
    'M': { vi: "Điều chỉnh độ sáng (luminance) của kênh màu Cánh sen.<br>Tăng (+) để màu hồng/tím tối và đậm hơn (da người, son môi). Giảm (-) để sáng và nhạt hơn.", en: "Adjusts the luminance of the Magenta channel.<br>Increase (+) for darker, richer magenta (skin tones, lipstick). Decrease (-) for lighter, paler magenta." },
    'Y': { vi: "Điều chỉnh độ sáng (luminance) của kênh màu Vàng.<br>Tăng (+) để màu vàng tối và đậm hơn (da người Á Đông). Giảm (-) để sáng và nhạt hơn.", en: "Adjusts the luminance of the Yellow channel.<br>Increase (+) for darker, richer yellows (Asian skin tones). Decrease (-) for lighter, paler yellows." },
    'Detail': { vi: "Kiểm soát độ sắc nét của hình ảnh.<br>Giảm mạnh (ví dụ: -7) để có 'look' mềm mại, giống phim. Tăng để có hình ảnh sắc nét, hiện đại.", en: "Controls image sharpening.<br>Decrease significantly (e.g., -7) for a soft, filmic look. Increase for a crisp, modern image." },
    'Level': { vi: "Điều chỉnh mức độ sắc nét tổng thể. Máy ảnh Sony vốn đã rất nét.<br>Giảm để ảnh mềm mại hơn (-7 để giả lập chất ảnh phim), hoặc tăng để nét hơn nữa.", en: "Adjusts the overall sharpening level. Sony cameras are inherently sharp.<br>Decrease for a softer look (-7 mimics film), or increase for even more sharpness."}
};

// --- UI & LOGIC FUNCTIONS ---
function t(key) { return translations[key]?.[state.currentLang] || key; }

function applyTranslations() {
    document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.dataset.translateKey;
        if (translations[key]?.[state.currentLang]) {
            const element = el;
            if (element.placeholder !== undefined) element.placeholder = t(key);
            else element.innerHTML = t(key);
        }
    });
}

function createFullRecipeHTML(recipe) {
    const createCollageHTML = (images) => {
        if (!images || images.length === 0) return '';
        const count = Math.min(images.length, 6);
        const imageElements = images.slice(0, count).map(img => 
            `<div class="collage-item" data-lightbox-src="${img}">
                <img src="${img}" onerror="this.onerror=null;this.src='https://placehold.co/800x600/e2e8f0/475569?text=Image+Not+Found';" alt="Recipe demo image">
            </div>`
        ).join('');
        return `<div class="photo-collage images-${count} mb-8">${imageElements}</div>`;
    };

    const createCTAHTML = (recipe) => {
        const recipeHashtag = `#${recipe.id.replace(/-/g, '')}`;
        const ctaText = t('ctaText').replace('{recipeHashtag}', `<b class="font-semibold text-blue-900">${recipeHashtag}</b>`);
        return `<div class="mt-8 p-5 md:p-6 bg-blue-50 border border-blue-200/50 rounded-2xl text-center"><h4 class="text-lg md:text-xl font-bold text-blue-800" data-translate-key="ctaTitle"></h4><p class="mt-2 text-blue-700/90 max-w-2xl mx-auto text-sm md:text-base">${ctaText}</p><a href="https://www.facebook.com/groups/sonyalphavietnamoffical" target="_blank" rel="noopener noreferrer" class="btn btn-primary mt-5 py-2.5 px-6 bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M12.225 10.162c.37.312.525.812.375 1.312l-.75 2.5a1 1 0 01-1.85.375l-1.375-3.562a1 1 0 01.375-1.125l2.5-2.062a1 1 0 011.375 1.562l-1.5 1.25 2.375 1.125zM10 18a8 8 0 100-16 8 8 0 000 16z"/></svg><span data-translate-key="ctaButton"></span></a></div>`;
    };
    
    const createSettingsGrid = (settings, compareSettings = null) => {
        if (!settings) return '';
        return Object.entries(settings).map(([key, value]) => {
            const explanationKey = Object.keys(parameterExplanations).find(k => k.toLowerCase() === key.toLowerCase().trim());
            const isChanged = compareSettings && settings[key] !== compareSettings[key];
            return `<div class="flex flex-col p-4 bg-white/50 rounded-xl ${isChanged ? 'changed' : ''}"><div class="flex items-center gap-1.5"><span class="parameter-title text-sm text-gray-500 font-medium" data-param-key="${explanationKey || ''}">${key}</span></div><span class="font-semibold text-xl text-gray-800 mt-1">${value}</span></div>`;
        }).join('');
    };

    const sections = [
        { titleKey: 'whiteBalanceTitle', content: `<div class="p-4 bg-white/50 rounded-xl"><p class="font-semibold text-xl text-gray-800">${recipe.whiteBalance || ''}</p></div>` },
        { titleKey: 'recipeSettingsTitle', content: `<div class="grid grid-cols-2 md:grid-cols-3 gap-3">${createSettingsGrid(recipe.settings)}</div>` },
        recipe.colorDepth ? { titleKey: 'colorDepthTitle', content: `<div class="grid grid-cols-3 md:grid-cols-6 gap-3">${createSettingsGrid(recipe.colorDepth)}</div>` } : null,
        recipe.detailSettings ? { titleKey: 'detailTitle', content: `<div class="grid grid-cols-2 md:grid-cols-3 gap-3">${createSettingsGrid(recipe.detailSettings)}</div>` } : null
    ].filter(Boolean);
    
    return `
        ${createCollageHTML(recipe.demoImages)}
        <div class="mt-8 pt-8 border-t border-gray-200 flex flex-col sm:flex-row flex-wrap gap-4 justify-center">
            <button class="btn btn-primary py-3 px-6" id="tweakWithAIBtn" data-recipe-id="${recipe.id}">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span data-translate-key="tweakWithAI"></span>
            </button>
            <button class="btn bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 shadow-lg shadow-purple-500/30" id="captionAIBtn" data-recipe-id="${recipe.id}">
                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 3h9.75m-9.75 3h9.75M3 3h18M3 21h18a2.25 2.25 0 002.25-2.25V5.25A2.25 2.25 0 0021 3H3a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 003 21z" /></svg>
                <span data-translate-key="captionFromAI"></span>
            </button>
            <a href="https://helpguide.sony.net/di/pp/v1/en/contents/TP0000909106.html" target="_blank" rel="noopener noreferrer" class="btn bg-gray-700 hover:bg-gray-800 text-white py-3 px-6 shadow-lg shadow-gray-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10.392C2.057 15.71 3.245 16 4.5 16s2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10.392c1.057.514 2.245.804 3.5.804s2.443-.29 3.5-.804V4.804C16.943 4.29 15.755 4 14.5 4z"></path>
                </svg>
                <span data-translate-key="sonyGuideBtn"></span>
            </a>
        </div>
        ${createCTAHTML(recipe)}
        <div class="space-y-8 mt-8">
            ${sections.map(section => `<div><h4 class="text-xl font-bold mb-3 text-gray-700" data-translate-key="${section.titleKey}"></h4><div class="p-4 bg-gray-500/5 rounded-2xl">${section.content}</div></div>`).join('')}
        </div>
    `;
}

const viewTemplates = {
    home: () => `<div id="homeView" class="w-full h-full flex flex-col items-center justify-center text-center absolute inset-0 view-transition p-4">
                            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-800 mb-2 mt-8" data-translate-key="landingTitle"></h1>
                            <p class="text-lg md:text-xl text-slate-600 max-w-2xl mx-auto" data-translate-key="landingSubtitle"></p>
                            <div class="flex flex-col sm:flex-row gap-4 mt-10">
                                <button id="startQuizBtn" class="btn btn-primary py-4 px-10 text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                    <span data-translate-key="findMyColorBtn"></span>
                                </button>
                                <button data-view="recipeFormulas" class="nav-btn btn bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 py-4 px-10 text-lg" data-translate-key="startExploringBtn"></button>
                            </div>
                        </div>`,
    recipeFormulas: () => `
                                <div id="recipeFormulasView" class="w-full h-full flex flex-col md:flex-row gap-6 absolute inset-0 view-transition">
                                    <aside id="recipeListPanel" class="w-full md:w-1/3 lg:w-[30%] xl:w-1/4 glass-panel p-4 md:p-6 flex flex-col flex-shrink-0 md:flex">
                                        <div class="relative mb-4 flex-shrink-0">
                                            <input type="search" id="searchInput" class="w-full p-3 pl-4 pr-12 rounded-xl bg-gray-200/50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all" data-translate-key="searchInputPlaceholder">
                                            <button id="quizShortcutBtn" class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-500 hover:text-blue-500" title="Find My Color Quiz">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                            </button>
                                        </div>
                                        <div id="recipeListContainer" class="space-y-2 flex-grow overflow-y-auto sleek-scrollbar pr-2 -mr-2"></div>
                                    </aside>
                                    <main id="recipeMainPanel" class="w-full md:w-2/3 lg:w-[70%] xl:w-3/4 flex-col min-h-0 hidden md:flex">
                                        <div class="glass-panel flex-grow overflow-y-auto p-6 lg:p-10 sleek-scrollbar">
                                            <div id="chartsContainer" class="flex flex-col items-center justify-center h-full">
                                                <div class="text-center mb-10"><h2 class="text-2xl md:text-3xl font-bold text-gray-700" data-translate-key="recipeDetailWelcomeTitle"></h2><p class="text-neutral-500 mt-2 max-w-xl mx-auto" data-translate-key="recipeDetailWelcomeText"></p></div>
                                            </div>
                                            <div id="recipeContent" class="hidden"></div>
                                        </div>
                                    </main>
                                    <div id="recipeDetailPanelMobile" class="w-full h-full absolute inset-0 bg-[#f8f9fa] p-4 overflow-y-auto hidden">
                                        <button id="backToListBtn" class="btn bg-white/80 border border-gray-200 text-gray-800 mb-4 py-2 px-4" data-translate-key="backToListBtn"></button>
                                        <div class="glass-panel p-6 overflow-y-auto sleek-scrollbar"><div id="recipeContentMobile"></div></div>
                                    </div>
                                </div>`,
};

// --- QUIZ LOGIC ---
function startQuiz() {
    state.quiz.currentQuestionIndex = 0;
    state.quiz.answers = [];
    document.getElementById('quizModal').classList.remove('hidden');
    renderQuizQuestion();
}

function closeQuiz() { document.getElementById('quizModal').classList.add('hidden'); }

function renderQuizQuestion() {
    const quizContent = document.getElementById('quizContent');
    const progressBar = document.getElementById('quizProgressBar');
    const qIndex = state.quiz.currentQuestionIndex;

    const render = () => {
        if (qIndex >= quizQuestions.length) {
            calculateAndShowQuizResult();
            return;
        }
        const questionData = quizQuestions[qIndex];
        const hasThreeOptions = questionData.options.length === 3;
        const gridClass = `quiz-options-grid ${hasThreeOptions ? 'has-three-options' : ''}`;

        quizContent.innerHTML = `
            <div class="quiz-question-container">
                <h3 class="text-2xl md:text-3xl font-semibold text-center mb-8">${questionData.question[state.currentLang]}</h3>
                <div class="${gridClass}">
                    ${questionData.options.map(opt => `
                        <button class="quiz-option w-full text-left p-4 rounded-2xl flex items-center gap-4" data-tags="${opt.tags.join(',')}">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-sm flex-shrink-0 border">
                                <svg class="w-6 h-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="${opt.icon}" />
                                </svg>
                            </div>
                            <span class="font-semibold text-lg text-gray-800">${opt.text[state.currentLang]}</span>
                        </button>
                    `).join('')}
                </div>
            </div>`;
        progressBar.style.width = `${((qIndex) / quizQuestions.length) * 100}%`;
    };

    const container = quizContent.querySelector('.quiz-question-container');
    if (container) {
        container.classList.add('exiting');
        setTimeout(() => { render(); }, 150);
    } else {
        render();
    }
}

function handleQuizAnswer(e) {
    const selectedOption = e.target.closest('.quiz-option');
    if (!selectedOption) return;
    document.querySelectorAll('.quiz-option').forEach(btn => btn.classList.remove('selected'));
    selectedOption.classList.add('selected');
    const tags = selectedOption.dataset.tags.split(',');
    state.quiz.answers.push(...tags);
    setTimeout(() => { state.quiz.currentQuestionIndex++; renderQuizQuestion(); }, 300);
}

function calculateAndShowQuizResult() {
    const scores = recipesData.map(recipe => {
        let score = 0;
        score += recipe.tags.reduce((acc, tag) => acc + (state.quiz.answers.includes(tag) ? 1 : 0), 0);
        if (state.quiz.answers.includes('bw') && recipe.type === 'bw') { score += 2; }
        return { id: recipe.id, score: score };
    });
    scores.sort((a, b) => b.score - a.score);
    const bestMatch = recipesData.find(r => r.id === scores[0].id);
    const quizContent = document.getElementById('quizContent');
    document.getElementById('quizProgressBar').style.width = '100%';
    quizContent.innerHTML = `<div class="text-center view-transition"><h3 class="text-2xl font-bold" data-translate-key="quizResultTitle"></h3><p class="mt-2 text-gray-600" data-translate-key="quizResultDescription"></p><div class="my-8 p-6 bg-gray-100 rounded-2xl border flex flex-col sm:flex-row items-center gap-6"><img src="${bestMatch.demoImages[0]}" class="w-full sm:w-48 h-32 rounded-lg object-cover shadow-lg" alt="Preview"><div class="text-left"><h4 class="text-xl font-bold">${bestMatch.name[state.currentLang]}</h4><p class="text-gray-600 mt-1">${bestMatch.description[state.currentLang]}</p></div></div><div class="flex flex-col sm:flex-row gap-4 justify-center"><button id="viewResultBtn" data-recipe-id="${bestMatch.id}" class="btn btn-primary py-3 px-8 text-base"><span data-translate-key="viewRecipeBtn"></span></button><button id="retakeQuizBtn" class="btn bg-gray-200 text-gray-800 py-3 px-8 text-base"><span data-translate-key="retakeQuizBtn"></span></button></div></div>`;
    applyTranslations();
}

// --- GEMINI AI LAB LOGIC ---
function openAILab(recipeId) {
    state.ai.originalRecipe = recipesData.find(r => r.id === recipeId);
    if (!state.ai.originalRecipe) return;

    Object.assign(state.ai, {
        generatedRecipe: null,
        userPrompt: '',
        expertPrompt: '',
        generationPromise: null,
        abortController: state.ai.abortController ? (state.ai.abortController.abort(), null) : null
    });
    
    document.getElementById('aiLabModal').classList.remove('hidden');
    renderAILab();
}

function closeAILab() {
    if (state.ai.abortController) {
        state.ai.abortController.abort();
    }
    document.getElementById('aiLabModal').classList.add('hidden');
}

function renderAILab() {
    const contentEl = document.getElementById('aiLabContent');
    if (!contentEl) return;

    if (state.ai.isGenerating) {
        contentEl.innerHTML = `<div class="flex flex-col items-center justify-center h-64"><div class="loader"></div><p class="mt-4 text-gray-600">Gemini is thinking...</p></div>`;
        return;
    }

    if (state.ai.generatedRecipe) {
        renderAIComparison(contentEl);
        return;
    }

    if (state.ai.expertPrompt) {
        renderAIConfirmation(contentEl);
        return;
    }
    
    renderAIPromptInput(contentEl);
    applyTranslations();
}

function renderAIPromptInput(container) {
    const recipeName = state.ai.originalRecipe.name[state.currentLang];
    container.innerHTML = `
        <p class="text-lg text-gray-600 text-center">${t('aiLabDescription').replace('{recipeName}', `<b>${recipeName}</b>`)}</p>
        <textarea id="aiPromptInput" class="w-full mt-4 p-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all min-h-[100px]" placeholder="${t('aiPromptPlaceholder')}"></textarea>
        <div class="mt-6 text-center">
            <button id="generateAIBtn" class="btn btn-primary py-3 px-8 text-lg">
                <span data-translate-key="aiGenerateBtn"></span>
            </button>
        </div>
    `;
}

function renderAIConfirmation(container) {
    const recipeName = state.ai.originalRecipe.name[state.currentLang];
    const confirmText = t('aiConfirmPromptText')
        .replace('{recipeName}', `<b>${recipeName}</b>`)
        .replace('{userPrompt}', state.ai.userPrompt);

    container.innerHTML = `
        <div class="text-center p-4 bg-blue-50 rounded-lg">
            <h3 class="text-xl font-bold" data-translate-key="aiConfirmPromptTitle"></h3>
            <p class="mt-3 text-lg text-gray-700">${confirmText}</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="cancelAIBtn" class="btn bg-gray-200 text-gray-800 py-2 px-6" data-translate-key="aiCancelBtn"></button>
                <button id="confirmAIBtn" class="btn btn-primary py-2 px-6" data-translate-key="aiConfirmBtn"></button>
            </div>
        </div>
    `;
    applyTranslations();
}

function renderAIComparison(container) {
    const original = state.ai.originalRecipe;
    const generated = state.ai.generatedRecipe;

    const createComparisonGrid = (titleKey, originalSettings, generatedSettings) => {
        if (!originalSettings || !generatedSettings) return '';
        const allKeys = Object.keys(originalSettings);
        const gridItems = allKeys.map(key => {
            const originalValue = originalSettings[key];
            const generatedValue = generatedSettings[key];
            const isChanged = originalValue !== generatedValue;
            return `
                <div class="flex flex-col p-3 rounded-lg ${isChanged ? 'bg-blue-100/50 border border-blue-200' : 'bg-gray-100/70'}">
                    <span class="text-sm text-gray-500 font-medium">${key}</span>
                    <div class="flex items-baseline gap-2 mt-1">
                        <span class="font-semibold text-lg ${isChanged ? 'text-blue-700' : 'text-gray-800'}">${generatedValue}</span>
                        ${isChanged ? `<span class="text-xs text-gray-500 line-through">${originalValue}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        return `<div><h4 class="text-lg font-bold mb-3 text-gray-700" data-translate-key="${titleKey}"></h4><div class="grid grid-cols-2 md:grid-cols-3 gap-3">${gridItems}</div></div>`;
    };

    container.innerHTML = `
        <div class="text-center">
            <h3 class="text-2xl font-bold" data-translate-key="aiComparisonTitle"></h3>
            <p class="mt-1 text-gray-600" data-translate-key="aiComparisonDescription"></p>
        </div>
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Original Recipe Column -->
            <div class="border border-gray-200 rounded-xl p-4">
                <h4 class="text-xl font-bold text-center" data-translate-key="aiOriginalTitle"></h4>
                <p class="text-center text-gray-500">${original.name[state.currentLang]}</p>
            </div>
            <!-- New Recipe Column -->
            <div class="border-2 border-blue-500 rounded-xl p-4 bg-white shadow-lg">
                <h4 class="text-xl font-bold text-center text-blue-600" data-translate-key="aiNewTitle"></h4>
                <p class="text-center text-gray-500">${generated.name[state.currentLang]}</p>
            </div>
        </div>
        <div class="mt-6 space-y-6">
            ${createComparisonGrid('recipeSettingsTitle', original.settings, generated.settings)}
            ${original.colorDepth ? createComparisonGrid('colorDepthTitle', original.colorDepth, generated.colorDepth) : ''}
        </div>
    `;
    applyTranslations();
}

function renderAIError(container, feature = 'ai') {
    const errorTextKey = feature === 'caption' ? 'aiErrorText' : 'aiErrorText';
    container.innerHTML = `
        <div class="text-center p-4 bg-red-50 border border-red-200 rounded-lg">
            <h3 class="text-xl font-bold text-red-800" data-translate-key="aiErrorTitle"></h3>
            <p class="mt-2 text-red-700" data-translate-key="${errorTextKey}"></p>
        </div>
    `;
    applyTranslations();
}

function handleAIGeneration() {
    const userInput = document.getElementById('aiPromptInput').value.trim();
    if (!userInput) return;
    
    state.ai.userPrompt = userInput;
    state.ai.expertPrompt = `As a professional colorist specializing in Sony Picture Profiles, analyze the following JSON object which represents an existing color recipe. Your task is to generate a new, modified JSON object based on the user's request: "${userInput}". The new JSON must be a complete, valid recipe object. You must only respond with the raw JSON object, without any surrounding text, explanations, or markdown formatting. The generated recipe name and description must be in the same language as the user's prompt (${state.currentLang}). Original recipe: ${JSON.stringify(state.ai.originalRecipe)}`;
    
    renderAILab(); 

    const abortController = new AbortController();
    state.ai.abortController = abortController;
    
    const payload = {
        contents: [{ parts: [{ text: state.ai.expertPrompt }] }],
        generationConfig: {
            responseMimeType: "application/json",
        }
    };

    state.ai.generationPromise = fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        signal: abortController.signal
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(`API Error: ${response.status} ${text}`) });
        }
        return response.json();
    })
    .then(result => {
        if (!result.candidates?.[0]?.content?.parts?.[0]) {
            throw new Error("Invalid API response structure.");
        }
        const jsonText = result.candidates[0].content.parts[0].text;
        return JSON.parse(jsonText);
    });
}

async function confirmAndCallAI() {
    state.ai.isGenerating = true;
    renderAILab(); 

    try {
        const generatedRecipe = await state.ai.generationPromise;
        state.ai.generatedRecipe = generatedRecipe;

    } catch (error) {
        if (error.name === 'AbortError') {
            console.log('Fetch aborted by user.');
            return;
        }
        console.error("Gemini API call failed:", error);
        renderAIError(document.getElementById('aiLabContent'));
    } finally {
        state.ai.isGenerating = false;
        state.ai.expertPrompt = '';
        state.ai.generationPromise = null;
        state.ai.abortController = null;
        if (state.ai.generatedRecipe) {
            renderAILab();
        }
    }
}

// --- CAPTION AI LOGIC ---
function openCaptionLab(recipeId) {
    const recipe = recipesData.find(r => r.id === recipeId);
    if (!recipe) return;

    Object.assign(state.captionAI, {
        recipe: recipe,
        isGenerating: false,
        userPrompt: '',
        generationPromise: null,
        abortController: null,
        result: null,
    });
    
    document.getElementById('captionLabModal').classList.remove('hidden');
    renderCaptionLab();
}

function closeCaptionLab() {
    if (state.captionAI.abortController) {
        state.captionAI.abortController.abort();
    }
    document.getElementById('captionLabModal').classList.add('hidden');
}

function renderCaptionLab() {
    const contentEl = document.getElementById('captionLabContent');
    if (!contentEl) return;

    if (state.captionAI.isGenerating) {
        contentEl.innerHTML = `<div class="flex flex-col items-center justify-center h-64"><div class="loader"></div><p class="mt-4 text-gray-600">Gemini is thinking...</p></div>`;
        return;
    }

    if (state.captionAI.result) {
        const { caption, hashtags } = state.captionAI.result;
        contentEl.innerHTML = `
            <h3 class="text-xl font-bold text-center" data-translate-key="captionResultTitle"></h3>
            <div class="mt-4 p-4 bg-gray-50 border rounded-lg">
                <p id="caption-text" class="text-gray-800 whitespace-pre-wrap">${caption}</p>
                <p id="hashtags-text" class="mt-3 text-purple-700 font-semibold">${hashtags}</p>
            </div>
            <div class="mt-4 flex gap-2 justify-end">
                 <button class="btn bg-gray-200 text-gray-800 py-2 px-4" data-copy-target="hashtags-text">
                     <span data-translate-key="copyBtn"></span> Hashtags
                 </button>
                 <button class="btn btn-primary py-2 px-4" data-copy-target="caption-text">
                     <span data-translate-key="copyBtn"></span> Caption
                 </button>
            </div>
        `;
    } else {
        const recipeName = state.captionAI.recipe.name[state.currentLang];
        contentEl.innerHTML = `
            <p class="text-base text-gray-600 text-center">${t('captionLabDescription').replace('{recipeName}', `<b>${recipeName}</b>`)}</p>
            <textarea id="captionPromptInput" class="w-full mt-4 p-3 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all min-h-[80px]" placeholder="${t('captionPromptPlaceholder')}"></textarea>
            <div class="mt-6 text-center">
                <button id="generateCaptionBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white py-3 px-8 text-lg">
                    <span data-translate-key="generateCaptionBtn"></span>
                </button>
            </div>
        `;
    }
    applyTranslations();
}

async function handleCaptionGeneration() {
    const userInput = document.getElementById('captionPromptInput').value.trim();
    if (!userInput) return;

    state.captionAI.userPrompt = userInput;
    state.captionAI.isGenerating = true;
    renderCaptionLab();

    const { recipe } = state.captionAI;
    const recipeHashtag = `#${recipe.id.replace(/-/g, '')}${recipe.name.en.split(': ')[1].replace(/\s/g, '')}`;
    const prompt = `You are a witty, trendy, and creative social media expert for Sony Alpha Vietnam, specializing in Gen Z vocabulary and viral content. Your task is to generate a compelling social media post.
**CRITICAL RULES:**
1.  **Mandatory Hashtags:** The final hashtag string MUST include '#sonycolorlab', '#sonyalphavietnam', and '${recipeHashtag}'. This is non-negotiable.
2.  **Tone & Style:** The caption's tone must be creative, subtle, sophisticated, and potentially humorous. Use trendy Vietnamese Gen Z slang and phrasing to make it highly shareable and viral.
3.  **Language:** The entire response (caption and hashtags) MUST be in the same language as the User's Idea, which is: ${state.currentLang}.

**CONTEXT:**
* **Photographic Style:** "${recipe.name[state.currentLang]}" - This style is known for: "${recipe.description[state.currentLang]}".
* **User's Idea:** "${userInput}"

**TASK:**
Based on all the rules and context, generate a caption and a set of hashtags.

**OUTPUT FORMAT:**
You must respond with only a single, valid JSON object with two keys: "caption" (string) and "hashtags" (string).`;

    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { responseMimeType: "application/json" }
    };

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const result = await response.json();
        const jsonText = result.candidates[0].content.parts[0].text;
        state.captionAI.result = JSON.parse(jsonText);
    } catch (error) {
        console.error("Caption AI call failed:", error);
        renderAIError(document.getElementById('captionLabContent'), 'caption');
    } finally {
        state.captionAI.isGenerating = false;
        if (state.captionAI.result) {
            renderCaptionLab();
        }
    }
}


// --- CORE APP LOGIC ---
function renderView(viewName, selectedId = null) {
    state.currentView = viewName;
    if (selectedId) { state.selectedRecipeId = selectedId; }

    // Logic để ẩn/hiện footer
    const footerEl = document.querySelector('footer');
    if (footerEl) {
        // Thêm hoặc xóa class 'hidden' của Tailwind dựa trên view hiện tại
        footerEl.classList.toggle('hidden', viewName === 'recipeFormulas');
    }

    return new Promise(resolve => {
        const currentContent = mainContentEl.children[0];
        if (currentContent) {
            currentContent.classList.add('view-transition-out');
            currentContent.addEventListener('animationend', () => {
                mainContentEl.innerHTML = viewTemplates[viewName]();
                attachViewEventListeners(viewName);
                applyTranslations();
                resolve();
            }, { once: true });
        } else {
            mainContentEl.innerHTML = viewTemplates[viewName]();
            attachViewEventListeners(viewName);
            applyTranslations();
            resolve();
        }
    });
}

function handleRecipeSelection(id) {
    state.selectedRecipeId = (state.selectedRecipeId === id) ? null : id;
    state.isMobileDetailActive = !!state.selectedRecipeId;
    renderLibraryList();
    renderLibraryDetails();
}

function updateLangSlider() {
    const glider = document.getElementById('lang-glider');
    const langVI = document.getElementById('langVI');
    const langEN = document.getElementById('langEN');
    if (!glider || !langVI || !langEN) return;
    langVI.classList.toggle('text-blue-600', state.currentLang === 'vi');
    langVI.classList.toggle('text-gray-500', state.currentLang !== 'vi');
    langEN.classList.toggle('text-blue-600', state.currentLang === 'en');
    langEN.classList.toggle('text-gray-500', state.currentLang !== 'en');
    glider.style.transform = state.currentLang === 'vi' ? 'translateX(0%)' : 'translateX(100%)';
}

function attachViewEventListeners(viewName) {
    if (viewName === 'recipeFormulas') {
        renderLibraryList();  
        renderLibraryDetails();
        updateLangSlider();
    }
}

function renderLibraryList() {
    const container = document.getElementById('recipeListContainer'); if (!container) return;
    const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
    const recipesToRender = recipesData.filter(r => r.name[state.currentLang].toLowerCase().includes(searchTerm) || r.description[state.currentLang].toLowerCase().includes(searchTerm));
    container.innerHTML = recipesToRender.map(recipe => {
        const isSelected = recipe.id === state.selectedRecipeId;
        const borderColor = isSelected ? recipe.personalityColor : 'transparent';
        return `<div class="recipe-item p-3 rounded-xl transition-all duration-200 border-l-4 cursor-pointer ${isSelected ? 'selected' : ''}" style="border-left-color: ${borderColor};" data-recipe-id="${recipe.id}">
            <span class="font-semibold text-primary">${recipe.name[state.currentLang]}</span>
            <p class="text-sm text-neutral-600 mt-1 leading-snug">${recipe.description[state.currentLang]}</p>
        </div>`;
    }).join('');
}

function renderLibraryDetails() {
    const isMobile = window.innerWidth < 768;
    const recipeListPanel = document.getElementById('recipeListPanel');
    const recipeMainPanel = document.getElementById('recipeMainPanel');
    const recipeDetailPanelMobile = document.getElementById('recipeDetailPanelMobile');

    if (isMobile) {
        recipeListPanel.classList.toggle('hidden', state.isMobileDetailActive);
        recipeDetailPanelMobile.classList.toggle('hidden', !state.isMobileDetailActive);
    } else {
        recipeListPanel?.classList.remove('hidden');
        recipeDetailPanelMobile?.classList.add('hidden');
    }

    const recipe = recipesData.find(r => r.id === state.selectedRecipeId);
    let recipeContentContainer = isMobile && state.isMobileDetailActive ? document.getElementById('recipeContentMobile') : document.getElementById('recipeContent');
    let chartsContainer = document.getElementById('chartsContainer');
    if (!recipeContentContainer) return;

    if (!recipe) {  
        if (chartsContainer) chartsContainer.classList.remove('hidden');
        recipeContentContainer.classList.add('hidden');
        if(!isMobile) recipeMainPanel?.classList.remove('hidden');
        return;  
    }
    if (chartsContainer) chartsContainer.classList.add('hidden');
    recipeContentContainer.classList.remove('hidden');
    if(!isMobile) recipeMainPanel?.classList.remove('hidden');
    
    recipeContentContainer.innerHTML = `
        <div>
            <h3 class="text-3xl md:text-4xl font-bold">${recipe.name[state.currentLang]}</h3>
            <p class="text-lg text-neutral-600 mt-1">"${recipe.description[state.currentLang]}"</p>
        </div>
        <div class="mt-8">${createFullRecipeHTML(recipe)}</div>
    `;
    applyTranslations();
}

function init() {
    const welcomeModal = document.getElementById('welcomeModal');
    const stopWelcomeAnimation = () => {
        if (welcomeModal) {
            welcomeModal.classList.add('hidden');
        }
    };
    window.addEventListener('click', stopWelcomeAnimation, { once: true });
    window.addEventListener('scroll', stopWelcomeAnimation, { once: true });
    window.addEventListener('keydown', stopWelcomeAnimation, { once: true });

    const tooltipEl = document.getElementById('infoTooltip');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxClose = document.getElementById('lightboxClose');

    document.body.addEventListener('mouseover', (e) => {
        const title = e.target.closest('.parameter-title');
        if (title) {
            const key = title.dataset.paramKey;
            const explanation = parameterExplanations[key]?.[state.currentLang];
            if (explanation) {
                tooltipEl.innerHTML = explanation;
                const titleRect = title.getBoundingClientRect();
                tooltipEl.style.left = `${titleRect.left + window.scrollX}px`;
                tooltipEl.style.top = `${titleRect.top + window.scrollY - tooltipEl.offsetHeight - 8}px`;
                tooltipEl.classList.remove('hidden');
                setTimeout(() => tooltipEl.classList.add('visible'), 10);
            }
        }
    });
    document.body.addEventListener('mouseout', (e) => {
        if (e.target.closest('.parameter-title')) {
            tooltipEl.classList.remove('visible');
            setTimeout(() => tooltipEl.classList.add('hidden'), 200);
        }
    });

    document.body.addEventListener('click', async (e) => {
        const target = e.target;
        const navBtn = target.closest('[data-view]');
        const langBtn = target.closest('.lang-btn-slider');
        const recipeItem = target.closest('.recipe-item');
        
        const collageItem = target.closest('.collage-item');
        if (collageItem) {
            const imgSrc = collageItem.dataset.lightboxSrc;
            if (imgSrc) {
                lightboxImage.src = imgSrc;
                lightbox.classList.remove('hidden');
                setTimeout(() => lightbox.classList.add('visible'), 10);
            }
            return;
        }

        if (target.closest('#homeBtn')) { await renderView('home'); return; }
        if (target.closest('#hamburgerBtn')) { document.getElementById('mobileNavMenu').classList.remove('translate-x-full'); return; }
        if (target.closest('#closeMobileNavBtn')) { document.getElementById('mobileNavMenu').classList.add('translate-x-full'); return; }
        if (target.closest('#backToListBtn')) { state.isMobileDetailActive = false; renderLibraryDetails(); return; }
        
        if (target.closest('#quizModal')) {
            if (target.closest('#closeQuizBtn')) { closeQuiz(); return; }
            if (target.closest('#retakeQuizBtn')) { state.quiz.currentQuestionIndex = 0; state.quiz.answers = []; renderQuizQuestion(); return; }
            if (target.closest('#viewResultBtn')) { 
                const recipeId = target.closest('#viewResultBtn').dataset.recipeId;
                closeQuiz(); 
                await renderView('recipeFormulas', recipeId); 
                return; 
            }
            if (target.closest('.quiz-option')) { handleQuizAnswer(e); return; }
        }
        
        if (target.closest('#aiLabModal')) {
            if (target.closest('#closeAILabBtn')) { closeAILab(); return; }
            if (target.closest('#cancelAIBtn')) { 
                if (state.ai.abortController) state.ai.abortController.abort();
                Object.assign(state.ai, { expertPrompt: '', userPrompt: '', generatedRecipe: null, generationPromise: null, abortController: null });
                renderAILab();
                return; 
            }
            if (target.closest('#generateAIBtn')) { handleAIGeneration(); return; }
            if (target.closest('#confirmAIBtn')) { confirmAndCallAI(); return; }
        }

        if (target.closest('#captionLabModal')) {
            if (target.closest('#closeCaptionLabBtn')) { closeCaptionLab(); return; }
            if (target.closest('#generateCaptionBtn')) { handleCaptionGeneration(); return; }
            const copyBtn = target.closest('[data-copy-target]');
            if (copyBtn) {
                const targetId = copyBtn.dataset.copyTarget;
                const textToCopy = document.getElementById(targetId).innerText;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = copyBtn.querySelector('span').innerText;
                    copyBtn.querySelector('span').innerText = t('copiedBtn');
                    copyBtn.disabled = true;
                    setTimeout(() => {
                        copyBtn.querySelector('span').innerText = originalText;
                        copyBtn.disabled = false;
                    }, 2000);
                });
                return;
            }
        }

        if (target.closest('#startQuizBtn') || target.closest('#quizShortcutBtn')) { startQuiz(); return; }
        if (target.closest('#tweakWithAIBtn')) { openAILab(target.closest('#tweakWithAIBtn').dataset.recipeId); return; }
        if (target.closest('#captionAIBtn')) { openCaptionLab(target.closest('#captionAIBtn').dataset.recipeId); return; }
        
        if (navBtn) {
            await renderView(navBtn.dataset.view);
            if(target.closest('.nav-btn-mobile')) {
                 document.getElementById('mobileNavMenu').classList.add('translate-x-full');
            }
            return;
        }
        
        if (langBtn) {
            state.currentLang = langBtn.id === 'langEN' ? 'en' : 'vi';
            updateLangSlider();
            applyTranslations();
            if (state.currentView === 'recipeFormulas') {
                renderLibraryList();
                if (state.selectedRecipeId) renderLibraryDetails();
            }
            return;
        }

        if (recipeItem) {
            handleRecipeSelection(recipeItem.dataset.recipeId);
            return;
        }
    });
    
    const closeLightbox = () => {
        lightbox.classList.remove('visible');
        setTimeout(() => {
            lightbox.classList.add('hidden');
            lightboxImage.src = ''; // Clear src to prevent loading in background
        }, 300);
    };
    lightboxClose.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) { // Only close if clicking on the backdrop
            closeLightbox();
        }
    });

    document.addEventListener('input', e => {
        if(e.target.id === 'searchInput') renderLibraryList();
    });

    window.addEventListener('resize', () => { if(state.currentView === 'recipeFormulas') renderLibraryDetails(); });

    renderView('home');
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
