<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sony AI Color Lab Web-App</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 6.253v11.494m-5.747-8.662l11.494 5.747m-11.494 0l11.494-5.747M4.75 12A7.25 7.25 0 0112 4.75v0A7.25 7.25 0 0119.25 12v0a7.25 7.25 0 01-7.25 7.25v0A7.25 7.25 0 014.75 12v0z' stroke='%231d1d1f' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' fill='none'%3E%3C/path%3E%3C/svg%3E">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<!-- OPTIMIZATION: Defer non-critical scripts to speed up initial page load -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<style>
html { scroll-behavior: smooth; }
body {
font-family: 'Be Vietnam Pro', sans-serif;
background-color: #f4f7fc;
color: #212529;
overflow-x: hidden;
overflow-y: auto;
}

#bg-blurs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
.blur-circle { position: absolute; border-radius: 50%; filter: blur(180px); opacity: 0.15; transition: all 2s ease-in-out; }
.blur-1 { width: 40vw; height: 40vw; max-width: 500px; max-height: 500px; background: #007AFF; top: 5%; left: 10%; animation: move-blur-1 30s infinite alternate; }
.blur-2 { width: 50vw; height: 50vw; max-width: 600px; max-height: 600px; background: #FF9500; bottom: 5%; right: 10%; animation: move-blur-2 35s infinite alternate; }
@keyframes move-blur-1 { from { transform: translate(0, 0) scale(1) rotate(0deg); } to { transform: translate(10vw, 5vh) scale(1.3) rotate(55deg); } }
@keyframes move-blur-2 { from { transform: translate(0, 0) scale(1) rotate(0deg); } to { transform: translate(-8vw, -5vh) scale(1.2) rotate(-70deg); } }

:root {
--primary-accent: #007AFF;
--primary-accent-darker: #0056B3;
--glass-bg: rgba(255, 255, 255, 0.55);
--glass-border: rgba(0, 0, 0, 0.07);
--text-primary: #1d1d1f;
--text-secondary: #6e6e73;
}

.glass-panel {    
background: var(--glass-bg);    
backdrop-filter: blur(40px) saturate(180%);    
-webkit-backdrop-filter: blur(40px) saturate(180%);    
border: 1px solid var(--glass-border);    
box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08);
border-radius: 24px;
}
@media (min-width: 768px) {
.glass-panel { border-radius: 28px; }
}

/* Custom style for Welcome Modal background */
#welcomeModal .modal-content {
    background: linear-gradient(to bottom right, #FFFFFF, #E0F2FE); /* White to very light blue gradient */
    /* Ensure other glass-panel properties are retained or re-applied if needed */
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 1px solid var(--glass-border);
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08);
}


.recipe-item.selected {    
background-color: rgba(0, 122, 255, 0.1);    
border-left: 4px solid var(--primary-accent);    
color: var(--text-primary);    
transform: translateX(4px);
box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
}
.recipe-item:hover:not(.selected) { background-color: rgba(0, 0, 0, 0.04); }
.recipe-dot { transition: transform 0.2s ease-in-out; }
.recipe-dot:hover { transform: scale(1.25); }

.btn { border-radius: 9999px; font-weight: 600; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
.btn-primary { background-color: var(--primary-accent); border: none; color: white; box-shadow: 0 4px 14px rgba(0, 118, 255, 0.39); }
.btn-primary:hover:not(:disabled) { background-color: var(--primary-accent-darker); transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 18px rgba(0, 118, 255, 0.45); }
.btn:disabled { background-color: #b0bec5; cursor: not-allowed; opacity: 0.7; box-shadow: none; }

.lang-btn { background: #e9ecef; border: none; border-radius: 9999px; padding: 0.25rem; transition: all 0.2s ease; }
.lang-btn.active { box-shadow: 0 0 0 2.5px var(--primary-accent); }
.lang-btn svg { width: 1.5rem; height: 1.5rem; }

.landing-title { font-size: clamp(2.2rem, 5.5vw, 4.5rem); font-weight: 800; color: var(--text-primary); line-height: 1.1; letter-spacing: -0.025em; }
.quiz-question-title { font-size: clamp(1.7rem, 5vw, 3rem); font-weight: 700; color: var(--text-primary); line-height: 1.15; letter-spacing: -0.02em; }
.landing-subtitle { font-size: clamp(1rem, 2.5vw, 1.25rem); color: var(--text-secondary); margin-top: 1.25rem; max-width: 650px; line-height: 1.6; }

.view-transition { animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
.view-transition-out { animation: fadeOutDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

/* QUIZ STYLES */
.quiz-option-card {
background-color: white;
border: 2px solid #e5e7eb;
padding: 1rem;
border-radius: 1.25rem;
cursor: pointer;
transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
text-align: center;
display: flex;
flex-direction: column;
align-items: center;
gap: 0.75rem;
}
.quiz-option-card:hover {
transform: translateY(-4px);
box-shadow: 0 10px 20px rgba(0,0,0,0.07);
}
.quiz-option-card.selected {
border-color: var(--primary-accent);
background-color: rgba(0, 122, 255, 0.1);
color: var(--primary-accent);
box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
}
.quiz-option-card svg {
width: 2.5rem;
height: 2.5rem;
color: #6b7280;
transition: color 0.2s ease;
}
.quiz-option-card.selected svg {
color: var(--primary-accent);
}
.quiz-option-card span {
font-weight: 600;
font-size: 1rem;
}
.bouncing {
animation: bounce-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes bounce-in {
0% { transform: scale(0.95); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

.filter-btn { background-color: rgba(0,0,0,0.05); border: 1px solid transparent; transition: all 0.2s ease-in-out; }
.filter-btn.active { background-color: rgba(0, 122, 255, 0.1); border-color: var(--primary-accent); color: var(--primary-accent); font-weight: 600; }

.spinner { border: 3px solid rgba(0, 0, 0, 0.1); width: 20px; height: 20px; border-radius: 50%; border-left-color: currentColor; animation: spin 1s ease infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.modal { z-index: 50; transition: opacity 0.3s ease; }
.modal-content { transition: transform 0.3s ease; border-radius: 28px; }
.modal.hidden { opacity: 0; pointer-events: none; }
.modal.hidden .modal-content { transform: scale(0.95); }

#comparisonModalContent { background-color: #f0f9ff; border-radius: 0 0 28px 28px; }
.prose-comparison h3 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--text-primary); border-bottom: 2px solid var(--primary-accent); padding-bottom: 0.5rem; }

.quiz-choice-option { cursor: pointer; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; background: rgba(255,255,255,0.7); border-radius: 20px;}
.quiz-choice-option:hover { transform: scale(1.03); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

.overflow-y-auto::-webkit-scrollbar { width: 10px; }
.overflow-y-auto::-webkit-scrollbar-track { background-color: transparent; }
.overflow-y-auto::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
.overflow-y-auto::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }
.overflow-y-auto { scrollbar-width: auto; scrollbar-color: rgba(0, 0, 0, 0.2) transparent; }

.chart-container { position: relative; margin: auto; height: 280px; width: 100%;}
@media (min-width: 768px) { .chart-container { height: 320px; } }
#colorChart, #bwChart { cursor: pointer; }

#mobileNavMenu { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

#lightbox { z-index: 100; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
#lightbox.hidden { opacity: 0; pointer-events: none; }
#lightbox .lightbox-content { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
#lightbox.hidden .lightbox-content { transform: scale(0.95); opacity: 0; }
.lightbox-thumb { cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; }
.lightbox-thumb.active { border-color: var(--primary-accent); transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 122, 255, 0.5); }
.lightbox-nav-btn { background-color: rgba(0,0,0,0.4); transition: background-color 0.2s ease; }
.lightbox-nav-btn:hover { background-color: rgba(0,0,0,0.7); }
#lightbox-main-image { transition: opacity 0.2s ease-in-out; }

#abgm-grid-interactive-container {
width: 100%;
max-width: 300px;
margin: auto;
touch-action: none; 
}
#abgm-grid {
position: relative;
width: 100%;
aspect-ratio: 1 / 1;
border-radius: 0.5rem;
cursor: pointer;
background-image: 
linear-gradient(to right, rgba(0, 128, 0, 0.2), rgba(255, 255, 255, 0), rgba(255, 0, 255, 0.2)),
linear-gradient(to bottom, rgba(255, 165, 0, 0.2), rgba(255, 255, 255, 0), rgba(0, 0, 255, 0.2));
box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}
#abgm-pointer {
position: absolute;
width: 1rem;
height: 1rem;
background-color: #ef4444;
border: 2px solid white;
border-radius: 9999px;
box-shadow: 0 0 10px rgba(0,0,0,0.5);
transform: translate(-50%, -50%);
pointer-events: none;
}
.pp-infographic-item {
background-color: #ffffff;
border: 1px solid #e5e7eb;
border-radius: 1rem;
padding: 1.5rem;
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
.pp-infographic-item h5 {
color: var(--text-primary);
font-weight: 700;
font-size: 1.125rem;
}
.pp-infographic-item .param-list li {
position: relative;
padding-left: 1.5rem;
}
.pp-infographic-item .param-list li::before {
content: "✓";
position: absolute;
left: 0;
color: #16a34a;
font-weight: bold;
}
</style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QKGB56ZKQD"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-QKGB56ZKQD');
</script>
</head>
<body>
<div id="bg-blurs"><div class="blur-circle blur-1"></div><div class="blur-circle blur-2"></div></div>

<div id="appContainer" class="min-h-screen w-screen p-4 md:p-6 flex flex-col">
<header class="flex justify-between items-center w-full z-20 flex-shrink-0">
<button id="homeBtn" class="text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-2">
<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 6.253v11.494m-5.747-8.662l11.494 5.747m-11.494 0l11.494-5.747M4.75 12A7.25 7.25 0 0112 4.75v0A7.25 7.25 0 0119.25 12v0a7.25 7.25 0 01-7.25 7.25v0A7.25 7.25 0 014.75 12v0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
<span data-translate-key="headerTitle" class="hidden sm:inline"></span>
<span class="ml-2 text-[10px] font-bold text-white bg-gradient-to-r from-purple-500 via-blue-500 to-teal-400 px-2.5 py-1 rounded-full uppercase tracking-wider self-center shadow-md">Beta</span>
</button>
<div class="flex items-center gap-2 md:gap-4">
<nav id="mainNav" class="hidden md:flex items-center gap-2">
<div class="relative" id="pp-dropdown-container">
<button id="pp-dropdown-btn" class="font-semibold text-gray-600 hover:text-black transition-colors px-4 py-2 flex items-center gap-1 rounded-full hover:bg-gray-100">
<span data-translate-key="navPictureProfile"></span>
<svg class="w-4 h-4 transition-transform" id="pp-dropdown-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
</button>
<div id="pp-dropdown-menu" class="absolute top-full mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-100 py-2 z-50 hidden origin-top-right transition-all duration-200 ease-out transform opacity-0 scale-95">
<button data-view="recipeFormulas" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navRecipeFormulas"></button>
<button data-view="featuredPhotos" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navFeaturedPhotos"></button>
<button data-view="explain" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navExplain"></button>
</div>
</div>
</nav>
<div class="flex items-center gap-2">
<button id="langEN" class="lang-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30"><clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath><path d="M0,0 v30 h60 v-30 z" fill="#00247d"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#cf142b" stroke-width="4"/><path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/><path d="M30,0 v30 M0,15 h60" stroke="#cf142b" stroke-width="6"/></svg></button>
<button id="langVI" class="lang-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600"><path fill="#da251d" d="M0 0h900v600H0z"/><path fill="#ff0" d="m450 186-86 266 226-164h-280l226 164z"/></svg></button>
</div>
<button id="hamburgerBtn" class="md:hidden p-2 rounded-full hover:bg-black/10 focus:outline-none focus:ring-2 focus:ring-gray-500">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
</button>
</div>
</header>

<div id="mainContent" class="flex-grow min-h-0 relative mt-4 md:mt-6 mb-2"></div>
</div>

<!-- Welcome Modal -->
<div id="welcomeModal" class="modal hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div class="modal-content glass-panel w-full max-w-3xl max-h-[90vh] flex flex-col p-6 md:p-10 overflow-y-auto">
<h2 class="font-semibold text-2xl mb-6" data-translate-key="manifestoTitle"></h2>
<div class="prose prose-lg max-w-none text-gray-700 leading-relaxed space-y-4">
<p data-translate-key="manifestoBody1"></p>
<p data-translate-key="manifestoBody2"></p>
<p class="font-semibold text-xl text-center text-blue-600 py-4" data-translate-key="manifestoBody3"></p>
<p data-translate-key="manifestoBody4"></p>
<p data-translate-key="manifestoBody5"></p>
<p data-translate-key="manifestoBody6"></p>
<p class="mb-8 font-bold" data-translate-key="manifestoBody7"></p>
<p class="text-right" data-translate-key="manifestoSignature"></p>
</div>
<div class="text-center mt-8">
<button id="closeWelcomeModalBtn" class="btn btn-primary py-3 px-8 text-lg" data-translate-key="startExploringBtn"></button>
</div>
</div>
</div>

<div id="mobileNavMenu" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 transform translate-x-full md:hidden">
<div class="absolute top-0 right-0 h-full w-2/3 max-w-sm bg-white/80 backdrop-blur-xl shadow-2xl p-6">
<button id="closeMobileNavBtn" class="absolute top-4 right-4 text-3xl p-2">&times;</button>
<nav class="mt-16 flex flex-col gap-6 text-center">
<button data-view="recipeFormulas" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navRecipeFormulas"></button>
<button data-view="featuredPhotos" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navFeaturedPhotos"></button>
<button data-view="explain" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navExplain"></button>
</div>
</div>

<div id="comparisonModal" class="modal hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
<div class="modal-content glass-panel w-full max-w-4xl max-h-[90vh] flex flex-col">
<div class="p-4 md:p-6 border-b border-black/10 flex justify-between items-center flex-shrink-0">
<h2 id="comparisonModalTitle" class="text-xl md:text-2xl font-bold"></h2>
<button id="closeComparisonModalBtn" class="text-3xl leading-none p-2 rounded-full hover:bg-black/10">&times;</button>
</div>
<div id="comparisonModalContent" class="p-6 md:p-8 overflow-y-auto prose-comparison"></div>
</div>
</div>

<div id="lightbox" class="hidden fixed inset-0 flex items-center justify-center p-4 transition-opacity duration-300">
<div id="lightbox-bg" class="absolute inset-0"></div>
<div class="lightbox-content relative w-full max-w-4xl max-h-full">
<button id="lightbox-close" class="absolute -top-4 -right-2 md:top-0 md:-right-12 text-white text-5xl font-bold z-10 leading-none p-2">&times;</button>
<div class="relative">
<img id="lightbox-main-image" src="" alt="Ảnh demo công thức" class="w-full h-auto max-h-[75vh] object-contain rounded-lg shadow-2xl bg-black/50">
<button id="lightbox-prev" class="lightbox-nav-btn absolute top-1/2 left-2 md:-left-16 -translate-y-1/2 p-2 md:p-3 rounded-full text-white">
<svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
</button>
<button id="lightbox-next" class="lightbox-nav-btn absolute top-1/2 right-2 md:-right-16 -translate-y-1/2 p-2 md:p-3 rounded-full text-white">
<svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
</button>
</div>
<div id="lightbox-thumbnails" class="flex justify-center items-center gap-2 md:gap-4 mt-4"></div>
</div>
</div>

<script type="module">
// --- STATE & CONFIGURATION ---
const state = {
currentLang: 'vi',
currentView: 'home',
selectedRecipeId: null,
comparisonList: [],
lastGeneratedAiRecipe: null,
isAILoading: false,
quizStep: 0,
quizAnswers: {},
activeFilters: { type: 'all', contrast: 'all', saturation: 'all' },
isMobileDetailActive: false,
lightbox: { isOpen: false, images: [], currentIndex: 0 },
};

const mainContentEl = document.getElementById('mainContent');
let activeCharts = {};

// --- DATA ---
import recipesData from './recipes.js';

const translations = {
// General
headerTitle: {vi: "Alpha AI Color Lab", en: "Alpha AI Color Lab"},
navPictureProfile: {vi: "Picture Profile", en: "Picture Profile"},
navRecipeFormulas: {vi:"Công thức màu", en:"Color Recipes"},
navFeaturedPhotos: {vi: "Ảnh nổi bật", en: "Featured Photos"},
navExplain: {vi:"Giải thích (PP)", en:"Guide (PP)"},
noteTitle: {vi:"Lưu ý quan trọng", en:"Important Note"},
footerText: {vi: "Phát triển bởi Sony Alpha Vietnam.", en: "Developed by Sony Alpha Vietnam."},
startExploringBtn: {vi: "Bắt đầu khám phá", en: "Start Exploring"},
exportRecipeBtn: {vi: "Lưu & Xuất Công Thức", en: "Save & Export Recipe"},
downloadLutBtn: {vi: "Tải file .CUBE (LUT)", en: "Download .CUBE (LUT) File"},
memoryRecallBtn: {vi: "Hướng dẫn lưu vào máy", en: "Camera Save Guide"},

// Home / Quiz
landingTitle: {vi:"Tìm màu sắc của riêng bạn.", en:"Find Your Signature Color."},
landingSubtitle: {vi:"Trả lời vài câu hỏi để khám phá công thức màu được AI tạo ra dành riêng cho tâm trạng và phong cách của bạn.", en:"Answer a few questions to discover a unique color recipe, tailored by AI to your mood and style."},
startQuizBtn: {vi:"Khám phá màu của bạn", en:"Discover Your Color"},
quizResultTitle: {vi: "AI đề xuất 2 lựa chọn cho bạn:", en: "AI suggests 2 options for you:"}, // This will be removed in the new logic
viewInLibraryBtn: {vi: "Xem trong thư viện", en: "View in Library"},
loadingAnalyze: {vi: "Đang phân tích lựa chọn...", en: "Analyzing your choices..."},

// Recipe Formulas
sidebarTitle: {vi: "Công thức Picture Profile", en: "Picture Profile Recipes"}, // This title will be removed from display
searchInputPlaceholder: {vi: "🔍 Tìm công thức...", en: "🔍 Search recipes..."},
filterType: {vi: "Loại", en: "Type"},
filterTypeColor: {vi: "Màu", en: "Color"},
filterTypeBW: {vi: "Trắng Đen", en: "B&W"},
filterContrast: {vi: "Tương phản", en: "Contrast"},
filterSaturation: {vi: "Bão hòa", en: "Saturation"},
filterHigh: {vi: "Cao", en: "High"},
filterMedium: {vi: "Vừa", en: "Med"},
filterLow: {vi: "Thấp", en: "Low"},
filterSort: {vi: "Sắp xếp theo", en: "Sort by"},
sortDefault: {vi: "Mặc định", en: "Default"},
sortNameAZ: {vi: "Tên A-Z", en: "Name A-Z"},
sortContrastHL: {vi: "Tương phản: Cao-Thấp", en: "Contrast: High-Low"},
sortSaturationHL: {vi: "Bão hòa: Cao-Thấp", en: "Saturation: High-Low"},
compareBtn: {vi: "So sánh bằng AI", en: "Compare with AI"},
recipeDetailWelcomeTitle: {vi: "Thư viện màu Tương tác", en: "Interactive Color Library"},
recipeDetailWelcomeText: {vi: "Khám phá các công thức màu Picture Profile một cách trực quan. Nhấp vào một điểm trên biểu đồ hoặc một công thức trong danh sách để xem chi tiết.", en: "Explore Picture Profile color recipes visually. Click a point on the chart or a recipe in the list to see details."},
whiteBalanceTitle: {vi: "Cân bằng trắng (WB)", en: "White Balance (WB)"},
recipeSettingsTitle: {vi: "Cài đặt Chính", en: "Main Settings"},
colorDepthTitle: {vi: "Độ sâu màu", en: "Color Depth"},
detailTitle: {vi: "Chi tiết", en: "Detail"},
aiTuningTitle: {vi: "Tinh chỉnh bằng AI", en: "AI Fine-Tuning"},
aiTuningPlaceholder: {vi: "Nhập yêu cầu của bạn ở đây... (ví dụ: 'làm cho màu ấm hơn và trong hơn')", en: "Enter your request here... (e.g., 'make it warmer and clearer')"},
aiTuningBtn: {vi: "Tạo bằng AI", en: "Generate with AI"},
aiResultTitle: {vi: "Công thức đã được AI tinh chỉnh:", en: "AI-Adjusted Recipe:"},
compareWithOriginalBtn: {vi: "So sánh với bản gốc", en: "Compare with Original"},
aiSuggestionTitle: {vi: "Gợi ý của AI:", en: "AI Suggestion:"},
aiSuggestionText: {vi: "Dựa trên yêu cầu của bạn, công thức này có vẻ phù hợp hơn: ", en: "Based on your request, this recipe might be a better fit: "},
comparisonModalTitle: {vi: "So sánh Công thức", en: "Recipe Comparison"},
comparisonLoading: {vi: "AI đang phân tích và so sánh...", en: "AI is analyzing and comparing..."},
colorChartTitle: {vi: "Biểu đồ Màu", en: "Color Chart"},
bwChartTitle: {vi: "Biểu đồ Đơn sắc (B&W)", en: "Monochrome (B&W) Chart"},
axisTonality: {vi: "Tương phản (← Mềm | Cứng →)", en: "Tonality (← Soft | Hard →)"},
axisSaturation: {vi: "Độ bão hòa (← Thấp | Cao →)", en: "Saturation (← Low | High →)"},
axisChroma: {vi: "Độ sâu màu (← Thấp | Cao →)", en: "Chroma Depth (← Low | High →)"},
backToListBtn: {vi: "← Quay lại danh sách", en: "← Back to list"},
aiExplainRecipeBtn: {vi: "✨ Giải thích bằng AI", en: "✨ Explain with AI"},
aiExplanationTitle: {vi: "Giải thích công thức bằng AI:", en: "AI Recipe Explanation:"},
aiExplanationLoading: {vi: "AI đang phân tích công thức...", en: "AI is analyzing the recipe..."},


// Featured Photos
featuredTitle: {vi: "Ảnh Nổi Bật từ Cộng Đồng", en: "Featured Photos from the Community"},
featuredCta: {vi: "Hãy cùng làm cho thư viện màu của Alpha AI Color Lab và group cộng đồng Sony Alpha Vietnam thêm phong phú! Chia sẻ ảnh của bạn kèm mã màu (ví dụ: 'SCL-82') để cùng nhau tạo nên một không gian đầy cảm hứng.", en: "Let's enrich the Alpha AI Color Lab gallery and the Sony Alpha Vietnam community group! Share your photos with the color code (e.g., 'SCL-82') to create an inspiring space together."},
featuredAlbumBtn: {vi: "Xem Album & Đóng góp Ảnh", en: "View Album & Contribute Photos"},

// Explanation Tab
manifestoTitle: { vi: "Gửi những người bạn đồng hành sáng tạo,", en: "To our creative companions," },
manifestoBody1: { vi: "Chúng tôi hiểu rằng, đối với mỗi người cầm máy, màu sắc không chỉ là một thông số kỹ thuật. Đó là một phần của câu chuyện, là cảm xúc, và là ngôn ngữ không lời bạn dùng để giao tiếp với thế giới.", en: "We understand that, for every photographer, color is more than just a technical parameter. It's part of the story, it's emotion, and it's the non-verbal language you use to communicate with the world." },
manifestoBody2: { vi: "Có lẽ bạn, cũng như chúng tôi, đã từng trăn trở trên hành trình đi tìm một màu sắc \"độc nhất\" của riêng mình. Một hành trình thường bắt đầu bằng việc cố gắng tái tạo một công thức có sẵn. Nhưng chúng tôi tin rằng tiềm năng sáng tạo của bạn không nên bị giới hạn trong bất kỳ khuôn khổ nào.", en: "Perhaps you, like us, have wrestled with the journey to find a 'unique' color of your own. A journey that often begins by trying to replicate a pre-existing formula. But we believe your creative potential should not be confined to any framework." },
manifestoBody3: { vi: "Vì vậy, tại Alpha AI Color Lab, chúng tôi theo đuổi một triết lý khác biệt:<br><strong>Không tạo ra những bản sao, mà kiến tạo nên những dấu ấn màu sắc mang đậm tính cá nhân.</strong>", en: "Therefore, at Alpha AI Color Lab, we pursue a different philosophy:<br><strong>We don't create copies; we build personalized color signatures.</strong>" },
manifestoBody4: { vi: "Dự án này không ra đời để \"giả lập\" một màu phim cụ thể nào. Thay vào đó, chúng tôi xem công cụ Picture Profile mạnh mẽ của Sony như một bảng màu vô hạn. Các chuyên gia của chúng tôi đã dành tâm huyết nghiên cứu, không phải để \"sao chép\", mà để \"sáng tác\" — khai phá những khả năng tiềm ẩn, tạo ra các sắc thái và sự chuyển màu độc đáo mà bạn khó có thể tìm thấy ở nơi khác.", en: "This project was not born to 'emulate' any specific film stock. Instead, we see Sony's powerful Picture Profile tool as an infinite creative palette. Our experts have dedicated their efforts to research, not to 'imitate', but to 'compose'—unlocking hidden potentials to create unique shades and color transitions that you'd be hard-pressed to find elsewhere." },
manifestoBody5: { vi: "Mỗi công thức bạn tìm thấy tại đây không phải là một bộ lọc có sẵn. Đó là một tác phẩm nguyên bản, được thiết kế đầy chủ ý để giúp bạn khẳng định ngôn ngữ hình ảnh độc đáo của riêng mình.", en: "Every recipe you find here is not a pre-made filter. It is an original work, intentionally designed to help you assert your own unique visual language." },
manifestoBody6: { vi: "Mục tiêu cuối cùng của chúng tôi là trao cho bạn quyền năng định hình câu chuyện bằng màu sắc, truyền thêm cảm hứng cho mỗi khung hình ngay từ khoảnh khắc bấm máy.", en: "Our ultimate goal is to empower you to shape your own narrative with color, inspiring every frame from the moment you press the shutter." },
manifestoBody7: { vi: "Hãy ngừng tìm kiếm một vẻ ngoài có sẵn. Hãy bắt đầu hành trình kiến tạo nên dấu ấn của riêng bạn.", en: "Stop searching for a ready-made look. Start the journey of creating your own signature." },
manifestoSignature: { vi: "Trân trọng,<br><strong>Sony Alpha Vietnam.</strong>", en: "Sincerely,<br><strong>Sony Alpha Vietnam.</strong>" },

explainHeader: {vi: "Làm Chủ Màu Sắc Cùng Sony Alpha", en:"Mastering Color with Sony Alpha"},
explainSubtitle: {vi: "Hướng dẫn toàn diện để tạo ra màu sắc đậm chất riêng cho ảnh tĩnh", en:"A comprehensive guide to creating your unique color signature for stills"},
pillarsTitle: {vi: "Hai Trụ Cột Sáng Tạo Màu Sắc", en:"The Two Pillars of Color Creation"},
wbPillarTitle: {vi: "Trụ cột 1: White Balance - Nền Tảng Cảm Xúc", en:"Pillar 1: White Balance - The Emotional Foundation"},
ppPillarTitle: {vi: "Trụ cột 2: Picture Profile - Tạo Dáng Vẻ Phim Ảnh", en:"Pillar 2: Picture Profile - Crafting the Film Look"},
wbKelvinTitle: {vi: "Nhiệt Độ Kelvin (K): Tạo Tông Màu Chủ Đạo", en: "Kelvin Temperature (K): Creating the Main Tone"},
wbKelvinDesc: {vi: 'Sử dụng thang đo Kelvin như một nét cọ lớn để "nhuộm" toàn bộ khung hình bằng tông màu ấm hoặc lạnh, định hình "mood" cho bức ảnh.', en: 'Use the Kelvin scale like a broad brush to "tint" the entire frame with warm or cool tones, shaping the photo\'s mood.'},
wbShiftTitle: {vi: "Lưới Tinh Chỉnh (A-B/G-M Shift): Thêm Sắc Thái Tinh Vi", en:"Fine-Tuning Grid (A-B/G-M Shift): Adding Subtle Hues"},
wbShiftDesc: {vi: 'Nếu Kelvin là nét cọ lớn, lưới tinh chỉnh là cọ tỉa. Đây là chìa khóa để mô phỏng các loại phim đặc trưng bằng cách thêm các sắc thái Hổ phách/Xanh hoặc Xanh lá/Tím.', en: 'If Kelvin is the broad brush, this is the fine-detail brush. It\'s key to simulating specific films by adding Amber/Blue or Green/Magenta tints.'},
ppInfographicTitle: {vi: "Quy trình Tinh chỉnh Picture Profile", en:"Picture Profile Adjustment Workflow"},
ppInfographicDesc: {vi: "Làm theo các bước sau để thiết lập Picture Profile từ đầu, cho phép bạn kiểm soát hoàn toàn giao diện cuối cùng của hình ảnh.", en:"Follow these steps to set up a Picture Profile from scratch, giving you full control over the final look of your image."},
ppItemBlackLevel: {vi: "Black Level (Mức độ đen)", en: "Black Level"},
ppItemBlackLevelDesc: {vi: "Thiết lập điểm đen (vùng tối nhất). Tăng (+) để nâng vùng tối (tạo look 'faded' hoài cổ), giảm (-) để vùng tối sâu hơn (tăng tương phản).", en: "Sets the black point. Increase (+) to lift shadows (for a 'faded' look), decrease (-) for deeper blacks (more more contrast)."},
ppItemGamma: {vi: "Gamma", en: "Gamma"},
ppItemGammaDesc: {vi: "Thiết lập đường cong tương phản (contrast curve). Đây là nền tảng cho 'look' của bạn. Still & Movie cho độ tương phản cao, trong khi các gamma Cine/S-Log cho dải nhạy sáng rộng hơn.", en: "Sets the contrast curve. This is the foundation of your look. Still & Movie are punchy, while Cine/S-Log gammas offer wider dynamic range."},
ppItemBlackGamma: {vi: "Black Gamma", en: "Black Gamma"},
ppItemBlackGammaDesc: {vi: "Tinh chỉnh đường cong tương phản ở vùng tối. 'Wide' ảnh hưởng vùng rộng hơn, 'Narrow' ảnh hưởng vùng hẹp hơn.", en: "Fine-tune the contrast curve in the shadow areas. 'Wide' affects a broader range, 'Narrow' affects a smaller range."},
ppItemKnee: {vi: "Knee (Điểm uốn)", en: "Knee"},
ppItemKneeDesc: {vi: "Kiểm soát độ nén ở vùng sáng (highlight) để tránh bị 'cháy'. Chế độ tự động (Auto) hoạt động tốt, chế độ thủ công (Manual) cho phép kiểm soát chính xác hơn.", en: "Controls highlight compression to prevent 'clipping'. Auto mode works well; Manual mode gives precise control."},
ppItemColorMode: {vi: "Color Mode (Chế độ màu)", en: "Color Mode"},
ppItemColorModeDesc: {vi: "Xác định cách màu sắc được tái tạo. Nên chọn chế độ phù hợp với Gamma đã chọn (ví dụ: Cine4 với Pro/Cinema, S-Log3 với S-Gamut3.Cine).", en: "Determines how colors are reproduced. Should be matched with the chosen Gamma (e.g., Cine4 with Pro/Cinema, S-Log3 with S-Gamut3.Cine)."},
ppItemSaturation: {vi: "Saturation (Bão hòa)", en: "Saturation"},
ppItemSaturationDesc: {vi: "Điều chỉnh độ đậm/nhạt tổng thể của tất cả các màu.", en: "Adjusts the overall intensity of all colors."},
ppItemColorPhase: {vi: "Color Phase (Pha màu)", en: "Color Phase"},
ppItemColorPhaseDesc: {vi: "Xoay trục màu sắc tổng thể. Hữu ích để tinh chỉnh nhẹ toàn bộ tông màu mà không ảnh hưởng đến từng màu riêng lẻ.", en: "Shifts the overall hue of all colors. Useful for subtle, global color tone adjustments without affecting individual colors."},
ppItemColorDepth: {vi: "Color Depth (Độ sâu màu)", en: "Color Depth"},
ppItemColorDepthDesc: {vi: "Công cụ mạnh mẽ nhất. Tăng/giảm độ sáng của từng kênh màu riêng lẻ (Đỏ, Lục, Lam, Lục lam, Tím, Vàng).", en: "The most powerful tool. Increases/decreases the brightness of individual color channels (R, G, B, C, M, Y)."},
ppItemDetail: {vi: "Detail (Chi tiết)", en: "Detail"},
ppItemDetailDesc: {vi: "Kiểm soát độ sắc nét. Để có 'look' phim mềm mại, hãy giảm mạnh (ví dụ: -7).", en: "Controls the sharpening. For a soft, filmic look, decrease it significantly (e.g., -7)."},
recallTitle: { vi: 'Lưu Trữ & Tái Sử Dụng: Làm Chủ Memory Recall', en: 'Save & Reuse: Mastering Memory Recall' },
recallDesc: { vi: 'Đừng lãng phí công sức! Lưu lại các công thức của bạn vào bộ nhớ của máy ảnh để gọi ra nhanh chóng chỉ bằng một thao tác xoay nút.', en: 'Don\'t waste your effort! Save your recipes to the camera\'s memory for quick recall with a simple turn of a dial.' },
recallInternalTitle: { vi: 'Bộ Nhớ Trong (1, 2, 3)', en: 'Internal Memory (1, 2, 3)' },
recallInternalDesc: { vi: 'Lưu trực tiếp vào máy. Truy cập nhanh nhất bằng cách xoay vòng xoay chế độ. Lý tưởng cho các công thức bạn sử dụng hàng ngày.', en: 'Saves directly to the camera. Quickest access via the mode dial. Ideal for your daily-use recipes.' },
recallCardTitle: { vi: 'Thẻ Nhớ (M1, M2, M3, M4)', en: 'Memory Card (M1, M2, M3, M4)' },
recallCardDesc: { vi: 'Lưu dưới dạng file trên thẻ nhớ. Cực kỳ hữu ích để sao lưu an toàn hoặc chuyển công thức sang một thân máy Sony khác.', en: 'Saves as a file on your memory card. Extremely useful for backups or transferring recipes to another Sony camera body.' },
tutorialTitle: { vi: "Hướng dẫn Cài đặt Nhanh", en: "Quick Setup Guide" },
tutorialStep1Title: { vi: "Bước 1: Tìm Picture Profile", en: "Step 1: Find Picture Profile" },
tutorialStep1P1: { vi: "<strong>Máy ảnh đời mới:</strong> Menu → Exposure/Color (biểu tượng máy ảnh) → Color/Tone → Picture Profile.", en: "<strong>Newer Cameras:</strong> Menu → Exposure/Color (camera icon) → Color/Tone → Picture Profile." },
tutorialStep1P2: { vi: "<strong>Máy ảnh đời cũ:</strong> Menu → Color/WB/Img. Processing (biểu tượng bảng màu) → Picture Profile.", en: "<strong>Older Cameras:</strong> Menu → Color/WB/Img. Processing (palette icon) → Picture Profile." },
tutorialStep2Title: { vi: "Bước 2: Chọn và Reset", en: "Step 2: Select & Reset" },
tutorialStep2P1: { vi: "Chọn một profile trống (ví dụ: PP10), đi vào trong và nhấn nút 'Xoá' để reset về mặc định.", en: "Choose an empty profile (e.g., PP10), enter it, and press the 'Delete' button to reset it to default." },
tutorialStep3Title: { vi: "Bước 3: Nhập thông số", en: "Step 3: Enter Parameters" },
tutorialStep3P1: { vi: "Cẩn thận nhập tất cả các thông số của công thức, từ Black Level đến Detail.", en: "Carefully enter all parameters from the recipe, from Black Level to Detail." },
tutorialStep4Title: { vi: "Bước 4: Cài đặt White Balance", en: "Step 4: Set White Balance" },
tutorialStep4P1: { vi: "Thoát khỏi Picture Profile, vào mục <strong>White Balance</strong> và chỉnh theo nhiệt độ K và WB Shift (Color Filter) được ghi trong công thức.", en: "Exit Picture Profile, go to <strong>White Balance</strong>, and adjust the Kelvin temperature and WB Shift (Color Filter) as specified in the recipe." },
exposureNoteTitle: { vi: "Lưu ý về Phơi sáng", en: "Note on Exposure" },
exposureNoteDesc: { vi: "Hầu hết các công thức được tối ưu khi chụp ở mức phơi sáng 0EV với chế độ đo sáng 'Toàn màn hình trung bình' (Entire Screen Avg.). Các công thức dựa trên S-Log có thể cần tăng phơi sáng (overexpose) để có kết quả tốt nhất.", en: "Most recipes are optimized for 0EV exposure with 'Entire Screen Avg.' metering mode. Recipes based on S-Log may require overexposure for best results." },

// Quiz Questions
quizQ1: {vi: "Chủ đề bạn sắp chụp là gì?", en: "What's your subject?"},
quizQ1A1: {vi: "Chân dung", en: "Portrait"},
quizQ1A2: {vi: "Phong cảnh", en: "Landscape"},
quizQ1A3: {vi: "Đường phố / Đô thị", en: "Street / Urban"},
quizQ1A4: {vi: "Đời thường", en: "Everyday"},
quizQ2: {vi: "Bạn muốn tông màu chủ đạo nào?", en: "What's your desired primary tone?"},
quizQ2A1: {vi: "Ấm áp (Vàng, Cam)", en: "Warm (Yellow, Orange)"},
quizQ2A2: {vi: "Mát mẻ (Xanh dương)", en: "Cool (Blue)"},
quizQ2A3: {vi: "Trung tính", en: "Natural"},
quizQ2A4: {vi: "Hoài cổ (Film)", en: "Nostalgic (Film)"},
quizQ3: {vi: "Độ tương phản bạn thích?", en: "How about the contrast?"},
quizQ3A1: {vi: "Cao (Gắt)", en: "High (Punchy)"},
quizQ3A2: {vi: "Thấp (Mềm mại)", en: "Low (Soft)"},
quizQ3A3: {vi: "Trung bình", en: "Medium"},
quizQ4: {vi: "Bạn thích ảnh màu hay trắng đen?", en: "Color or Black & White?"},
quizQ4A1: {vi: "Ảnh màu", en: "Color"},
quizQ4A2: {vi: "Ảnh trắng đen", en: "Black & White"},
quizQ5: {vi: "Độ bão hòa màu sắc bạn muốn?", en: "What's your preferred saturation?"},
quizQ5A1: {vi: "Đậm", en: "High"},
quizQ5A2: {vi: "Trung bình", en: "Medium"},
quizQ5A3: {vi: "Nhạt", en: "Low"},
};

const quizQuestions = [
{ 
id: 'subject', 
title: 'quizQ1', 
options: [
{ key: 'quizQ1A1', value: 'portrait', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>` },
{ key: 'quizQ1A2', value: 'landscape', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>` },
{ key: 'quizQ1A3', value: 'urban', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></svg>` },
{ key: 'quizQ1A4', value: 'everyday', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m2 9 3-3 3 3"/><path d="M13 18V2H7"/><path d="M22 15l-3 3-3-3"/><path d="m11 6 10 12"/></svg>` }
] 
},
{ 
id: 'tone', 
title: 'quizQ2', 
options: [
{ key: 'quizQ2A1', value: 'warm', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>` },
{ key: 'quizQ2A2', value: 'cool', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a7 7 0 0 0-7 7c0 2.4 1.2 4.5 3 5.7L12 22l4-7.3c1.8-1.2 3-3.3 3-5.7a7 7 0 0 0-7-7z"/><path d="M12 9a3 3 0 0 0-3 3c0 1.2.8 2.2 2 2.7l1 1.3l1-1.3c1.2-.5 2-1.5 2-2.7a3 3 0 0 0-3-3z"/></svg>` },
{ key: 'quizQ2A3', value: 'natural', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c-2 0-4-1-4-4 0-2 2-3 4-3s4 1 4 3c0 3-2 4-4 4z"/><path d="M12 15V2"/><path d="m5 12-3-3 3-3"/><path d="m19 12 3-3-3-3"/></svg>` },
{ key: 'quizQ2A4', value: 'vintage', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h4"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M21 7.5h-4"/><path d="M21 12h-4"/><path d="M21 16.5h-4"/></svg>` }
] 
},
{ 
id: 'contrast', 
title: 'quizQ3', 
options: [
{ key: 'quizQ3A1', value: 'high', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 18a6 6 0 0 0 0-12v12z"/></svg>` },
{ key: 'quizQ3A2', value: 'low', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" fill="currentColor" fill-opacity="0.2"/><path d="M12 18a6 6 0 0 0 0-12v12z"/></svg>` },
{ key: 'quizQ3A3', value: 'medium', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 18a6 6 0 0 0 0-12v12z" fill="currentColor" fill-opacity="0.5"/></svg>` }
] 
},
{
id: 'type',
title: 'quizQ4',
options: [
{ key: 'quizQ4A1', value: 'color', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>` },
{ key: 'quizQ4A2', value: 'bw', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>` }
]
},
{
id: 'saturation',
title: 'quizQ5',
options: [
{ key: 'quizQ5A1', value: 'high', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>` },
{ key: 'quizQ5A2', value: 'medium', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/></svg>` },
{ key: 'quizQ5A3', value: 'low', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>` }
]
}
];

async function callAIApi(prompt, isStructured = false, customDelay = 500) { // Changed default delay to 500ms
    if (state.isAILoading) return;
    state.isAILoading = true;
    let result = null; // Default to null for structured, or empty string for unstructured

    try {
        await new Promise(resolve => setTimeout(resolve, customDelay)); // Use customDelay

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });

        let payload = { contents: chatHistory };
        const apiKey = "AIzaSyDxctVkghoMzVFNTLbIfHmHQ_szw-omYbQ"; // API Key của bạn
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        if (isStructured) {
            // Define schema for structured output (e.g., quiz results or adjusted recipe)
            if (prompt.includes("Suggest the single best existing recipe")) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "recipeId": { "type": "STRING" },
                            "moodDescription": { "type": "STRING" }
                        },
                        "propertyOrdering": ["recipeId", "moodDescription"]
                    }
                };
            } else if (prompt.includes("adjusted settings")) {
                // Explicitly define a robust schema for adjusted recipe
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "recipe": {
                                type: "OBJECT",
                                properties: {
                                    "id": { "type": "STRING" },
                                    "name": { "type": "OBJECT", "properties": { "vi": { "type": "STRING" }, "en": { "type": "STRING" } } },
                                    "description": { "type": "OBJECT", "properties": { "vi": { "type": "STRING" }, "en": { "type": "STRING" } } },
                                    "type": { "type": "STRING" },
                                    "contrast": { "type": "STRING" },
                                    "saturation": { "type": "STRING" },
                                    "tags": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "whiteBalance": { "type": "STRING" },
                                    "settings": {
                                        "type": "OBJECT",
                                        properties: { // All possible settings keys
                                            "Black level": { "type": "STRING" },
                                            "Gamma": { "type": "STRING" },
                                            "Black Gamma": { "type": "STRING" },
                                            "Knee": { "type": "STRING" },
                                            "Color Mode": { "type": "STRING" },
                                            "Saturation": { "type": "STRING" },
                                            "Color Phase": { "type": "STRING" }
                                        },
                                        "additionalProperties": true // Allow for other properties if LLM adds them
                                    },
                                    "colorDepth": {
                                        "type": "OBJECT",
                                        properties: { // All possible color depth keys
                                            "R": { "type": "STRING" }, "G": { "type": "STRING" }, "B": { "type": "STRING" },
                                            "C": { "type": "STRING" }, "M": { "type": "STRING" }, "Y": { "type": "STRING" }
                                        },
                                        "additionalProperties": true
                                    },
                                    "detailSettings": {
                                        "type": "OBJECT",
                                        properties: {
                                            "Level": { "type": "STRING" }
                                        },
                                        "additionalProperties": true
                                    },
                                    "personalityColor": { "type": "STRING" },
                                    "coords": { "type": "OBJECT", "properties": { "x": { "type": "NUMBER" }, "y": { "type": "NUMBER" } } }
                                },
                                "required": ["id", "name", "description", "type", "contrast", "saturation", "whiteBalance", "settings", "personalityColor", "coords"] // Ensure these are always present
                            }
                        }
                    }
                };
            }
        }

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`API call failed with status ${response.status}:`, errorText);
            throw new Error(`API call failed: ${response.statusText}`);
        }

        const responseData = await response.json();
        console.log("Raw AI responseData:", responseData); // Log raw response for debugging

        if (responseData.candidates && responseData.candidates.length > 0 &&
            responseData.candidates[0].content && responseData.candidates[0].content.parts &&
            responseData.candidates[0].content.parts.length > 0) {
            const text = responseData.candidates[0].content.parts[0].text;
            if (isStructured) {
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error("AI Response JSON parsing error:", e);
                    console.error("Raw AI response text that failed parsing:", text);
                    result = null; // Explicitly null for structured parsing failure
                }
            } else {
                result = text; // Return the raw text for unstructured
            }
        } else {
            console.error("Unexpected AI response structure or empty content:", responseData);
            result = isStructured ? null : ""; // Return null for structured, empty string for unstructured
        }
    } catch (error) {
        console.error("AI API call failed in catch block:", error);
        result = isStructured ? null : ""; // Return null for structured, empty string for unstructured
    } finally {
        state.isAILoading = false;
        updateUIAfterAILoading();
        return result;
    }
}

function t(key) { return translations[key]?.[state.currentLang] || key; }

function applyTranslations() {
document.querySelectorAll('[data-translate-key]').forEach(el => {
const key = el.dataset.translateKey;
if (translations[key] && translations[key][state.currentLang]) {
if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { el.placeholder = t(key); }    
else if (el.tagName === 'OPTION') { el.textContent = t(key); }    
else { el.innerHTML = t(key); }
}
});
document.querySelectorAll('.nav-btn-mobile').forEach(btn => {
const key = 'nav' + btn.dataset.view.charAt(0).toUpperCase() + btn.dataset.view.slice(1);
btn.textContent = t(key);
});
document.getElementById('langVI').classList.toggle('active', state.currentLang === 'vi');
document.getElementById('langEN').classList.toggle('active', state.currentLang === 'en');
}

function createSettingsGrid(settings) {
if (!settings) return '';
return Object.entries(settings).map(([key, value]) => `<div class="flex flex-col"><span class="text-xs text-neutral-500">${key}</span><span class="font-semibold text-lg">${value}</span></div>`).join('');
};

function createFullRecipeHTML(recipe, isMainView = false) {
const titleClass = isMainView ? 'text-xl font-bold' : 'text-lg font-bold';
const noteHTML = (recipe.notes && recipe.notes[state.currentLang])   
? `<div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-xl">
                          <p class="font-bold" data-translate-key="noteTitle"></p>
                          <p>${recipe.notes[state.currentLang]}</p>
                        </div>` : '';

return `${noteHTML}<div class="space-y-6 mt-6">
              <div><h4 class="${titleClass} mb-2" data-translate-key="whiteBalanceTitle"></h4><div class="p-4 bg-black/5 rounded-xl"><p class="font-semibold text-lg">${recipe.whiteBalance || ''}</p></div></div>
              <div><h4 class="${titleClass} mb-2" data-translate-key="recipeSettingsTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.settings)}</div></div>
              ${recipe.colorDepth ? `<div><h4 class="${titleClass} mb-2" data-translate-key="colorDepthTitle"></h4><div class="grid grid-cols-3 sm:grid-cols-6 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.colorDepth)}</div></div>` : ''}
              ${recipe.detailSettings ? `<div><h4 class="${titleClass} mb-2" data-translate-key="detailTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.detailSettings)}</div></div>` : ''}
          </div>`;
}

function updateUIAfterAILoading() {
document.querySelectorAll('button:disabled').forEach(btn => {
if (btn.querySelector('.spinner')) {
btn.innerHTML = btn.dataset.originalText || '';
btn.disabled = false;
}
});
}

const viewTemplates = {
home: () => `<div id="homeView" class="w-full h-full flex flex-col items-center justify-center text-center absolute inset-0 view-transition p-4">
              <h1 data-translate-key="landingTitle" class="landing-title"></h1>
              <p data-translate-key="landingSubtitle" class="landing-subtitle"></p>
              <button id="startQuizBtn" class="btn btn-primary mt-10 py-4 px-10 text-lg" data-translate-key="startQuizBtn"></button>
          </div>`,

quiz: () => {
const quizHTML = quizQuestions.map(q => {
const optionsHTML = q.options.map(opt => `
                      <div class="quiz-option-card" data-value="${opt.value}">
                          ${opt.icon}
                          <span data-translate-key="${opt.key}"></span>
                      </div>`).join('');
const gridCols = q.options.length > 3 ? 'grid-cols-2 lg:grid-cols-4' : (q.options.length === 2 ? 'grid-cols-2' : 'grid-cols-1 sm:grid-cols-3');
return `
                      <div class="mb-12" data-quiz-group="${q.id}">
                          <h2 class="text-2xl font-bold text-center mb-6" data-translate-key="${q.title}"></h2>
                          <div class="grid ${gridCols} gap-4">${optionsHTML}</div>
                      </div>`;
}).join('');

return `<div id="quizView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition p-6 md:p-12">
                  <div class="max-w-4xl mx-auto">
                      ${quizHTML}
                      <div class="text-center">
                          <button id="submitQuizBtn" class="btn btn-primary py-4 px-12 text-xl" disabled>Xem kết quả</button>
                      </div>
                  </div>
              </div>`;
},

recipeFormulas: () => `
              <div id="recipeFormulasView" class="w-full h-full flex flex-col md:flex-row gap-6 absolute inset-0 view-transition">
                  <!-- Left Panel: Recipe List & Mobile Filters -->
                  <aside id="recipeListPanel" class="w-full md:w-1/3 lg:w-[30%] xl:w-1/4 glass-panel p-4 md:p-6 flex flex-col flex-shrink-0 md:flex">
                      <!-- Removed h2 title: <h2 class="text-2xl md:text-3xl font-bold" data-translate-key="sidebarTitle"></h2> -->
                      <input type="search" id="searchInput" class="w-full p-3 my-4 rounded-xl bg-gray-200/50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all" data-translate-key="searchInputPlaceholder">
                      
                      <!-- FILTERS FOR MOBILE - hidden on medium screens and up -->
                      <div class="space-y-4 text-sm mb-4 md:hidden">
                           <div><h4 class="font-semibold mb-2" data-translate-key="filterType"></h4><div class="flex gap-2" data-filter-group="type"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterTypeColor" data-filter-value="color"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterTypeBW" data-filter-value="bw"></button></div></div>
                           <div><h4 class="font-semibold mb-2" data-translate-key="filterContrast"></h4><div class="flex gap-2" data-filter-group="contrast"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                           <div><h4 class="font-semibold mb-2" data-translate-key="filterSaturation"></h4><div class="flex gap-2" data-filter-group="saturation"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                      </div>

                      <!-- The recipe list itself -->
                      <div id="recipeListContainer" class="space-y-2 md:pt-0 pt-4 border-t md:border-t-0 flex-grow overflow-y-auto pr-2 -mr-3"></div>
                      
                      <!-- Compare button at the bottom -->
                      <div id="compareBtnContainer" class="pt-4 flex-shrink-0 border-t mt-auto"></div>
                  </aside>

                  <!-- Right Panel: Details, Charts, and now Desktop Filters -->
                  <main id="recipeMainPanel" class="w-full md:w-2/3 lg:w-[70%] xl:w-3/4 flex-col min-h-0 hidden md:flex">
                      <!-- FILTERS FOR DESKTOP - hidden on small screens -->
                      <div id="filtersContainerDesktop" class="glass-panel p-4 mb-6 hidden md:flex flex-wrap items-center gap-x-6 gap-y-3 text-sm">
 <div class="flex items-center gap-3"><h4 class="font-semibold shrink-0" data-translate-key="filterType"></h4><div class="flex gap-2" data-filter-group="type"><button class="filter-btn py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterTypeColor" data-filter-value="color"></button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterTypeBW" data-filter-value="bw"></button></div></div>
 <div class="flex items-center gap-3"><h4 class="font-semibold shrink-0" data-translate-key="filterContrast"></h4><div class="flex gap-2" data-filter-group="contrast"><button class="filter-btn py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
 <div class="flex items-center gap-3"><h4 class="font-semibold shrink-0" data-translate-key="filterSaturation"></h4><div class="flex gap-2" data-filter-group="saturation"><button class="filter-btn py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                      </div>

                      <div class="glass-panel flex-grow overflow-y-auto p-6 lg:p-10">
                         <div id="chartsContainer">
                             <div class="text-center mb-10">
                                 <h2 class="text-2xl md:text-3xl font-bold text-gray-700" data-translate-key="recipeDetailWelcomeTitle"></h2><p class="text-neutral-500 mt-2 max-w-xl mx-auto" data-translate-key="recipeDetailWelcomeText"></p>
                             </div>
                             <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                 <div><h3 class="text-xl font-bold text-center mb-4" data-translate-key="colorChartTitle"></h3><div class="chart-container"><canvas id="colorChart"></canvas></div></div>
                                 <div><h3 class="text-xl font-bold text-center mb-4" data-translate-key="bwChartTitle"></h3><div class="chart-container"><canvas id="bwChart"></canvas></div></div>
                             </div>
                         </div>
                         <div id="recipeContent" class="hidden"></div>
                      </div>
                  </main>
                  <div id="recipeDetailPanelMobile" class="w-full h-full absolute inset-0 bg-[#f4f7fc] p-4 overflow-y-auto hidden">
                      <button id="backToListBtn" class="btn bg-gray-200 text-gray-800 mb-4 p-4" data-translate-key="backToListBtn"></button>
                      <div class="glass-panel p-6 overflow-y-auto">
                         <div id="recipeContentMobile"></div>
                      </div>
                  </div>
              </div>`,

featuredPhotos: () => `<div id="featuredPhotosView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition p-4">
  <div class="glass-panel p-6 md:p-12 text-center max-w-5xl mx-auto">
      <h2 class="text-2xl md:text-4xl font-bold" data-translate-key="featuredTitle"></h2>
      <p class="text-base md:text-lg text-neutral-600 mt-4 max-w-3xl mx-auto" data-translate-key="featuredCta"></p>
      <a href="https://www.facebook.com/media/set?set=oa.31406519995613930&type=3" target="_blank" rel="noopener noreferrer" class="btn btn-primary mt-8 py-3 px-8 text-base md:text-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 2L12 11M12 11L15 8M12 11L9 8"/><path d="M20 13.33V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6C4 4.89543 4.89543 4 6 4H10.67" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span data-translate-key="featuredAlbumBtn"></span>
      </a>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-10">
          ${recipesData.slice(0,6).map((recipe) => {
              const hasDemoImages = recipe.demoImages && recipe.demoImages.length > 0;
              const imgSrc = hasDemoImages ? recipe.demoImages[0] : `https://placehold.co/800x600/${recipe.personalityColor.substring(1)}/ffffff?text=${encodeURIComponent(recipe.name[state.currentLang])}`;
              return `<div class="bg-gray-200 group rounded-xl overflow-hidden cursor-pointer lightbox-trigger-thumb" data-recipe-id="${recipe.id}" data-index="0">
                    <img src="${imgSrc}" alt="Ảnh demo công thức ${recipe.name[state.currentLang]}" class="aspect-video w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300" loading="lazy">
              </div>`;
          }).join('')}
      </div>
  </div>
</div>`,

explain: () => `
          <div id="explainView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition bg-slate-50 text-gray-800">
              <div class="container mx-auto p-4 sm:p-6 md:p-12">
                  <header class="text-center mb-12 md:mb-16 pt-4 md:pt-8">
                      <h1 class="text-3xl md:text-5xl font-extrabold text-slate-800 mb-2" data-translate-key="explainHeader"></h1>
                      <h2 class="text-lg md:text-xl text-slate-600 max-w-3xl mx-auto" data-translate-key="explainSubtitle"></h2>
                  </header>
          
                  <main class="space-y-12 md:space-y-20">
                      <section>
                          <h3 class="text-2xl md:text-3xl font-bold text-center mb-8" data-translate-key="pillarsTitle"></h3>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                              <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                                  <h4 class="text-xl font-bold mb-6 text-center" data-translate-key="wbPillarTitle"></h4>
                                  <div class="mb-8">
                                      <h5 class="font-bold text-lg" data-translate-key="wbKelvinTitle"></h5>
                                      <p class="text-sm text-gray-600 mb-3" data-translate-key="wbKelvinDesc"></p>
                                      <div class="w-full h-8 rounded-full bg-gradient-to-r from-blue-400 via-white to-orange-400 flex justify-between items-center px-2 text-xs font-bold text-gray-700">
                                          <span>2500K</span>
                                          <span>5500K</span>
                                          <span>9900K</span>
                                      </div>
                                  </div>
                                  <div>
                                      <h5 class="font-bold text-lg" data-translate-key="wbShiftTitle"></h5>
                                      <p class="text-sm text-gray-600 mb-3" data-translate-key="wbShiftDesc"></p>
                                      <div id="abgm-grid-interactive-container">
                                          <div id="abgm-grid" class="relative">
                                              <span class="absolute top-1/2 -left-5 -translate-y-1/2 font-bold text-blue-600">B</span>
                                              <span class="absolute top-1/2 -right-5 -translate-y-1/2 font-bold text-amber-600">A</span>
                                              <span class="absolute left-1/2 -top-5 -translate-x-1/2 font-bold text-green-600">G</span>
                                              <span class="absolute left-1/2 -bottom-5 -translate-x-1/2 font-bold text-purple-600">M</span>
                                              <div id="abgm-pointer" style="top: 50%; left: 50%;"></div>
                                          </div>
                                          <div id="abgm-values" class="text-center mt-2 font-mono font-semibold bg-slate-100 p-2 rounded-md">A-B: 0, G-M: 0</div>
                                      </div>
                                  </div>
                              </div>
                              <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                                  <h4 class="text-xl font-bold mb-6 text-center" data-translate-key="ppPillarTitle"></h4>
                                  <p class="text-sm text-gray-700 mb-6 text-center">Picture Profile là một hệ thống menu tích hợp trong máy ảnh Sony, cung cấp một loạt các thông số cho phép người dùng điều chỉnh hình ảnh và video ngay bên trong máy ảnh trước khi chúng được xử lý và nén.<br>Các thông số này cho phép thay đổi các cài đặt liên quan đến màu sắc, độ chuyển tông, độ tương phản và độ sắc nét của hình ảnh.</p>
                                   <div class="space-y-4">
                                       <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">1. <span data-translate-key="ppItemGamma"></span></summary><p class="text-sm text-gray-600 mt-2">Gamma thiết lập độ dốc (đường cong tương phản), xác định mối quan hệ giữa mức tín hiệu đầu vào (độ sáng từ đối tượng) và mức tín hiệu đầu ra (độ sáng được tái tạo bởi máy ảnh hoặc màn hình hiển thị).<br>Hình dạng của đường cong gamma ảnh hưởng đáng kể đến đặc điểm hình ảnh, đặc biệt là ở các vùng tối và độ tương phản tổng thể. Các đường cong Cine, S-Cinetone và HLG nổi bật như những ứng cử viên chính cho các giao diện điện ảnh "tức thì", mang lại sự cân bằng giữa dải động và độ tương phản dễ chịu ngay từ máy ảnh. S-Log không dành cho việc sử dụng "tức thì", đặc biệt là trên các máy ảnh 8 bit do nhiễu và tính dễ vỡ của nó.</p></details>
                                       <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">2. <span data-translate-key="ppItemColorMode"></span></summary><p class="text-sm text-gray-600 mt-2">Color Mode xác định các đặc tính màu sắc, hoạt động kết hợp với Gamma để thiết lập màu sắc cơ bản của hình ảnh.<br>Gamma xác định đường cong độ sáng, trong khi Color Mode xác định sắc độ. Cùng với nhau, chúng thiết lập "giao diện" cơ bản của hình ảnh. Việc chọn đúng Color Mode là rất quan trọng để đạt được các tính thẩm mỹ cụ thể.</p></details>
                                       <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">3. <span data-translate-key="ppItemBlackLevel"></span></summary><p class="text-sm text-gray-600 mt-2">Chức năng Black Level điều chỉnh điểm đen, về cơ bản kiểm soát điểm tối nhất trong hình ảnh.<br>Một màu đen bị "crush" (ép xuống) có thể thêm kịch tính và độ tương phản, trong khi màu đen được "lift" (nâng lên) – thường được gọi là "màu đen mờ" hoặc "màu đen sữa" – là một đặc điểm của nhiều loại phim cổ điển và có thể tạo ra cảm giác mềm mại, thanh tao hoặc cổ điển hơn.</p></details>
                                       <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">4. <span data-translate-key="ppItemColorDepth"></span></summary><p class="text-sm text-gray-600 mt-2">Chức năng Color Depth điều chỉnh độ sáng cho từng pha màu (Đỏ, Lục, Lam, Lục lam, Tím, Vàng) riêng lẻ.<br>Không giống như Saturation toàn cầu hoặc Color Phase, Color Depth cho phép điều chỉnh độ sáng trên từng kênh, mang lại khả năng kiểm soát chính xác hơn. Thông số này cực kỳ mạnh mẽ để chỉnh màu tinh tế nhưng có tác động trực tiếp trong máy ảnh.</p></details>
                                   </div>
                              </div>
                          </div>
                      </section>
                      
                      <section class="bg-gradient-to-b from-slate-100 to-white rounded-2xl shadow-lg p-6 md:p-8">
                         <h3 class="text-2xl md:text-3xl font-bold text-center" data-translate-key="ppInfographicTitle"></h3>
                         <p class="max-w-3xl mx-auto text-center text-gray-700 mt-2 mb-10">Làm theo các bước sau để thiết lập Picture Profile từ đầu, cho phép bạn kiểm soát hoàn toàn giao diện cuối cùng của hình ảnh.</p>
                         <div class="space-y-6">
                              <div class="pp-infographic-item"><h5 data-translate-key="ppItemBlackLevel"></h5><p class="text-sm text-gray-600 mt-1">Thiết lập điểm đen (vùng tối nhất). Tăng (+) để nâng vùng tối (tạo look 'faded' hoài cổ), giảm (-) để vùng tối sâu hơn (tăng tương phản).</p></div>
                              <div class="text-center text-gray-400 font-bold">↓</div>
                              <div class="pp-infographic-item"><h5 data-translate-key="ppItemGamma"></h5><p class="text-sm text-gray-600 mt-1">Thiết lập đường cong tương phản (contrast curve). Đây là nền tảng cho 'look' của bạn. Still & Movie cho độ tương phản cao, trong khi các gamma Cine/S-Log cho dải nhạy sáng rộng hơn.</p></div>
                              <div class="text-center text-gray-400 font-bold">↓</div>
                              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemBlackGamma"></h5><p class="text-sm text-gray-600 mt-1">Tinh chỉnh đường cong tương phản ở vùng tối. 'Wide' ảnh hưởng vùng rộng hơn, 'Narrow' ảnh hưởng vùng hẹp hơn. Việc điều chỉnh Black Gamma rất cần thiết để đạt được các giao diện điện ảnh cụ thể, nơi chi tiết và kết cấu bóng tối là rất quan trọng.</p></div>
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemKnee"></h5><p class="text-sm text-gray-600 mt-1">Kiểm soát độ nén ở vùng sáng (highlight) để tránh bị 'cháy'. Chế độ tự động (Auto) hoạt động tốt, chế độ thủ công (Manual) cho phép kiểm soát chính xác hơn. Chức năng Knee là vô giá để đạt được cảnh quay "tức thì" có thể sử dụng được trong các tình huống có độ tương phản cao.</p></div>
                              </div>
                              <div class="text-center text-gray-400 font-bold">↓</div>
                              <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorMode"></h5><p class="text-sm text-gray-600 mt-1">Xác định cách màu sắc được tái tạo. Nên chọn chế độ phù hợp với Gamma đã chọn (ví dụ: Cine4 với Pro/Cinema, S-Log3 với S-Gamut3.Cine).</p></div>
                              <div class="text-center text-gray-400 font-bold">↓</div>
                              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemSaturation"></h5><p class="text-sm text-gray-600 mt-1">Điều chỉnh độ đậm/nhạt tổng thể của tất cả các màu. Độ bão hòa không chỉ là làm cho màu sắc nổi bật; nó là một công cụ mạnh mẽ để truyền tải tâm trạng và thể loại.</p></div>
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorPhase"></h5><p class="text-sm text-gray-600 mt-1">Xoay trục màu sắc tổng thể. Hữu ích để tinh chỉnh nhẹ toàn bộ tông màu mà không ảnh hưởng đến từng màu riêng lẻ. Mặc dù ít trực quan hơn cho các điều chỉnh sáng tạo chung, Color Phase là vô giá trong các sản phẩm đa máy ảnh.</p></div>
                                  <div class="pp-infographic-item"><h5 data-translate-key="ppItemDetail"></h5><p class="text-sm text-gray-600 mt-1">Kiểm soát độ sắc nét. Để có 'look' phim mềm mại, hãy giảm mạnh (ví dụ: -7). Việc đề xuất các cài đặt Detail thích hợp là rất quan trọng để đảm bảo đầu ra "tức thì" trông bóng bẩy và tự nhiên, không bị xử lý quá mức.</p></div>
                              </div>
                              <div class="text-center text-gray-400 font-bold">↓</div>
                               <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorDepth"></h5><p class="text-sm text-gray-600 mt-1">Công cụ mạnh mẽ nhất. Tăng/giảm độ sáng của từng kênh màu riêng lẻ (Đỏ, Lục, Lam, Lục lam, Tím, Vàng). Đây là một công cụ quan trọng để đạt được sự phân tách màu sắc và nhấn mạnh màu sắc có sắc thái, chuyên nghiệp.</p></div>
                         </div>
                         <div class="text-center mt-12">
                              <button id="exploreMoreBtn" class="btn btn-primary py-3 px-8 text-base md:text-lg" data-translate-key="navRecipeFormulas"></button>
                          </div>
                      </section>

                       <section class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                           <h3 class="text-2xl md:text-3xl font-bold text-center mb-4" data-translate-key="recallTitle"></h3>
                           <p class="max-w-3xl mx-auto text-center text-gray-700 mb-8">Đừng lãng phí công sức! Lưu lại các công thức của bạn vào bộ nhớ của máy ảnh để gọi ra nhanh chóng chỉ bằng một thao tác xoay nút.</p>
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                               <div class="bg-slate-100 rounded-lg p-6 text-center">
                                   <h4 class="text-xl font-bold text-slate-700 mb-2" data-translate-key="recallInternalTitle"></h4>
                                   <p class="text-sm">Lưu trực tiếp vào máy. Truy cập nhanh nhất bằng cách xoay vòng xoay chế độ. Lý tưởng cho các công thức bạn sử dụng hàng ngày.</p>
                               </div>
                               <div class="bg-slate-100 rounded-lg p-6 text-center">
                                   <h4 class="text-xl font-bold text-slate-700 mb-2" data-translate-key="recallCardTitle"></h4>
                                   <p class="text-sm">Lưu dưới dạng file trên thẻ nhớ. Cực kỳ hữu ích để sao lưu an toàn hoặc chuyển công thức sang một thân máy Sony khác.</p>
                               </div>
                           </div>
                       </section>

                       <section class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                           <h3 class="text-2xl md:text-3xl font-bold text-center mb-4" data-translate-key="exposureNoteTitle"></h3>
                           <p class="max-w-3xl mx-auto text-center text-gray-700">Hầu hết các công thức được tối ưu khi chụp ở mức phơi sáng 0EV với chế độ đo sáng 'Toàn màn hình trung bình' (Entire Screen Avg.).<br>Tuy nhiên, các công thức dựa trên S-Log có thể cần tăng phơi sáng (overexpose) để có kết quả tốt nhất. Việc phơi sáng đúng cách đảm bảo rằng máy ảnh thu được lượng ánh sáng và chi tiết tối ưu, cho phép Picture Profile phát huy tác dụng một cách hiệu quả.</p>
                       </section>
          
                  </main>
                  <footer class="text-center text-sm text-gray-500 pt-8 mt-12 border-t">
                      <p data-translate-key="footerText"></p>
                  </footer>
              </div>
          </div>`
};

function openLightbox(images, initialIndex = 0) {
if (!images || images.length === 0) return;
state.lightbox.isOpen = true;
state.lightbox.images = images;
state.lightbox.currentIndex = initialIndex;
const lightboxEl = document.getElementById('lightbox');
lightboxEl.classList.remove('hidden');
updateLightboxContent();
}

function closeLightbox() {
state.lightbox.isOpen = false;
document.getElementById('lightbox').classList.add('hidden');
}

function updateLightboxContent() {
if (!state.lightbox.isOpen) return;
const mainImageEl = document.getElementById('lightbox-main-image');
const thumbnailsContainer = document.getElementById('lightbox-thumbnails');
const newSrc = state.lightbox.images[state.lightbox.currentIndex];
mainImageEl.style.opacity = '0';
setTimeout(() => {
mainImageEl.src = newSrc;
mainImageEl.onload = () => { mainImageEl.style.opacity = '1'; };
}, 150);

thumbnailsContainer.innerHTML = state.lightbox.images.map((imgSrc, index) => `
              <img src="${imgSrc}" loading="lazy" class="lightbox-thumb w-16 h-16 md:w-20 md:h-20 object-cover rounded-md ${index === state.lightbox.currentIndex ? 'active' : ''}" data-index="${index}">
          `).join('');
}

function navigateLightbox(direction) {
if (!state.lightbox.isOpen) return;
const imageCount = state.lightbox.images.length;
let newIndex = state.lightbox.currentIndex + direction;
if (newIndex < 0) newIndex = imageCount - 1;
else if (newIndex >= imageCount) newIndex = 0;
state.lightbox.currentIndex = newIndex;
updateLightboxContent();
}

function destroyAllCharts() {
Object.values(activeCharts).forEach(chart => { if(chart && typeof chart.destroy === 'function') chart.destroy(); });
activeCharts = {};
}

function initInteractiveGrid() {
const grid = document.getElementById('abgm-grid');
const pointer = document.getElementById('abgm-pointer');
const valuesDisplay = document.getElementById('abgm-values');
if (!grid || !pointer || !valuesDisplay) return;

let isDragging = false;

function updatePosition(clientX, clientY) {
const rect = grid.getBoundingClientRect();
let x = clientX - rect.left;
let y = clientY - rect.top;

x = Math.max(0, Math.min(x, rect.width));
y = Math.max(0, Math.min(y, rect.height));

pointer.style.left = `${x}px`;
pointer.style.top = `${y}px`;

const abValue = Math.round((x / rect.width) * 18 - 9);
const gmValue = Math.round(((rect.height - y) / rect.height) * 18 - 9); 

const abLabel = abValue > 0 ? `A${abValue}` : (abValue < 0 ? `B${Math.abs(abValue)}` : '0');
const gmLabel = gmValue > 0 ? `G${gmValue}` : (gmValue < 0 ? `M${Math.abs(gmValue)}` : '0');

valuesDisplay.textContent = `${abLabel}, ${gmLabel}`;
}

grid.addEventListener('mousedown', (e) => {
isDragging = true;
updatePosition(e.clientX, e.clientY);
});

grid.addEventListener('touchstart', (e) => {
isDragging = true;
updatePosition(e.touches[0].clientX, e.touches[0].clientY);
e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
if (isDragging) updatePosition(e.clientX, e.clientY);
});

document.addEventListener('touchmove', (e) => {
if (isDragging) updatePosition(e.touches[0].clientX, e.touches[0].clientY);
});

document.addEventListener('mouseup', () => { isDragging = false; });
document.addEventListener('touchend', () => { isDragging = false; });
}


function renderView(viewName) {
return new Promise(resolve => {
const currentContent = mainContentEl.children[0];
if (currentContent) {
currentContent.classList.add('view-transition-out');
destroyAllCharts();
currentContent.addEventListener('animationend', () => {
mainContentEl.innerHTML = viewTemplates[viewName]();
attachViewEventListeners(viewName);
applyTranslations();
resolve();
}, { once: true });
} else {
mainContentEl.innerHTML = viewTemplates[viewName]();
attachViewEventListeners(viewName);
applyTranslations();
resolve();
}
});
}

function handleFilterClick(e) {
const btn = e.target.closest('.filter-btn'); if (!btn) return;
const group = btn.closest('[data-filter-group]').dataset.filterGroup;
const value = btn.dataset.filterValue; 
state.activeFilters[group] = value;

// Syncs active state across both mobile and desktop filter sets
document.querySelectorAll(`[data-filter-group="${group}"] .filter-btn`).forEach(b => {
b.classList.toggle('active', b.dataset.filterValue === value);
});

renderLibraryList();
}

function handleRecipeSelection(id, type) {
if (type === 'checkbox') {
const index = state.comparisonList.indexOf(id);
if (index > -1) { state.comparisonList.splice(index, 1); } 
else if (state.comparisonList.length < 2) { state.comparisonList.push(id); }
} else {
if (state.selectedRecipeId === id) {
state.selectedRecipeId = null;
state.isMobileDetailActive = false;
} else {
state.selectedRecipeId = id;
state.isMobileDetailActive = true;
}
state.comparisonList = [];
}
renderLibraryList();
renderLibraryDetails();

if (activeCharts.color && typeof activeCharts.color.update === 'function') { activeCharts.color.update(); }
if (activeCharts.bw && typeof activeCharts.bw.update === 'function') { activeCharts.bw.update(); }
}

async function handleAiComparison(id1, id2, recipe2Obj = null) {
const modal = document.getElementById('comparisonModal');
const titleEl = document.getElementById('comparisonModalTitle');
const contentEl = document.getElementById('comparisonModalContent');
modal.classList.remove('hidden');
titleEl.textContent = t('comparisonModalTitle');
contentEl.innerHTML = `<div class="flex items-center justify-center p-8"><div class="spinner !w-12 !h-12 !border-4"></div><p class="ml-4 text-lg font-semibold">${t('comparisonLoading')}</p></div>`;
const recipe1 = recipesData.find(r => r.id === id1);
const recipe2 = recipe2Obj ? { ...recipe2Obj, id: 'ai-adjusted', name: recipe2Obj.name } : recipesData.find(r => r.id === id2);

// Construct a detailed prompt for the LLM to generate the comparison table and analysis
const prompt = `So sánh hai công thức Sony Picture Profile sau đây. Vui lòng tạo một bảng so sánh chi tiết các thông số kỹ thuật chính (như Cân bằng trắng, Black Level, Gamma, Color Mode, Saturation, Color Phase, Color Depth, Detail Level) cho cả hai công thức. Sau bảng, hãy phân tích cảm giác tổng thể của mỗi công thức và đề xuất các trường hợp sử dụng lý tưởng cho từng công thức. Trình bày kết quả bằng định dạng Markdown.

Công thức 1:
Tên: ${recipe1.name[state.currentLang]}
Mô tả: ${recipe1.description[state.currentLang]}
Cân bằng trắng: ${recipe1.whiteBalance}
Cài đặt chính: ${JSON.stringify(recipe1.settings)}
Độ sâu màu: ${JSON.stringify(recipe1.colorDepth || {})}
Cài đặt chi tiết: ${JSON.stringify(recipe1.detailSettings || {})}

Công thức 2:
Tên: ${recipe2.name[state.currentLang]}
Mô tả: ${recipe2.description[state.currentLang]}
Cân bằng trắng: ${recipe2.whiteBalance}
Cài đặt chính: ${JSON.stringify(recipe2.settings)}
Độ sâu màu: ${JSON.stringify(recipe2.colorDepth || {})}
Cài đặt chi tiết: ${JSON.stringify(recipe2.detailSettings || {})}
`;

const comparisonText = await callAIApi(prompt, false); // Expecting Markdown, not structured JSON
contentEl.innerHTML = marked.parse(comparisonText || "Error loading comparison.");
applyTranslations();
}

async function handleAiAdjustment(button) {
const recipeId = button.dataset.recipeId;
const textarea = document.getElementById('aiTuningTextarea');
const resultContainer = document.getElementById('aiResultContainer');
if (!textarea.value || !resultContainer || state.isAILoading) return;
button.disabled = true; 
button.dataset.originalText = button.innerHTML;
button.innerHTML = `<div class="spinner"></div> ${t('aiTuningBtn')}`;

const originalRecipe = recipesData.find(r => r.id === recipeId);
// Construct a more detailed prompt for AI adjustment
const prompt = `Dựa trên công thức gốc sau đây, hãy tinh chỉnh các cài đặt theo yêu cầu của người dùng. Vui lòng trả về một đối tượng JSON mới đại diện cho công thức đã điều chỉnh. Công thức mới phải giữ nguyên cấu trúc gốc, bao gồm 'id', 'name' (thêm " (AI Tinh chỉnh)" vào tên), 'description' (mô tả mới dựa trên tinh chỉnh AI), 'type', 'contrast', 'saturation', 'tags', 'whiteBalance', 'settings', 'colorDepth', và 'detailSettings'. Chỉ điều chỉnh các giá trị trong 'settings', 'colorDepth', 'detailSettings' và 'whiteBalance' dựa trên yêu cầu.

Công thức gốc: ${JSON.stringify(originalRecipe)}
Yêu cầu của người dùng: "${textarea.value}"

Ví dụ cấu trúc JSON mong đợi:
{
  "recipe": {
    "id": "scl-001-ai",
    "name": {"vi": "Mojave Sun (AI Tinh chỉnh)", "en": "Mojave Sun (AI Adjusted)"},
    "description": {"vi": "Mô tả mới dựa trên tinh chỉnh AI.", "en": "New description based on AI adjustment."},
    "type": "color",
    "contrast": "normal",
    "saturation": "normal",
    "tags": ["nostalgic", "sun-drenched", "warm", "travel", "lifestyle", "summer", "golden-hour"],
    "whiteBalance": "5500K, A6-M1",
    "settings": { "Black level": "0", "Gamma": "Movie", "Black Gamma": "Wide +7", "Knee": "Manual 75% +4", "Color Mode": "S-Gamut3", "Saturation": "+32", "Color Phase": "+6" },
    "colorDepth": { "R": "-2", "G": "0", "B": "+5", "C": "+5", "M": "0", "Y": "+4" },
    "detailSettings": { "Level": "0" },
    "personalityColor": "#FFD700",
    "coords": { "x": 6, "y": 7 }
  }
}
Đảm bảo tất cả các trường gốc đều có mặt và chỉ các điều chỉnh được yêu cầu mới được thực hiện cho các cài đặt liên quan.
`;
const aiResponse = await callAIApi(prompt, true); // Expecting structured JSON

    // Start with a deep copy of the original recipe
    let adjustedRecipe = JSON.parse(JSON.stringify(originalRecipe));
    adjustedRecipe.id = `${originalRecipe.id}-ai`;
    adjustedRecipe.name = { vi: `${originalRecipe.name.vi} (AI Tinh chỉnh)`, en: `${originalRecipe.name.en} (AI Adjusted)` };
    adjustedRecipe.description = { vi: `Đã tinh chỉnh theo yêu cầu: "${textarea.value}"`, en: `Adjusted based on request: "${textarea.value}"` };

    const userRequestLower = textarea.value.toLowerCase();

    // Apply keyword-based adjustments first (robust fallback)
    if (userRequestLower.includes('ấm hơn') || userRequestLower.includes('warmer')) {
        adjustedRecipe.whiteBalance = "5500K, A6-M1";
        if (adjustedRecipe.colorDepth) adjustedRecipe.colorDepth.R = String(Math.min(7, parseInt(adjustedRecipe.colorDepth.R || 0) + 2));
        if (adjustedRecipe.colorDepth) adjustedRecipe.colorDepth.Y = String(Math.min(7, parseInt(adjustedRecipe.colorDepth.Y || 0) + 2));
    }
    if (userRequestLower.includes('mát hơn') || userRequestLower.includes('cooler')) {
        adjustedRecipe.whiteBalance = "2500K, B6-M1";
        if (adjustedRecipe.colorDepth) adjustedRecipe.colorDepth.B = String(Math.min(7, parseInt(adjustedRecipe.colorDepth.B || 0) + 2));
        if (adjustedRecipe.colorDepth) adjustedRecipe.colorDepth.C = String(Math.min(7, parseInt(adjustedRecipe.colorDepth.C || 0) + 2));
    }
    if (userRequestLower.includes('tăng tương phản') || userRequestLower.includes('more contrast') || userRequestLower.includes('punchy')) {
        if (adjustedRecipe.settings) adjustedRecipe.settings.Gamma = 'Still';
        if (adjustedRecipe.settings) adjustedRecipe.settings['Black level'] = String(Math.max(-15, parseInt(adjustedRecipe.settings['Black level'] || 0) - 5));
        adjustedRecipe.contrast = 'high';
    }
    if (userRequestLower.includes('giảm tương phản') || userRequestLower.includes('less contrast') || userRequestLower.includes('soft')) {
        if (adjustedRecipe.settings) adjustedRecipe.settings.Gamma = 'Cine4';
        if (adjustedRecipe.settings) adjustedRecipe.settings['Black level'] = String(Math.min(7, parseInt(adjustedRecipe.settings['Black level'] || 0) + 5));
        adjustedRecipe.contrast = 'low';
    }
    if (userRequestLower.includes('tươi hơn') || userRequestLower.includes('more vibrant') || userRequestLower.includes('tăng bão hòa')) {
        if (adjustedRecipe.settings) adjustedRecipe.settings.Saturation = String(Math.min(32, parseInt(adjustedRecipe.settings.Saturation || 0) + 10));
        adjustedRecipe.saturation = 'high';
    }
    if (userRequestLower.includes('nhạt hơn') || userRequestLower.includes('less saturated') || userRequestLower.includes('giảm bão hòa')) {
        if (adjustedRecipe.settings) adjustedRecipe.settings.Saturation = String(Math.max(-7, parseInt(adjustedRecipe.settings.Saturation || 0) - 10));
        adjustedRecipe.saturation = 'low';
    }
    if (userRequestLower.includes('sắc nét hơn') || userRequestLower.includes('sharper')) {
        if (adjustedRecipe.detailSettings) adjustedRecipe.detailSettings.Level = String(Math.min(7, parseInt(adjustedRecipe.detailSettings.Level || 0) + 3));
    }
    if (userRequestLower.includes('mềm mại hơn') || userRequestLower.includes('softer') || userRequestLower.includes('giảm chi tiết')) {
        if (adjustedRecipe.detailSettings) adjustedRecipe.detailSettings.Level = String(Math.max(-7, parseInt(adjustedRecipe.detailSettings.Level || 0) - 3));
    }

    // Attempt to merge AI's suggested changes if available and valid
    if (aiResponse && aiResponse.recipe) {
        const aiRecipe = aiResponse.recipe;
        // Overwrite with AI's values if they are present and valid
        if (aiRecipe.whiteBalance !== undefined) adjustedRecipe.whiteBalance = aiRecipe.whiteBalance;
        if (aiRecipe.settings) {
            for (const key in aiRecipe.settings) {
                if (aiRecipe.settings.hasOwnProperty(key)) {
                    adjustedRecipe.settings[key] = aiRecipe.settings[key];
                }
            }
        }
        if (aiRecipe.colorDepth) {
            for (const key in aiRecipe.colorDepth) {
                if (aiRecipe.colorDepth.hasOwnProperty(key)) {
                    adjustedRecipe.colorDepth[key] = aiRecipe.colorDepth[key];
                }
            }
        }
        if (aiRecipe.detailSettings) {
            for (const key in aiRecipe.detailSettings) {
                if (aiRecipe.detailSettings.hasOwnProperty(key)) {
                    adjustedRecipe.detailSettings[key] = aiRecipe.detailSettings[key];
                }
            }
        }
        // Also update descriptive fields if AI provided them (e.g., name, description, tags, contrast, saturation)
        if (aiRecipe.name) adjustedRecipe.name = aiRecipe.name;
        if (aiRecipe.description) adjustedRecipe.description = aiRecipe.description;
        if (aiRecipe.type) adjustedRecipe.type = aiRecipe.type;
        if (aiRecipe.contrast) adjustedRecipe.contrast = aiRecipe.contrast;
        if (aiRecipe.saturation) adjustedRecipe.saturation = aiRecipe.saturation;
        if (aiRecipe.tags) adjustedRecipe.tags = aiRecipe.tags;
        if (aiRecipe.personalityColor) adjustedRecipe.personalityColor = aiRecipe.personalityColor;
        if (aiRecipe.coords) adjustedRecipe.coords = aiRecipe.coords;

    } else {
        console.warn("AI did not return a valid structured recipe. Proceeding with keyword-based adjustments only.");
        // No need to set resultContainer.innerHTML here, as it's done below with adjustedRecipe
    }

    state.lastGeneratedAiRecipe = adjustedRecipe; // Use the locally adjusted recipe
    resultContainer.innerHTML = `<div class="mt-6 border-t border-gray-200/50 pt-6"><h4 class="font-bold text-lg mb-2">${state.lastGeneratedAiRecipe.name[state.currentLang]}</h4><div class="p-4 rounded-xl bg-blue-50">${createFullRecipeHTML(state.lastGeneratedAiRecipe, false)}</div><button id="compareWithOriginalBtn" data-original-id="${recipeId}" class="btn btn-secondary w-full mt-4 py-3 bg-gray-200 text-black" data-translate-key="compareWithOriginalBtn"></button></div>`;

button.disabled = false; button.innerHTML = button.dataset.originalText; applyTranslations();
}

async function handleAiRecipeExplanation(button) {
    const recipeId = button.dataset.recipeId;
    const explanationContainer = document.getElementById('aiExplanationContainer');
    if (!explanationContainer || state.isAILoading) return;

    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = `<div class="spinner"></div> ${t('aiExplainRecipeBtn')}`;
    explanationContainer.innerHTML = `<div class="flex items-center justify-center p-4"><div class="spinner"></div><p class="ml-2 text-base font-semibold">${t('aiExplanationLoading')}</p></div>`;
    explanationContainer.classList.remove('hidden');

    const recipe = recipesData.find(r => r.id === recipeId);
    if (!recipe) {
        explanationContainer.innerHTML = `<p class="text-red-500">Error: Recipe not found.</p>`;
        button.disabled = false;
        button.innerHTML = button.dataset.originalText;
        return;
    }

    // This prompt is now for the mock API, it will return a predefined string
    const prompt = `Giải thích các đặc điểm và ý đồ nghệ thuật của công thức Sony Picture Profile sau một cách súc tích, dễ hiểu, tập trung vào cách Cân bằng trắng, Gamma, Mức độ đen, Chế độ màu, Độ bão hòa, Độ sâu màu và cài đặt Chi tiết của nó đóng góp vào giao diện và cảm nhận tổng thể. Đồng thời, gợi ý các tình huống chụp ảnh lý tưởng cho công thức này.
    Tên công thức: ${recipe.name[state.currentLang]}
    Mô tả: ${recipe.description[state.currentLang]}
    Cân bằng trắng: ${recipe.whiteBalance}
    Cài đặt chính: ${JSON.stringify(recipe.settings)}
    Độ sâu màu: ${JSON.stringify(recipe.colorDepth || {})}
    Cài đặt chi tiết: ${JSON.stringify(recipe.detailSettings || {})}
    `;

    const aiResponse = await callAIApi(prompt, false); // Expecting plain text/markdown from mock

    if (aiResponse) {
        explanationContainer.innerHTML = `<div class="mt-4 p-4 rounded-xl bg-blue-50">
            <h4 class="font-bold text-lg mb-2" data-translate-key="aiExplanationTitle"></h4>
            <div class="prose max-w-none text-gray-700">${marked.parse(aiResponse)}</div>
        </div>`;
    } else {
        explanationContainer.innerHTML = `<p class="text-red-500">Lỗi khi tạo giải thích bằng AI. Vui lòng thử lại.</p>`;
    }

    button.disabled = false;
    button.innerHTML = button.dataset.originalText;
    applyTranslations();
}


async function handleQuizSubmit() {
    const selectedTags = Object.values(state.quizAnswers);
    await renderView('home');
    const homeView = document.getElementById('homeView');
    if (!homeView) { console.error("Quiz Submit Error: homeView not found after render."); return; }
    homeView.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="spinner !w-16 !h-16 !border-4"></div><h2 class="landing-title mt-8" data-translate-key="loadingAnalyze"></h2></div>`;
    applyTranslations();

    let recommendedRecipe = null;

    try {
        // Step 1: Try to get a recommendation from Gemini API
        const prompt = `Based on the user's quiz answers (tags): ${JSON.stringify(selectedTags)}.
        From the following list of available recipes, suggest the single best recipe that matches these tags.
        Available recipes: ${JSON.stringify(recipesData.map(r => ({ id: r.id, name: r.name[state.currentLang], tags: r.tags })))}
        Provide the output as a JSON object, with 'recipeId' (the 'id' of the recipe) and 'moodDescription' (the recipe's description in the current language).
        Example:
        {"recipeId": "scl-001", "moodDescription": "A nostalgic, sun-drenched style..."}
        `;

        const aiResponse = await callAIApi(prompt, true, 0); // Set delay to 0 for quick response
        console.log("AI Response for quiz:", aiResponse); // Log the AI response for debugging

        if (aiResponse && aiResponse.recipeId) {
            recommendedRecipe = recipesData.find(r => r.id === aiResponse.recipeId);
            if (!recommendedRecipe) {
                console.warn(`AI recommended recipe ID '${aiResponse.recipeId}' not found in local data. Falling back to local scoring.`);
            }
        } else {
            console.warn("AI response invalid or missing recipeId. Falling back to local scoring.");
        }

    } catch (error) {
        console.error("Error calling AI for quiz, falling back to local scoring:", error);
    }

    // Step 2: Fallback to local scoring if AI recommendation failed or was invalid
    if (!recommendedRecipe) {
        let maxScore = -1;
        let bestLocalRecipe = null;

        recipesData.forEach(recipe => {
            let score = 0;
            selectedTags.forEach(tag => {
                if (recipe.tags.includes(tag)) {
                    score++;
                }
            });
            // Give extra weight to type match
            if (selectedTags.includes(recipe.type)) {
                score += 5;
            }

            if (score > maxScore) {
                maxScore = score;
                bestLocalRecipe = recipe;
            }
        });

        if (bestLocalRecipe) {
            recommendedRecipe = bestLocalRecipe;
            console.log("Using local scoring fallback. Recommended recipe:", recommendedRecipe.id);
        } else {
            // Ultimate fallback if no local recipe matches at all (highly unlikely)
            recommendedRecipe = recipesData[0];
            console.warn("No suitable recipe found via AI or local scoring. Defaulting to first recipe:", recommendedRecipe.id);
        }
    }

    // Step 3: Navigate to the recommended recipe's detail page
    if (recommendedRecipe) {
        state.selectedRecipeId = recommendedRecipe.id;
        state.isMobileDetailActive = true;
        await renderView('recipeFormulas'); // Directly navigate to recipe details
    } else {
        // This case should ideally not be reached with the fallbacks in place
        homeView.innerHTML = `<p class="text-red-500">Lỗi không mong unexpected: Không thể tìm thấy công thức phù hợp. Vui lòng thử lại.</p>`;
    }
}

function attachViewEventListeners(viewName) {
if (viewName === 'recipeFormulas') {
renderLibraryList();  
renderLibraryDetails();
renderInteractiveCharts(state.currentLang);
} else if (viewName === 'explain') {
initInteractiveGrid();
} else if (viewName === 'quiz') {
const quizView = document.getElementById('quizView');
quizView.addEventListener('click', (e) => {
const card = e.target.closest('.quiz-option-card');
if (!card) return;

const group = card.closest('[data-quiz-group]').dataset.quizGroup;
const value = card.dataset.value;

// Update state
state.quizAnswers[group] = value;

// Update UI
document.querySelectorAll(`[data-quiz-group="${group}"] .quiz-option-card`).forEach(c => c.classList.remove('selected'));
card.classList.add('selected');

// Animation
card.classList.remove('bouncing'); // reset animation
void card.offsetWidth; // trigger reflow
card.classList.add('bouncing');

// Check if all questions are answered
const allAnswered = quizQuestions.every(q => state.quizAnswers[q.id]);
document.getElementById('submitQuizBtn').disabled = !allAnswered;
});
document.getElementById('submitQuizBtn').addEventListener('click', handleQuizSubmit);
}
}

function renderLibraryList() {
const container = document.getElementById('recipeListContainer'); if (!container) return;
const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
let recipesToRender = recipesData.filter(recipe => {
    const nameMatch = recipe.name[state.currentLang].toLowerCase().includes(searchTerm);
    const descriptionMatch = recipe.description[state.currentLang].toLowerCase().includes(searchTerm);
    const typeMatch = state.activeFilters.type === 'all' || recipe.type === state.activeFilters.type;
    const contrastMatch = state.activeFilters.contrast === 'all' || recipe.contrast === state.activeFilters.contrast;
    const saturationMatch = state.activeFilters.saturation === 'all' || recipe.saturation === state.activeFilters.saturation;
    return (nameMatch || descriptionMatch) && typeMatch && contrastMatch && saturationMatch;
});

container.innerHTML = recipesToRender.map(recipe => {
const isChecked = state.comparisonList.includes(recipe.id);
const isSelected = recipe.id === state.selectedRecipeId;

return `<div class="recipe-item p-3 rounded-xl transition-all duration-200 border-l-4 border-transparent flex items-start gap-4 ${isSelected ? 'selected' : ''}">
                          <input type="checkbox" class="recipe-compare-cb form-checkbox h-5 w-5 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 self-start mt-1 flex-shrink-0" data-recipe-id="${recipe.id}" ${isChecked ? 'checked' : ''} ${state.comparisonList.length >= 2 && !isChecked ? 'disabled' : ''}>
                           <div class="flex-grow cursor-pointer recipe-item-content" data-recipe-id="${recipe.id}">
                               <div class="flex items-start gap-3">
                                     <div class="recipe-dot w-5 h-5 rounded-full flex-shrink-0 mt-1" style="background-color: ${recipe.personalityColor}" title="${recipe.name[state.currentLang]}"></div>
                                   <div class="flex-grow">
                                         <span class="font-semibold text-primary">${recipe.name[state.currentLang]}</span>
                                       <p class="text-sm text-neutral-600 mt-1 leading-snug">${recipe.description[state.currentLang]}</p>
                                   </div>
                               </div>
                           </div>
                      </div>`;
}).join('');

const btnContainer = document.getElementById('compareBtnContainer');
btnContainer.innerHTML = `<button id="compareBtn" class="btn btn-primary w-full mt-4 py-3" data-translate-key="compareBtn" ${state.comparisonList.length !== 2 ? 'disabled' : ''}></button>`;
applyTranslations();
}

function renderLibraryDetails() {
const isMobile = window.innerWidth < 768;
const recipeListPanel = document.getElementById('recipeListPanel');
const recipeMainPanel = document.getElementById('recipeMainPanel');
const recipeDetailPanelMobile = document.getElementById('recipeDetailPanelMobile');

if (isMobile) {
if(state.isMobileDetailActive) {
recipeListPanel.classList.add('hidden');
recipeDetailPanelMobile.classList.remove('hidden');
} else {
recipeListPanel.classList.remove('hidden');
recipeDetailPanelMobile.classList.add('hidden');
}
} else {
recipeListPanel?.classList.remove('hidden');
recipeDetailPanelMobile?.classList.add('hidden');
}

const recipe = recipesData.find(r => r.id === state.selectedRecipeId);

let recipeContentContainer, chartsContainer;
if (isMobile && state.isMobileDetailActive) {
recipeContentContainer = document.getElementById('recipeContentMobile');
chartsContainer = null;
} else {
recipeContentContainer = document.getElementById('recipeContent');
chartsContainer = document.getElementById('chartsContainer');
}

if (!recipeContentContainer) return;

if (!recipe) {  
if (chartsContainer) chartsContainer.classList.remove('hidden');
recipeContentContainer.classList.add('hidden');
if(!isMobile) recipeMainPanel?.classList.remove('hidden');
return;   
}
if (chartsContainer) chartsContainer.classList.add('hidden');
recipeContentContainer.classList.remove('hidden');
if(!isMobile) recipeMainPanel?.classList.remove('hidden');

let thumbnailsHTML = '';
const images = recipe.demoImages || [];
let imageElements = [];
images.forEach((imgSrc, index) => {
imageElements.push(`<div class="bg-gray-200 group rounded-xl overflow-hidden cursor-pointer lightbox-trigger-thumb" data-recipe-id="${recipe.id}" data-index="${index}"><img src="${imgSrc}" loading="lazy" alt="Ảnh demo ${recipe.name[state.currentLang]} ${index + 1}" class="aspect-[4/3] w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300"></div>`);
});
const placeholdersNeeded = 3 - imageElements.length;
const placeholderColor = recipe.personalityColor ? recipe.personalityColor.substring(1) : 'cccccc';
for (let i = 0; i < placeholdersNeeded; i++) {
const placeholderIndex = images.length + i;
imageElements.push(`<div class="bg-gray-200 group rounded-xl overflow-hidden"><img src="https://placehold.co/400x300/${placeholderColor}/ffffff?text=${encodeURIComponent(recipe.name[state.currentLang])}+Sample+${placeholderIndex + 1}" loading="lazy" alt="Ảnh minh họa ${recipe.name[state.currentLang]} ${placeholderIndex + 1}" class="aspect-[4/3] w-full h-full object-cover"></div>`);
}
thumbnailsHTML = `<div class="my-6"><div class="grid grid-cols-3 gap-2 md:gap-4">${imageElements.join('')}</div></div>`;

const exportSectionHTML = `
              <div class="mt-12 pt-8 border-t-2 border-gray-200/60">
                  <h3 class="text-xl md:text-2xl font-bold mb-4" data-translate-key="exportRecipeBtn"></h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <button id="downloadLutBtn" data-recipe-id="${recipe.id}" class="btn bg-blue-100 text-blue-800 hover:bg-blue-200 w-full py-3">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                          <span data-translate-key="downloadLutBtn"></span>
                      </button>
                      <button id="memoryRecallGuideBtn" class="btn bg-gray-200 text-gray-800 hover:bg-gray-300 w-full py-3">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                         <span data-translate-key="memoryRecallBtn"></span>
                      </button>
                  </div>
              </div>
          `;

recipeContentContainer.innerHTML = `
                <h3 class="text-3xl md:text-4xl font-bold">${recipe.name[state.currentLang]}</h3>
              <p class="text-lg text-neutral-600 mt-2 italic">"${recipe.description[state.currentLang]}"</p>
              ${thumbnailsHTML}
              ${exportSectionHTML}
              <div id="originalRecipeContainer" class="mt-8">${createFullRecipeHTML(recipe, true)}</div>
              <div class="mt-8 pt-8 border-t-2 border-gray-200/60">
                  <button id="aiExplainRecipeBtn" data-recipe-id="${recipe.id}" class="btn btn-primary w-full py-3" data-translate-key="aiExplainRecipeBtn"></button>
                  <div id="aiExplanationContainer" class="mt-4 hidden"></div>
              </div>
              <div id="setupGuideSection" class="mt-12 pt-8 border-t-2 border-gray-200/60">
                  <details open class="group">
                      <summary class="text-xl md:text-2xl font-bold cursor-pointer list-none flex justify-between items-center group-hover:text-blue-600 transition-colors">
                          <span data-translate-key="tutorialTitle"></span>
                          <svg class="w-6 h-6 transition-transform transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                      </summary>
                      <div class="prose max-w-none mt-6 space-y-4 text-base text-gray-700">
                          <div><h4 class="font-bold" data-translate-key="tutorialStep1Title"></h4><p data-translate-key="tutorialStep1P1"></p><p data-translate-key="tutorialStep1P2"></p></div>
                          <div><h4 class="font-bold" data-translate-key="tutorialStep2Title"></h4><p data-translate-key="tutorialStep2P1"></p></div>
                          <div><h4 class="font-bold" data-translate-key="tutorialStep3Title"></h4><p data-translate-key="tutorialStep3P1"></p></div>
                          <div><h4 class="font-bold" data-translate-key="tutorialStep4Title"></h4><p data-translate-key="tutorialStep4P1"></p></div>
                      </div>
                  </details>
              </div>
              <div class="mt-12 pt-8 border-t-2 border-gray-200/60">
                  <h3 class="text-xl md:text-2xl font-bold mb-4" data-translate-key="aiTuningTitle"></h3>
                  <div class="glass-panel p-4 md:p-6 -mx-2">
                      <textarea id="aiTuningTextarea" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 transition-shadow" rows="3" data-translate-key="aiTuningPlaceholder"></textarea>
                      <button id="aiTuningBtn" data-recipe-id="${recipe.id}" class="btn btn-primary w-full mt-4 py-3" data-translate-key="aiTuningBtn"></button>
                      <div id="aiResultContainer"></div>
                  </div>
              </div>`;
applyTranslations();
}

function renderInteractiveCharts(lang) {
destroyAllCharts();
const chartDefaultOptions = (yAxisTitleKey) => ({
responsive: true,
maintainAspectRatio: false,
onClick: (e) => {
const chart = e.chart;
const elements = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
if (elements.length) {
const firstPoint = elements[0];
const recipeId = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index].id;
if (recipeId) { handleRecipeSelection(recipeId, 'chart'); }
}
},
plugins: {
legend: { display: false },
tooltip: {
backgroundColor: 'rgba(0,0,0,0.8)',
titleFont: { size: 14 },
bodyFont: { size: 13 },
padding: 10,
callbacks: { label: function(context) { return context.raw.name; } }
}
},
scales: {
x: { min: -10, max: 10, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false }, border: { dash: [4, 4] }, title: { display: true, text: t(yAxisTitleKey) } },
y: { min: -10, max: 10, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false }, border: { dash: [4, 4] }, title: { display: true, text: t(yAxisTitleKey) } }
}
});

const colorCtx = document.getElementById('colorChart')?.getContext('2d');
if (colorCtx) {
const colorData = recipesData.filter(r => r.type === 'color' && r.coords && typeof r.coords.x === 'number' && typeof r.coords.y === 'number' && r.personalityColor).map(r => ({ ...r.coords, id: r.id, name: r.name[lang] }));
activeCharts.color = new Chart(colorCtx, {
type: 'scatter',
data: {
datasets: [{
data: colorData,
pointBackgroundColor: colorData.map(d => {
const recipe = recipesData.find(r => r.id === d.id);
return recipe ? recipe.personalityColor : '#CCCCCC';
}),
pointBorderColor: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? '#007AFF' : 'rgba(255, 255, 255, 0.8)'),
pointBorderWidth: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 4 : 2),
pointRadius: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 11 : 7),
pointHoverRadius: 11
}]
},
options: chartDefaultOptions('axisSaturation')
});
}

const bwCtx = document.getElementById('bwChart')?.getContext('2d');
if (bwCtx) {
const bwData = recipesData.filter(r => r.type === 'bw' && r.coords && typeof r.coords.x === 'number' && typeof r.coords.y === 'number').map(r => ({ ...r.coords, id: r.id, name: r.name[lang] }));
activeCharts.bw = new Chart(bwCtx, {
type: 'scatter',
data: {
datasets: [{
data: bwData,
pointBackgroundColor: '#475569',
pointBorderColor: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? '#007AFF' : 'rgba(255, 255, 255, 0.8)'),
pointBorderWidth: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 4 : 2),
pointRadius: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 11 : 7),
pointHoverRadius: 11,
pointHoverBorderWidth: 3
}]
},
options: chartDefaultOptions('axisChroma')
});
}
}

function toggleMobileNav(show) {
const menu = document.getElementById('mobileNavMenu');
menu.classList.toggle('translate-x-full', !show);
}

function handleDropdownNav() {
const container = document.getElementById('pp-dropdown-container');
const btn = document.getElementById('pp-dropdown-btn');
const menu = document.getElementById('pp-dropdown-menu');
const chevron = document.getElementById('pp-dropdown-chevron');

if (!container || !btn || !menu) return;

btn.addEventListener('click', (e) => {
e.stopPropagation();
const isHidden = menu.classList.contains('hidden');
if (isHidden) {
menu.classList.remove('hidden');
setTimeout(() => {
menu.classList.remove('opacity-0', 'scale-95');
chevron.style.transform = 'rotate(180deg)';
}, 10);
} else {
menu.classList.add('opacity-0', 'scale-95');
chevron.style.transform = 'rotate(0deg)';
menu.addEventListener('transitionend', () => {
menu.classList.add('hidden');
}, { once: true });
}
});

document.addEventListener('click', (e) => {
if (!container.contains(e.target)) {
menu.classList.add('opacity-0', 'scale-95');
chevron.style.transform = 'rotate(0deg)';
if (!menu.classList.contains('hidden')) {
menu.addEventListener('transitionend', () => {
menu.classList.add('hidden');
}, { once: true });
}
}
});
}

// Cookie helper functions
function setCookie(name, value, days) {
let expires = "";
if (days) {
const date = new Date();
date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
expires = "; expires=" + date.toUTCString();
}
document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

function getCookie(name) {
const nameEQ = name + "=";
const ca = document.cookie.split(';');
for(let i = 0; i < ca.length; i++) {
let c = ca[i];
while (c.charAt(0) == ' ') c = c.substring(1, c.length);
if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
}
return null;
}

function init() {
document.body.addEventListener('click', async (e) => {
const target = e.target;

if (state.lightbox.isOpen) {
if (target.id === 'lightbox-bg' || target.closest('#lightbox-close')) { closeLightbox(); } 
else if (target.closest('#lightbox-next')) { navigateLightbox(1); } 
else if (target.closest('#lightbox-prev')) { navigateLightbox(-1); }
const thumb = target.closest('.lightbox-thumb');
if (thumb) {
state.lightbox.currentIndex = parseInt(thumb.dataset.index);
updateLightboxContent();
}
return; 
}

const lightboxTrigger = target.closest('.lightbox-trigger-thumb');
const homeBtn = target.closest('#homeBtn');
const navBtn = target.closest('.nav-btn'); 
const mobileNavBtn = target.closest('.nav-btn-mobile');
const langBtn = target.closest('.lang-btn');
const startQuizBtn = target.closest('#startQuizBtn');
const exploreMoreBtn = target.closest('#exploreMoreBtn');
const hamburgerBtn = target.closest('#hamburgerBtn');
const closeMobileNavBtn = target.closest('#closeMobileNavBtn');

if (hamburgerBtn) { toggleMobileNav(true); return; }
if (closeMobileNavBtn || (target.id === 'mobileNavMenu' && !target.closest('#mobileNavMenu > div'))) { toggleMobileNav(false); return; }
if (mobileNavBtn) {
toggleMobileNav(false);
state.selectedRecipeId = null; state.isMobileDetailActive = false;
await renderView(mobileNavBtn.dataset.view); return;
}
if (homeBtn) { state.selectedRecipeId = null; state.isMobileDetailActive = false; await renderView('home'); return; }
if (navBtn) { 
const dropdownMenu = document.getElementById('pp-dropdown-menu');
if (dropdownMenu && !dropdownMenu.classList.contains('hidden')) {
dropdownMenu.classList.add('opacity-0', 'scale-95', 'hidden');
document.getElementById('pp-dropdown-chevron').style.transform = 'rotate(0deg)';
}
state.selectedRecipeId = null; 
state.isMobileDetailActive = false; 
await renderView(navBtn.dataset.view); 
return; 
}
if (exploreMoreBtn) { state.selectedRecipeId = null; state.isMobileDetailActive = false; await renderView('recipeFormulas'); return; }
if (langBtn) { state.currentLang = langBtn.id.replace('lang', '').toLowerCase(); await renderView(state.currentView); return; }

if (startQuizBtn) { 
state.quizStep = 0; 
state.quizAnswers = {}; 
await renderView('quiz'); 
return; 
}

const recipeItemContent = target.closest('.recipe-item-content');
const recipeDot = target.closest('.recipe-dot');
const recipeCompareCb = target.closest('.recipe-compare-cb');
const compareBtn = target.closest('#compareBtn');
const compareWithOriginalBtn = target.closest('#compareWithOriginalBtn');
const aiTuningBtn = target.closest('#aiTuningBtn');
const aiExplainRecipeBtn = target.closest('#aiExplainRecipeBtn'); // New button
const backToListBtn = target.closest('#backToListBtn');
const closeModalBtn = target.closest('#closeComparisonModalBtn');
const downloadLutBtn = target.closest('#downloadLutBtn');
const memoryRecallGuideBtn = target.closest('#memoryRecallGuideBtn');

if (recipeItemContent || recipeDot) { handleRecipeSelection(target.closest('[data-recipe-id]').dataset.recipeId, 'div'); return; }
if (recipeCompareCb) { handleRecipeSelection(recipeCompareCb.dataset.recipeId, 'checkbox'); return; }
if (compareBtn && !compareBtn.disabled) { handleAiComparison(state.comparisonList[0], state.comparisonList[1]); return; }
if (compareWithOriginalBtn) { handleAiComparison(compareWithOriginalBtn.dataset.originalId, null, state.lastGeneratedAiRecipe); return; }
if (aiTuningBtn) { handleAiAdjustment(aiTuningBtn); return; }
if (aiExplainRecipeBtn) { handleAiRecipeExplanation(aiExplainRecipeBtn); return; } // New event listener
if (backToListBtn) { state.isMobileDetailActive = false; renderLibraryDetails(); return; }
if (closeModalBtn) { document.getElementById('comparisonModal').classList.add('hidden'); return; }
if (lightboxTrigger) {
const recipeId = lightboxTrigger.dataset.recipeId;
const recipe = recipesData.find(r => r.id === recipeId);
if (recipe && recipe.demoImages && recipe.demoImages.length > 0) {
openLightbox(recipe.demoImages, parseInt(lightboxTrigger.dataset.index));
}
return;
}
if (downloadLutBtn) {
const recipe = recipesData.find(r => r.id === downloadLutBtn.dataset.recipeId);
if (recipe) {
const lutContent = `# Generated by Alpha AI Color Lab for ${recipe.name[state.currentLang]}\nTITLE "${recipe.name[state.currentLang]}"\nLUT_3D_SIZE 33\n# Dummy LUT data\n0.0 0.0 0.0\n1.0 1.0 1.0`;
const blob = new Blob([lutContent], { type: 'text/plain' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `${recipe.id}.cube`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}
return;
}
if (memoryRecallGuideBtn) {
document.getElementById('setupGuideSection')?.scrollIntoView({ behavior: 'smooth' });
return;
}


if (document.getElementById('filtersContainer')?.contains(target) || document.getElementById('filtersContainerDesktop')?.contains(target)) { 
handleFilterClick(e); return; 
}
});

document.body.addEventListener('input', (e) => {
if (e.target.id === 'searchInput') {
renderLibraryList();
}
});

window.addEventListener('resize', () => { if(state.currentView === 'recipeFormulas') renderLibraryDetails(); });

// Welcome Modal Logic
const welcomeModal = document.getElementById('welcomeModal');
const closeWelcomeBtn = document.getElementById('closeWelcomeModalBtn');
if (!getCookie('welcomeLetterSeen')) {
welcomeModal.classList.remove('hidden');
welcomeModal.classList.add('flex');
}
closeWelcomeBtn.addEventListener('click', () => {
welcomeModal.classList.add('hidden');
welcomeModal.classList.remove('flex');
setCookie('welcomeLetterSeen', 'true', 365); // Set cookie for 1 year
});

renderView('home');
handleDropdownNav();
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
